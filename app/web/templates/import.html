{% extends "base.html" %}

{% block title %}Import Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <h1 class="text-3xl font-bold text-gray-900">Import Trades</h1>

    <!-- Robinhood Auto-Import -->
    <div class="card border-2 border-green-200 bg-green-50">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-green-800">ü§ñ Robinhood Auto-Import</h2>
            <span id="rh-status" class="text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-600">Not Connected</span>
        </div>
        
        <div id="rh-login-form">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-blue-800">
                    <strong>üì± How it works:</strong> After clicking Connect, check your <strong>Robinhood app</strong> 
                    to approve the login. No MFA code needed if you use app approval.
                </p>
            </div>
            
            <div class="space-y-3">
                <input type="email" id="rh-username" placeholder="Robinhood Email" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <input type="password" id="rh-password" placeholder="Password" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                
                <!-- MFA is optional - collapsed by default -->
                <details class="text-sm">
                    <summary class="text-gray-500 cursor-pointer hover:text-gray-700">
                        Using SMS/Authenticator instead of app approval? Click here
                    </summary>
                    <input type="text" id="rh-mfa" placeholder="6-digit MFA Code" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg mt-2">
                </details>
                
                <div class="flex items-center space-x-3">
                    <select id="rh-days" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <button onclick="startRobinhoodConnect()" class="btn btn-success flex-1">
                        üîó Connect & Import
                    </button>
                </div>
            </div>
            
            <!-- Status area for showing approval instructions -->
            <div id="rh-instructions" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="text-2xl animate-pulse">üì±</div>
                    <div>
                        <p class="font-medium text-yellow-800">Waiting for approval...</p>
                        <p class="text-sm text-yellow-700" id="rh-instruction-text">
                            Check your Robinhood app and tap "Approve" to continue.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="rh-connected" class="hidden">
            <div class="flex items-center justify-between">
                <span class="text-green-700">‚úì Connected to Robinhood</span>
                <div class="space-x-2">
                    <button onclick="importFromRobinhoodSession()" class="btn btn-primary">
                        üì• Import New Trades
                    </button>
                    <button onclick="disconnectRobinhood()" class="btn btn-secondary">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Upload Form -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">üì§ Upload CSV</h2>
            
            <form id="upload-form" class="space-y-4">
                <!-- Format Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Format</label>
                    <select id="format-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="generic">üìÑ Generic CSV</option>
                        <optgroup label="TradingView">
                            <option value="tv_order_history">‚≠ê TradingView - Order History (RECOMMENDED)</option>
                            <option value="tv_balance_history">üìä TradingView - Balance History</option>
                        </optgroup>
                        <optgroup label="Brokers">
                            <option value="thinkorswim">üíπ TD Ameritrade ThinkOrSwim</option>
                            <option value="tradovate">üìà Tradovate</option>
                            <option value="interactive_brokers">üè¶ Interactive Brokers</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer"
                     onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileSelect(this)">
                    <div class="text-4xl mb-2">üìÅ</div>
                    <div class="text-gray-600">Click to select CSV file</div>
                    <div class="text-sm text-gray-400">or drag and drop</div>
                </div>
                
                <div id="file-name" class="text-center text-gray-600 hidden"></div>
                
                <button type="submit" id="upload-btn" class="btn btn-primary w-full" disabled>
                    Upload & Import
                </button>
            </form>

            <div class="mt-6 pt-6 border-t">
                <h3 class="font-medium mb-2">Or import from folder:</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Drop CSV files in: <code class="bg-gray-100 px-2 py-1 rounded">{{ imports_path }}</code>
                </p>
                <button onclick="bulkImport()" class="btn btn-secondary w-full">
                    üì• Import All from Folder
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">üìã Format Instructions</h2>
            
            <!-- Generic Format -->
            <div id="format-info-generic" class="format-info">
                <h3 class="font-medium text-gray-800 mb-2">Generic CSV Format</h3>
                <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
                    <div class="text-gray-500">ticker,direction,entry_price,exit_price,stop_price,size,trade_date,notes</div>
                    <div>SPY,long,475.50,478.00,474.00,100,2024-01-15,Strong pullback</div>
                    <div>AAPL,short,185.00,182.50,187.00,50,2024-01-15,Failed breakout</div>
                </div>
                <div class="mt-3 text-sm text-gray-600">
                    Required: ticker, entry_price, exit_price. Optional: stop_price, direction, size, strategy, notes.
                </div>
            </div>

            <!-- TradingView Order History Format (RECOMMENDED) -->
            <div id="format-info-tv_order_history" class="format-info hidden">
                <h3 class="font-medium text-gray-800 mb-2">‚≠ê TradingView - Order History (RECOMMENDED)</h3>
                <div class="bg-green-50 rounded-lg p-4 text-sm border border-green-200">
                    <p class="mb-2 text-green-800"><strong>‚úì Best format for multi-leg trades!</strong> Handles scaling in/out with average cost basis.</p>
                    <p class="mb-2"><strong>How to export:</strong></p>
                    <ol class="list-decimal list-inside space-y-1 text-gray-600">
                        <li>Open TradingView Paper Trading panel</li>
                        <li>Go to <strong>"Order History"</strong> tab</li>
                        <li>Click the download/export button (‚Üì)</li>
                        <li>Save the CSV file</li>
                    </ol>
                </div>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg text-sm text-blue-800">
                    <strong>Multi-leg example:</strong> Buy 300 @ $10, Buy 200 @ $11, Sell 400 @ $12, Sell 100 @ $13<br>
                    ‚Üí Creates 2 trades with avg entry $10.40 (each exit is a separate trade)
                </div>
                <div class="mt-2 font-mono text-xs bg-gray-100 p-2 rounded overflow-x-auto">
                    Columns: Symbol, Side, Type, Qty, Limit Price, Stop Price, Fill Price, Status, Closing Time...
                </div>
            </div>

            <!-- TradingView Balance History Format -->
            <div id="format-info-tv_balance_history" class="format-info hidden">
                <h3 class="font-medium text-gray-800 mb-2">TradingView - Balance History</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm">
                    <p class="mb-2"><strong>How to export:</strong></p>
                    <ol class="list-decimal list-inside space-y-1 text-gray-600">
                        <li>Open TradingView Paper Trading panel</li>
                        <li>Click on <strong>"Balance History"</strong> tab</li>
                        <li>Click the download/export button (‚Üì)</li>
                        <li>Save the CSV file</li>
                    </ol>
                </div>
                <div class="mt-3 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                    ‚ö†Ô∏è Balance History combines multi-leg trades into single entries. For detailed scaling in/out tracking, use Order History instead.
                </div>
                <div class="mt-2 font-mono text-xs bg-gray-100 p-2 rounded overflow-x-auto">
                    Columns: Time, Balance Before, Balance After, Realized P&L (value), Realized P&L (currency), Action
                </div>
            </div>

            <!-- ThinkOrSwim Format -->
            <div id="format-info-thinkorswim" class="format-info hidden">
                <h3 class="font-medium text-gray-800 mb-2">TD Ameritrade ThinkOrSwim</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
                    Export from: Monitor ‚Üí Account Statement ‚Üí Trades ‚Üí Export
                </div>
            </div>

            <!-- Tradovate Format -->
            <div id="format-info-tradovate" class="format-info hidden">
                <h3 class="font-medium text-gray-800 mb-2">Tradovate</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
                    Export from: Performance ‚Üí Trade History ‚Üí Download CSV
                </div>
            </div>

            <!-- Interactive Brokers Format -->
            <div id="format-info-interactive_brokers" class="format-info hidden">
                <h3 class="font-medium text-gray-800 mb-2">Interactive Brokers</h3>
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
                    Export from: Reports ‚Üí Flex Queries ‚Üí Trade Confirmations
                </div>
            </div>

            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="font-medium text-blue-800 mb-1">üß† AI Classification</div>
                <p class="text-sm text-blue-700">
                    The AI will automatically classify each trade into Brooks-style setups 
                    like "second_entry_buy" or "breakout_pullback_long".
                </p>
            </div>
        </div>
    </div>

    <!-- Files in Import Folder -->
    {% if import_files %}
    <div class="card">
        <h2 class="text-xl font-bold mb-4">üìÇ Files Ready to Import</h2>
        <div class="space-y-2">
            {% for f in import_files %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="font-mono">{{ f.name }}</span>
                <span class="text-gray-500 text-sm">{{ f.stat().st_size // 1024 }} KB</span>
            </div>
            {% endfor %}
        </div>
        <button onclick="bulkImport()" class="btn btn-primary mt-4">
            Import All ({{ import_files|length }} files)
        </button>
    </div>
    {% endif %}

    <!-- Recently Processed -->
    {% if processed_files %}
    <div class="card">
        <h2 class="text-xl font-bold mb-4">‚úÖ Recently Processed</h2>
        <div class="space-y-2">
            {% for f in processed_files[:5] %}
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <span class="font-mono text-green-700">{{ f.name }}</span>
                <span class="text-green-600 text-sm">‚úì Imported</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg hidden">
    <span id="toast-message"></span>
</div>

<!-- Loading overlay -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin text-4xl mb-4">‚è≥</div>
        <div class="text-xl font-medium">Importing trades...</div>
        <div class="text-gray-500">AI is classifying each trade</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const fileInput = document.getElementById('file-input');
const fileName = document.getElementById('file-name');
const uploadBtn = document.getElementById('upload-btn');
const uploadForm = document.getElementById('upload-form');
const formatSelect = document.getElementById('format-select');

// Check Robinhood session on load
checkRobinhoodSession();

async function checkRobinhoodSession() {
    try {
        const response = await fetch('/api/robinhood/status');
        const data = await response.json();
        
        if (data.has_session) {
            document.getElementById('rh-status').textContent = 'Session Stored';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-yellow-200 text-yellow-800';
        }
    } catch (e) {}
}

function startRobinhoodConnect() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    
    if (!username || !password) {
        showToast('Please enter username and password');
        return;
    }
    
    // Show approval instructions immediately
    const instructionsDiv = document.getElementById('rh-instructions');
    instructionsDiv.classList.remove('hidden');
    document.getElementById('rh-instruction-text').textContent = 
        'Check your Robinhood app and tap "Approve" to continue. This may take a few seconds...';
    
    // Now make the API call
    importFromRobinhood();
}

async function importFromRobinhood() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    const mfaEl = document.getElementById('rh-mfa');
    const mfa = mfaEl ? mfaEl.value : '';
    const days = document.getElementById('rh-days').value;
    
    if (!username || !password) {
        showToast('Please enter username and password');
        return;
    }
    
    try {
        const response = await fetch('/api/robinhood/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: username,
                password: password,
                mfa_code: mfa || null,
                days_back: parseInt(days)
            })
        });
        
        const data = await response.json();
        
        // Hide instructions
        document.getElementById('rh-instructions').classList.add('hidden');
        
        // Handle special cases
        if (data.needs_device_approval) {
            showRobinhoodAlert(
                'üì± Device Approval Required',
                'Please check your Robinhood app and approve this login request. ' +
                'After approving, click "Try Again" below.',
                true
            );
            return;
        }
        
        if (data.needs_mfa) {
            showRobinhoodAlert(
                'üîê MFA Code Required',
                'Please enter the 6-digit code from your authenticator app in the MFA field above, then try again.',
                false
            );
            // Expand the MFA details
            document.querySelector('#rh-login-form details').open = true;
            const mfaInput = document.getElementById('rh-mfa');
            if (mfaInput) mfaInput.focus();
            return;
        }
        
        if (data.error) {
            showToast('Error: ' + data.error);
        } else if (data.imported > 0) {
            showToast(data.messages[0] || `Imported ${data.imported} trades`);
            
            // Update UI
            document.getElementById('rh-status').textContent = 'Connected';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-green-200 text-green-800';
            
            // Clear password field
            document.getElementById('rh-password').value = '';
            if (mfaEl) mfaEl.value = '';
            
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showToast(data.messages[0] || 'Connected! No new trades to import.');
            document.getElementById('rh-status').textContent = 'Connected';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-green-200 text-green-800';
        }
    } catch (err) {
        document.getElementById('rh-instructions').classList.add('hidden');
        showToast('Connection failed: ' + err.message);
    }
}

function showRobinhoodAlert(title, message, showRetry) {
    // Remove any existing alert
    const existing = document.getElementById('rh-alert');
    if (existing) existing.remove();
    
    const alertHtml = `
        <div id="rh-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-xl">
                <h3 class="text-xl font-bold mb-3">${title}</h3>
                <p class="text-gray-600 mb-4">${message}</p>
                <div class="flex space-x-3">
                    ${showRetry ? '<button onclick="closeRhAlert(); importFromRobinhood();" class="btn btn-primary flex-1">Try Again</button>' : ''}
                    <button onclick="closeRhAlert();" class="btn btn-secondary ${showRetry ? '' : 'flex-1'}">OK</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
}

function closeRhAlert() {
    const alert = document.getElementById('rh-alert');
    if (alert) alert.remove();
}

async function importFromRobinhoodSession() {
    const days = document.getElementById('rh-days').value;
    
    showLoading(true);
    
    try {
        const response = await fetch('/api/robinhood/import-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days_back: parseInt(days)})
        });
        
        const data = await response.json();
        showLoading(false);
        
        if (data.error) {
            showToast('Error: ' + data.error);
        } else {
            showToast(data.messages[0] || `Imported ${data.imported} trades`);
            setTimeout(() => window.location.reload(), 2000);
        }
    } catch (err) {
        showLoading(false);
        showToast('Import failed: ' + err.message);
    }
}

async function disconnectRobinhood() {
    try {
        await fetch('/api/robinhood/disconnect', {method: 'POST'});
        document.getElementById('rh-status').textContent = 'Not Connected';
        document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-600';
        showToast('Disconnected from Robinhood');
    } catch (err) {
        showToast('Error disconnecting');
    }
}

function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toast-message').textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

function handleFileSelect(input) {
    if (input.files.length > 0) {
        fileName.textContent = input.files[0].name;
        fileName.classList.remove('hidden');
        uploadBtn.disabled = false;
        
        // Auto-detect TradingView format from filename
        const name = input.files[0].name.toLowerCase();
        if (name.includes('order-history')) {
            formatSelect.value = 'tv_order_history';
            updateFormatInfo();
        } else if (name.includes('balance-history')) {
            formatSelect.value = 'tv_balance_history';
            updateFormatInfo();
        }
    }
}

// Show/hide format info based on selection
function updateFormatInfo() {
    document.querySelectorAll('.format-info').forEach(el => el.classList.add('hidden'));
    const selected = formatSelect.value;
    const infoEl = document.getElementById('format-info-' + selected);
    if (infoEl) infoEl.classList.remove('hidden');
}

formatSelect.addEventListener('change', updateFormatInfo);
updateFormatInfo(); // Initialize

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!fileInput.files.length) return;
    
    showLoading(true);
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('format', formatSelect.value);
    
    try {
        // Upload and import in one step
        const response = await fetch('/api/import-csv', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        showLoading(false);
        
        if (data.error) {
            showToast('Error: ' + data.error);
        } else {
            showToast(`Imported ${data.imported} trades, ${data.errors} errors`);
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (err) {
        showLoading(false);
        showToast('Import failed: ' + err.message);
    }
});

async function bulkImport() {
    showLoading(true);
    
    try {
        const response = await fetch('/api/bulk-import', { method: 'POST' });
        const data = await response.json();
        
        showLoading(false);
        showToast(`Imported ${data.imported} trades, ${data.errors} errors`);
        
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showLoading(false);
        showToast('Import failed');
    }
}

// Drag and drop
const dropZone = document.querySelector('.border-dashed');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        fileInput.files = files;
        handleFileSelect(fileInput);
    }
});
</script>
{% endblock %}
