{% extends "base.html" %}

{% block title %}Import Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
            Import Trades
        </h1>
        <p class="text-dark-400 mt-1">Import your trade history from various sources</p>
    </div>

    <!-- Robinhood Auto-Import -->
    <div class="card bg-gradient-to-br from-success-500/10 to-success-600/5 border-success-500/30">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">ü§ñ Robinhood Auto-Import</h2>
            <span id="rh-status" class="badge bg-dark-700 text-dark-300 border-dark-600">Not Connected</span>
        </div>
        
        <div id="rh-login-form">
            <div class="bg-accent-500/10 border border-accent-500/30 rounded-xl p-3 mb-4">
                <p class="text-sm text-accent-300">
                    <strong>üì± How it works:</strong> After clicking Connect, check your <strong class="text-white">Robinhood app</strong> 
                    to approve the login. No MFA code needed if you use app approval.
                </p>
            </div>
            
            <div class="space-y-3">
                <input type="email" id="rh-username" placeholder="Robinhood Email" class="input">
                <input type="password" id="rh-password" placeholder="Password" class="input">
                
                <!-- MFA is optional - collapsed by default -->
                <details class="text-sm">
                    <summary class="text-dark-400 cursor-pointer hover:text-dark-200">
                        Using SMS/Authenticator instead of app approval? Click here
                    </summary>
                    <input type="text" id="rh-mfa" placeholder="6-digit MFA Code" class="input mt-2">
                </details>
                
                <div class="flex items-center gap-3">
                    <select id="rh-days" class="select flex-shrink-0">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <button onclick="startRobinhoodConnect()" class="btn btn-success flex-1">
                        üîó Connect & Import
                    </button>
                </div>
            </div>
            
            <!-- Status area for showing approval instructions -->
            <div id="rh-instructions" class="hidden mt-4 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                <div class="flex items-start gap-3">
                    <div class="text-2xl animate-pulse">üì±</div>
                    <div>
                        <p class="font-medium text-amber-400">Waiting for approval...</p>
                        <p class="text-sm text-amber-300" id="rh-instruction-text">
                            Check your Robinhood app and tap "Approve" to continue.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="rh-connected" class="hidden">
            <div class="flex items-center justify-between">
                <span class="text-success-400">‚úì Connected to Robinhood</span>
                <div class="flex gap-2">
                    <button onclick="importFromRobinhoodSession()" class="btn btn-primary">
                        üì• Import New Trades
                    </button>
                    <button onclick="disconnectRobinhood()" class="btn btn-secondary">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Upload Form -->
        <div class="card">
            <h2 class="text-xl font-bold text-white mb-4">üì§ Upload CSV</h2>
            
            <form id="upload-form" class="space-y-4">
                <!-- Format Selector -->
                <div>
                    <label class="label">Import Format</label>
                    <select id="format-select" class="select">
                        <option value="generic">üìÑ Generic CSV</option>
                        <optgroup label="TradingView">
                            <option value="tv_order_history">‚≠ê TradingView - Order History (RECOMMENDED)</option>
                            <option value="tv_balance_history">üìä TradingView - Balance History</option>
                        </optgroup>
                        <optgroup label="Brokers">
                            <option value="thinkorswim">üíπ TD Ameritrade ThinkOrSwim</option>
                            <option value="tradovate">üìà Tradovate</option>
                            <option value="interactive_brokers">üè¶ Interactive Brokers</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="border-2 border-dashed border-dark-600 rounded-xl p-8 text-center hover:border-accent-500 transition cursor-pointer bg-dark-900/50"
                     onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileSelect(this)">
                    <div class="text-4xl mb-2">üìÅ</div>
                    <div class="text-dark-300">Click to select CSV file</div>
                    <div class="text-sm text-dark-500">or drag and drop</div>
                </div>
                
                <div id="file-name" class="text-center text-accent-400 hidden"></div>
                
                <!-- Balance History for cross-validation (shown only for TV Order History) -->
                <div id="balance-file-section" class="hidden">
                    <div class="border-t border-dark-700 pt-4 mt-2">
                        <label class="label">
                            üìä Balance History (for cross-validation) 
                            <span class="text-dark-500 font-normal">- Optional</span>
                        </label>
                        <div class="border-2 border-dashed border-success-500/30 rounded-xl p-4 text-center hover:border-success-500 transition cursor-pointer bg-success-500/5"
                             onclick="document.getElementById('balance-file-input').click()">
                            <input type="file" id="balance-file-input" accept=".csv" class="hidden" onchange="handleBalanceFileSelect(this)">
                            <div class="text-2xl mb-1">üìä</div>
                            <div class="text-dark-300 text-sm">Add Balance History for validation</div>
                        </div>
                        <div id="balance-file-name" class="text-center text-success-400 text-sm hidden"></div>
                        <p class="text-xs text-dark-500 mt-1">
                            Validates computed entry prices against TradingView's actual values
                        </p>
                    </div>
                </div>
                
                <button type="submit" id="upload-btn" class="btn btn-primary w-full" disabled>
                    üì§ Upload & Import
                </button>
            </form>

            <div class="mt-6 pt-6 border-t border-dark-700">
                <h3 class="font-medium text-white mb-2">Or import from folder:</h3>
                <p class="text-sm text-dark-400 mb-3">
                    Drop CSV files in: <code class="bg-dark-900 px-2 py-1 rounded text-accent-400">{{ imports_path }}</code>
                </p>
                <button onclick="bulkImport()" class="btn btn-secondary w-full">
                    üì• Import All from Folder
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card">
            <h2 class="text-xl font-bold text-white mb-4">üìã Format Instructions</h2>
            
            <!-- Generic Format -->
            <div id="format-info-generic" class="format-info">
                <h3 class="font-medium text-white mb-2">Generic CSV Format</h3>
                <div class="bg-dark-900/50 rounded-xl p-4 font-mono text-sm overflow-x-auto text-dark-300">
                    <div class="text-dark-500">ticker,direction,entry_price,exit_price,size,trade_date,sl,tp,notes</div>
                    <div>SPY,long,475.50,478.00,100,2024-01-15,474.00,480.00,Strong pullback</div>
                    <div>AAPL,short,185.00,182.50,50,2024-01-15,187.00,180.00,Failed breakout</div>
                </div>
                <div class="mt-3 text-sm text-dark-400">
                    Required: ticker, entry_price, exit_price. Optional: direction, size, sl (stop loss), tp (take profit), strategy, notes.
                </div>
            </div>

            <!-- TradingView Order History Format (RECOMMENDED) -->
            <div id="format-info-tv_order_history" class="format-info hidden">
                <h3 class="font-medium text-white mb-2">‚≠ê TradingView - Order History (RECOMMENDED)</h3>
                <div class="bg-success-500/10 border border-success-500/30 rounded-xl p-4 text-sm">
                    <p class="mb-2 text-success-400"><strong>‚úì Best format for multi-leg trades!</strong> Handles scaling in/out with average cost basis.</p>
                    <p class="mb-2 text-dark-300"><strong class="text-white">How to export:</strong></p>
                    <ol class="list-decimal list-inside space-y-1 text-dark-300">
                        <li>Open TradingView Paper Trading panel</li>
                        <li>Go to <strong class="text-white">"Order History"</strong> tab</li>
                        <li>Click the download/export button (‚Üì)</li>
                        <li>Save the CSV file</li>
                    </ol>
                </div>
                <div class="mt-3 p-3 bg-accent-500/10 border border-accent-500/30 rounded-xl text-sm text-accent-300">
                    <strong class="text-accent-400">Multi-leg example:</strong> Buy 300 @ $10, Buy 200 @ $11, Sell 400 @ $12, Sell 100 @ $13<br>
                    ‚Üí Creates 2 trades with avg entry $10.40 (each exit is a separate trade)
                </div>
                <div class="mt-2 font-mono text-xs bg-dark-900/50 p-2 rounded-lg overflow-x-auto text-dark-400">
                    Columns: Symbol, Side, Type, Qty, Limit Price, Stop Price, Fill Price, Status, Closing Time...
                </div>
            </div>

            <!-- TradingView Balance History Format -->
            <div id="format-info-tv_balance_history" class="format-info hidden">
                <h3 class="font-medium text-white mb-2">TradingView - Balance History</h3>
                <div class="bg-dark-900/50 rounded-xl p-4 text-sm">
                    <p class="mb-2 text-dark-300"><strong class="text-white">How to export:</strong></p>
                    <ol class="list-decimal list-inside space-y-1 text-dark-300">
                        <li>Open TradingView Paper Trading panel</li>
                        <li>Click on <strong class="text-white">"Balance History"</strong> tab</li>
                        <li>Click the download/export button (‚Üì)</li>
                        <li>Save the CSV file</li>
                    </ol>
                </div>
                <div class="mt-3 p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl text-sm text-amber-300">
                    ‚ö†Ô∏è Balance History combines multi-leg trades into single entries. For detailed scaling in/out tracking, use Order History instead.
                </div>
                <div class="mt-2 font-mono text-xs bg-dark-900/50 p-2 rounded-lg overflow-x-auto text-dark-400">
                    Columns: Time, Balance Before, Balance After, Realized P&L (value), Realized P&L (currency), Action
                </div>
            </div>

            <!-- ThinkOrSwim Format -->
            <div id="format-info-thinkorswim" class="format-info hidden">
                <h3 class="font-medium text-white mb-2">TD Ameritrade ThinkOrSwim</h3>
                <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                    Export from: Monitor ‚Üí Account Statement ‚Üí Trades ‚Üí Export
                </div>
            </div>

            <!-- Tradovate Format -->
            <div id="format-info-tradovate" class="format-info hidden">
                <h3 class="font-medium text-white mb-2">Tradovate</h3>
                <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                    Export from: Performance ‚Üí Trade History ‚Üí Download CSV
                </div>
            </div>

            <!-- Interactive Brokers Format -->
            <div id="format-info-interactive_brokers" class="format-info hidden">
                <h3 class="font-medium text-white mb-2">Interactive Brokers</h3>
                <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                    Export from: Reports ‚Üí Flex Queries ‚Üí Trade Confirmations
                </div>
            </div>

            <div class="mt-6 p-4 bg-accent-500/10 border border-accent-500/30 rounded-xl">
                <div class="font-medium text-accent-400 mb-1">üß† AI Classification</div>
                <p class="text-sm text-accent-300">
                    The AI will automatically classify each trade into Brooks-style setups 
                    like "second_entry_buy" or "breakout_pullback_long".
                </p>
            </div>
        </div>
    </div>

    <!-- Files in Import Folder -->
    {% if import_files %}
    <div class="card">
        <h2 class="text-xl font-bold text-white mb-4">üìÇ Files Ready to Import</h2>
        <div class="space-y-2">
            {% for f in import_files %}
            <div class="flex items-center justify-between p-3 bg-dark-900/50 rounded-xl border border-dark-700">
                <span class="font-mono text-dark-200">{{ f.name }}</span>
                <span class="text-dark-500 text-sm">{{ f.stat().st_size // 1024 }} KB</span>
            </div>
            {% endfor %}
        </div>
        <button onclick="bulkImport()" class="btn btn-primary mt-4">
            Import All ({{ import_files|length }} files)
        </button>
    </div>
    {% endif %}

    <!-- Recently Processed -->
    {% if processed_files %}
    <div class="card">
        <h2 class="text-xl font-bold text-white mb-4">‚úÖ Recently Processed</h2>
        <div class="space-y-2">
            {% for f in processed_files[:5] %}
            <div class="flex items-center justify-between p-3 bg-success-500/10 border border-success-500/30 rounded-xl">
                <span class="font-mono text-success-400">{{ f.name }}</span>
                <span class="text-success-500 text-sm">‚úì Imported</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
const fileInput = document.getElementById('file-input');
const fileName = document.getElementById('file-name');
const uploadBtn = document.getElementById('upload-btn');
const uploadForm = document.getElementById('upload-form');
const formatSelect = document.getElementById('format-select');

// Check Robinhood session on load
checkRobinhoodSession();

async function checkRobinhoodSession() {
    try {
        const response = await fetch('/api/robinhood/status');
        const data = await response.json();
        
        if (data.has_session) {
            document.getElementById('rh-status').textContent = 'Session Stored';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-yellow-200 text-yellow-800';
        }
    } catch (e) {}
}

function startRobinhoodConnect() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    
    if (!username || !password) {
        showToast('Please enter username and password');
        return;
    }
    
    // Show approval instructions immediately
    const instructionsDiv = document.getElementById('rh-instructions');
    instructionsDiv.classList.remove('hidden');
    document.getElementById('rh-instruction-text').textContent = 
        'Check your Robinhood app and tap "Approve" to continue. This may take a few seconds...';
    
    // Now make the API call
    importFromRobinhood();
}

async function importFromRobinhood() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    const mfaEl = document.getElementById('rh-mfa');
    const mfa = mfaEl ? mfaEl.value : '';
    const days = document.getElementById('rh-days').value;
    
    if (!username || !password) {
        showToast('Please enter username and password');
        return;
    }
    
    try {
        const response = await fetch('/api/robinhood/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: username,
                password: password,
                mfa_code: mfa || null,
                days_back: parseInt(days)
            })
        });
        
        const data = await response.json();
        
        // Hide instructions
        document.getElementById('rh-instructions').classList.add('hidden');
        
        // Handle special cases
        if (data.needs_device_approval) {
            showRobinhoodAlert(
                'üì± Device Approval Required',
                'Please check your Robinhood app and approve this login request. ' +
                'After approving, click "Try Again" below.',
                true
            );
            return;
        }
        
        if (data.needs_mfa) {
            showRobinhoodAlert(
                'üîê MFA Code Required',
                'Please enter the 6-digit code from your authenticator app in the MFA field above, then try again.',
                false
            );
            // Expand the MFA details
            document.querySelector('#rh-login-form details').open = true;
            const mfaInput = document.getElementById('rh-mfa');
            if (mfaInput) mfaInput.focus();
            return;
        }
        
        if (data.error) {
            showToast('Error: ' + data.error);
        } else if (data.imported > 0) {
            showToast(data.messages[0] || `Imported ${data.imported} trades`);
            
            // Update UI
            document.getElementById('rh-status').textContent = 'Connected';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-green-200 text-green-800';
            
            // Clear password field
            document.getElementById('rh-password').value = '';
            if (mfaEl) mfaEl.value = '';
            
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showToast(data.messages[0] || 'Connected! No new trades to import.');
            document.getElementById('rh-status').textContent = 'Connected';
            document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-green-200 text-green-800';
        }
    } catch (err) {
        document.getElementById('rh-instructions').classList.add('hidden');
        showToast('Connection failed: ' + err.message);
    }
}

function showRobinhoodAlert(title, message, showRetry) {
    // Remove any existing alert
    const existing = document.getElementById('rh-alert');
    if (existing) existing.remove();
    
    const alertHtml = `
        <div id="rh-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-xl">
                <h3 class="text-xl font-bold mb-3">${title}</h3>
                <p class="text-gray-600 mb-4">${message}</p>
                <div class="flex space-x-3">
                    ${showRetry ? '<button onclick="closeRhAlert(); importFromRobinhood();" class="btn btn-primary flex-1">Try Again</button>' : ''}
                    <button onclick="closeRhAlert();" class="btn btn-secondary ${showRetry ? '' : 'flex-1'}">OK</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
}

function closeRhAlert() {
    const alert = document.getElementById('rh-alert');
    if (alert) alert.remove();
}

async function importFromRobinhoodSession() {
    const days = document.getElementById('rh-days').value;

    showStartToast('Robinhood import');

    try {
        const response = await fetch('/api/robinhood/import-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days_back: parseInt(days)})
        });

        const data = await response.json();

        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            showFinishToast('Robinhood import', `${data.imported} trades`);
            setTimeout(() => window.location.reload(), 2000);
        }
    } catch (err) {
        showToast('Import failed: ' + err.message, 'error');
    }
}

async function disconnectRobinhood() {
    try {
        await fetch('/api/robinhood/disconnect', {method: 'POST'});
        document.getElementById('rh-status').textContent = 'Not Connected';
        document.getElementById('rh-status').className = 'text-sm px-3 py-1 rounded-full bg-gray-200 text-gray-600';
        showToast('Disconnected from Robinhood');
    } catch (err) {
        showToast('Error disconnecting');
    }
}

// Using global showToast and showStartToast/showFinishToast from base.html

function handleFileSelect(input) {
    if (input.files.length > 0) {
        fileName.textContent = input.files[0].name;
        fileName.classList.remove('hidden');
        uploadBtn.disabled = false;
        
        // Auto-detect TradingView format from filename
        const name = input.files[0].name.toLowerCase();
        if (name.includes('order-history')) {
            formatSelect.value = 'tv_order_history';
            updateFormatInfo();
        } else if (name.includes('balance-history')) {
            formatSelect.value = 'tv_balance_history';
            updateFormatInfo();
        }
    }
}

const balanceFileInput = document.getElementById('balance-file-input');
const balanceFileName = document.getElementById('balance-file-name');
const balanceFileSection = document.getElementById('balance-file-section');

function handleBalanceFileSelect(input) {
    if (input.files.length > 0) {
        balanceFileName.textContent = '‚úì ' + input.files[0].name;
        balanceFileName.classList.remove('hidden');
    }
}

// Show/hide format info based on selection
function updateFormatInfo() {
    document.querySelectorAll('.format-info').forEach(el => el.classList.add('hidden'));
    const selected = formatSelect.value;
    const infoEl = document.getElementById('format-info-' + selected);
    if (infoEl) infoEl.classList.remove('hidden');
    
    // Show/hide balance file section for TV Order History
    if (selected === 'tv_order_history') {
        balanceFileSection.classList.remove('hidden');
    } else {
        balanceFileSection.classList.add('hidden');
    }
}

formatSelect.addEventListener('change', updateFormatInfo);
updateFormatInfo(); // Initialize

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!fileInput.files.length) return;
    
    showStartToast('Importing trades');
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('format', formatSelect.value);
    
    // Add balance file for cross-validation if provided
    if (balanceFileInput && balanceFileInput.files.length > 0) {
        formData.append('balance_file', balanceFileInput.files[0]);
    }
    
    try {
        // Upload and import in one step
        const response = await fetch('/api/import-csv', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            let brief = `${data.imported} trades`;
            if (data.cross_validated) brief += ' (validated)';
            showFinishToast('Import', brief);
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (err) {
        showToast('Import failed: ' + err.message, 'error');
    }
});

async function bulkImport() {
    showStartToast('Bulk import');
    
    try {
        const response = await fetch('/api/bulk-import', { method: 'POST' });
        const data = await response.json();
        
        showFinishToast('Bulk import', `${data.imported} trades`);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showToast('Import failed', 'error');
    }
}

// Drag and drop
const dropZone = document.querySelector('.border-dashed');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        fileInput.files = files;
        handleFileSelect(fileInput);
    }
});
</script>
{% endblock %}
