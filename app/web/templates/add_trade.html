{% extends "base.html" %}

{% block title %}Add Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
            Add Trades
        </h1>
        <p class="text-dark-400 text-sm mt-1">Log a single trade or import in bulk</p>
    </div>

    <!-- Tabs -->
    <div class="border-b border-dark-700 mb-6">
        <nav class="flex space-x-4">
            <button onclick="showTab('single')" id="tab-single" 
                class="trade-tab px-6 py-3 text-sm font-medium border-b-2 border-accent-500 text-accent-400">
                ‚ûï Single Trade
            </button>
            <button onclick="showTab('import')" id="tab-import"
                class="trade-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-dark-400 hover:text-dark-200">
                üì• Bulk Import
            </button>
        </nav>
    </div>

    <!-- Single Trade Panel -->
    <div id="panel-single" class="trade-panel">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form -->
            <div class="lg:col-span-2">
            <form action="/api/trades" method="POST" class="card space-y-6" id="add-trade-form" onsubmit="return validateTradeForm()">
                <!-- Ticker -->
                <div>
                    <label class="label">Ticker *</label>
                    <input type="text" name="ticker" required 
                        class="input uppercase" placeholder="SPY" list="ticker-list">
                    <datalist id="ticker-list">
                        {% for ticker in tickers %}
                        <option value="{{ ticker }}">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Entry Time -->
                    <div>
                        <label class="label">Entry Time</label>
                        <div class="flex gap-2">
                            <input type="datetime-local" name="entry_time" id="entry_time"
                                class="input flex-1" step="1">
                            <button type="button" onclick="setNow('entry_time')" 
                                class="btn btn-secondary text-xs px-2" title="Set to now">Now</button>
                        </div>
                    </div>

                    <!-- Exit Time -->
                    <div>
                        <label class="label">Exit Time</label>
                        <div class="flex gap-2">
                            <input type="datetime-local" name="exit_time" id="exit_time"
                                class="input flex-1" step="1">
                            <button type="button" onclick="setNow('exit_time')" 
                                class="btn btn-secondary text-xs px-2" title="Set to now">Now</button>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-dark-500 -mt-2">Times are in your local timezone</p>

                <div class="grid grid-cols-3 gap-4">
                    <!-- Direction -->
                    <div>
                        <label class="label">Direction *</label>
                        <select name="direction" required class="select">
                            <option value="long">üü¢ Long</option>
                            <option value="short">üî¥ Short</option>
                        </select>
                    </div>

                    <!-- Size -->
                    <div>
                        <label class="label">Size (shares)</label>
                        <input type="number" name="size" 
                            class="input" placeholder="100" value="1" step="any">
                    </div>

                    <!-- Timeframe -->
                    <div>
                        <label class="label">Timeframe</label>
                        <select name="timeframe" class="select">
                            <option value="5m">5 min (Scalp)</option>
                            <option value="2h">2 hour (Swing)</option>
                            <option value="1d">Daily (Position)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Entry -->
                    <div>
                        <label class="label">Entry Price *</label>
                        <input type="number" name="entry_price" required 
                            class="input" placeholder="100.00" step="0.01">
                    </div>

                    <!-- Exit -->
                    <div>
                        <label class="label">Exit Price *</label>
                        <input type="number" name="exit_price" required 
                            class="input" placeholder="102.00" step="0.01">
                    </div>

                    <!-- Stop -->
                    <div>
                        <label class="label">Stop Loss (SL)</label>
                        <input type="number" name="stop_loss" 
                            class="input" placeholder="98.00" step="0.01">
                    </div>

                    <!-- Take Profit -->
                    <div>
                        <label class="label">Take Profit (TP)</label>
                        <input type="number" name="take_profit" 
                            class="input" placeholder="105.00" step="0.01">
                    </div>
                </div>

                <!-- Strategy (optional - LLM will classify if not set) -->
                <div>
                    <label class="label">Strategy (optional - AI will classify if empty)</label>
                    <select name="strategy" class="select">
                        <option value="">-- Let AI classify --</option>
                        <optgroup label="With Trend">
                            {% for s in strategies if s.category == 'with_trend' %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Countertrend">
                            {% for s in strategies if s.category == 'countertrend' %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Trading Range">
                            {% for s in strategies if s.category == 'trading_range' %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Special">
                            {% for s in strategies if s.category == 'special' %}
                            <option value="{{ s.name }}">{{ s.name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>

                <!-- Entry Reason -->
                <div>
                    <label class="label">Entry Reason</label>
                    <textarea name="entry_reason" class="input" rows="2" 
                        placeholder="Why did you enter this trade?"></textarea>
                </div>

                <!-- Notes -->
                <div>
                    <label class="label">Notes</label>
                    <textarea name="notes" class="input" rows="3" 
                        placeholder="Additional notes about the trade..."></textarea>
                </div>

                <!-- Submit -->
                <div class="flex justify-end space-x-4">
                    <a href="/trades" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Add Trade</button>
                </div>
            </form>
            </div>

            <!-- Live preview -->
            <div class="lg:col-span-1">
                <div class="card lg:sticky lg:top-24 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-white">üìå Live Preview</h3>
                        <span class="text-xs text-dark-500">updates as you type</span>
                    </div>

                    <div class="bg-dark-900/40 border border-dark-700 rounded-xl p-4">
                        <div class="text-xs text-dark-500 mb-2">R-Multiple</div>
                        <div id="r-preview" class="text-3xl font-mono font-bold text-dark-500">--</div>
                        <div class="text-xs text-dark-500 mt-2">
                            R requires a Stop Loss. (Import is fine without SL/TP.)
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-dark-900/40 border border-dark-700 rounded-xl p-3">
                            <div class="text-xs text-dark-500 mb-1">Risk / Share</div>
                            <div id="risk-preview" class="font-mono font-semibold text-dark-300">--</div>
                        </div>
                        <div class="bg-dark-900/40 border border-dark-700 rounded-xl p-3">
                            <div class="text-xs text-dark-500 mb-1">P&L / Share</div>
                            <div id="pnl-preview" class="font-mono font-semibold text-dark-300">--</div>
                        </div>
                        <div class="bg-dark-900/40 border border-dark-700 rounded-xl p-3">
                            <div class="text-xs text-dark-500 mb-1">RR (to TP)</div>
                            <div id="rr-preview" class="font-mono font-semibold text-dark-300">--</div>
                        </div>
                        <div class="bg-dark-900/40 border border-dark-700 rounded-xl p-3">
                            <div class="text-xs text-dark-500 mb-1">Stop Valid?</div>
                            <div id="stop-valid-preview" class="font-mono font-semibold text-dark-300">--</div>
                        </div>
                    </div>

                    <div class="text-xs text-dark-500">
                        Tip: After import, you can edit trades to add SL/TP for accurate Brooks-style review.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Panel -->
    <div id="panel-import" class="trade-panel hidden space-y-6">
        <!-- Auto-Import (Broker selector like CSV format) -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">‚ö° Auto-Import</h2>
                <div class="flex items-center gap-2">
                    <span id="rh-status" class="badge bg-dark-700 text-dark-300 border-dark-600">Not Connected</span>
                    <span id="ibkr-status" class="badge bg-dark-700 text-dark-300 border-dark-600 hidden">Not Configured</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label class="label">Broker</label>
                    <select id="auto-import-broker" class="select" onchange="updateAutoImportBroker()">
                        <option value="robinhood" selected>ü§ñ Robinhood</option>
                        <option value="ibkr_flex">üè¶ Interactive Brokers (Flex)</option>
                    </select>
                    <p id="auto-import-hint" class="text-xs text-dark-500 mt-1"></p>
                </div>
                <div class="text-xs text-dark-500 md:text-right">
                    Auto-import is read-only. You can add SL/TP later for accurate R.
                </div>
            </div>

            <!-- Broker panels -->
            <div class="mt-6">
                <!-- Robinhood panel -->
                <div id="auto-import-panel-robinhood" class="space-y-4">
                    <div class="bg-accent-500/10 border border-accent-500/30 rounded-xl p-3">
                        <p class="text-sm text-accent-300">
                            <strong>üì± Robinhood:</strong> Click Connect, then approve in the Robinhood app. Use MFA only if required.
                        </p>
                    </div>

                    <div id="rh-login-form" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="email" id="rh-username" placeholder="Robinhood Email" class="input">
                            <input type="password" id="rh-password" placeholder="Password" class="input">
                        </div>

                        <details class="text-sm">
                            <summary class="text-dark-400 cursor-pointer hover:text-dark-200">
                                Using SMS/Authenticator instead of app approval? Click here
                            </summary>
                            <input type="text" id="rh-mfa" placeholder="6-digit MFA Code" class="input mt-2">
                        </details>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div>
                                <label class="label">Lookback</label>
                                <select id="rh-days" class="select">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="365">Last year</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="label opacity-0">Action</label>
                                <button onclick="startRobinhoodConnect()" class="btn btn-success w-full">
                                    üîó Connect & Import
                                </button>
                            </div>
                        </div>

                        <div id="rh-instructions" class="hidden mt-2 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl animate-pulse">üì±</div>
                                <div>
                                    <p class="font-medium text-amber-400">Waiting for approval...</p>
                                    <p class="text-sm text-amber-300" id="rh-instruction-text">
                                        Check your Robinhood app and tap "Approve" to continue.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="rh-connected" class="hidden">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-dark-900/40 border border-dark-700 rounded-xl p-4">
                            <span class="text-success-400">‚úì Session stored</span>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="importFromRobinhoodSession()" class="btn btn-primary">
                                    üì• Import New Trades
                                </button>
                                <button onclick="disconnectRobinhood()" class="btn btn-secondary">
                                    Disconnect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IBKR panel -->
                <div id="auto-import-panel-ibkr" class="space-y-4 hidden">
                    <div class="bg-dark-900/50 border border-dark-700 rounded-xl p-3 text-sm text-dark-300">
                        <strong>IBKR Flex (read-only):</strong> Provide a Flex Web Service token + Flex Query ID, or leave blank to use <code class="text-accent-400">IBKR_FLEX_TOKEN</code> / <code class="text-accent-400">IBKR_FLEX_QUERY_ID</code> from your <code class="text-accent-400">.env</code>.
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="password" id="ibkr-token" placeholder="Flex Token (optional)" class="input">
                        <input type="text" id="ibkr-query-id" placeholder="Flex Query ID (optional)" class="input">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                        <div>
                            <label class="label">Lookback</label>
                            <select id="ibkr-days" class="select">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Timezone (your Flex times)</label>
                            <select id="ibkr-timezone" class="select">
                                <option value="America/New_York" selected>America/New_York</option>
                                <option value="America/Chicago">America/Chicago</option>
                                <option value="America/Los_Angeles">America/Los_Angeles</option>
                                <option value="Asia/Hong_Kong">Asia/Hong_Kong</option>
                                <option value="Asia/Shanghai">Asia/Shanghai</option>
                                <option value="Europe/London">Europe/London</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <div>
                            <label class="label opacity-0">Action</label>
                            <button onclick="importFromIbkrFlex()" class="btn btn-primary w-full">
                                üì• Import
                            </button>
                        </div>
                    </div>

                    <div class="text-xs text-dark-500">
                        We do not store your token. Trades are aggregated flat-to-flat (round trips).
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Upload Form -->
            <div class="card">
                <h2 class="text-xl font-bold text-white mb-4">üì§ Upload CSV</h2>
                
                <form id="upload-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="label">Import Format</label>
                            <select id="format-select" class="select">
                                <option value="generic">üìÑ Generic CSV</option>
                                <optgroup label="TradingView">
                                    <option value="tv_order_history">‚≠ê TradingView - Order History (RECOMMENDED)</option>
                                    <option value="tv_balance_history">üìä TradingView - Balance History</option>
                                </optgroup>
                                <optgroup label="Brokers">
                                    <option value="thinkorswim">üíπ TD Ameritrade ThinkOrSwim</option>
                                    <option value="tradovate">üìà Tradovate</option>
                                    <option value="interactive_brokers">üè¶ Interactive Brokers</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div id="timezone-section" class="hidden">
                            <label class="label">
                                Your Timezone (CSV times are in)
                                <span class="text-xs text-dark-500 ml-1">üåè</span>
                            </label>
                            <select id="timezone-select" class="select">
                                <optgroup label="Americas">
                                    <option value="America/New_York">Eastern Time (New York)</option>
                                    <option value="America/Chicago">Central Time (Chicago)</option>
                                    <option value="America/Denver">Mountain Time (Denver)</option>
                                    <option value="America/Los_Angeles">Pacific Time (Los Angeles)</option>
                                </optgroup>
                                <optgroup label="Asia">
                                    <option value="Asia/Shanghai">Beijing/Shanghai Time</option>
                                    <option value="Asia/Hong_Kong">Hong Kong Time</option>
                                    <option value="Asia/Tokyo">Tokyo Time</option>
                                    <option value="Asia/Singapore">Singapore Time</option>
                                </optgroup>
                                <optgroup label="Europe">
                                    <option value="Europe/London">London Time</option>
                                    <option value="Europe/Paris">Central European Time</option>
                                </optgroup>
                                <option value="UTC">UTC</option>
                            </select>
                            <p class="text-xs text-dark-500 mt-1">
                                Times will be converted to market timezone (e.g., AMEX/NASDAQ ‚Üí Eastern, HKEX ‚Üí HK)
                            </p>
                        </div>
                    </div>
                    
                    <div id="csv-dropzone" class="border-2 border-dashed border-dark-600 rounded-xl p-8 text-center hover:border-accent-500 transition cursor-pointer bg-dark-900/50"
                         onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" accept=".csv" class="hidden" onchange="handleFileSelect(this)">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <div class="text-dark-300">Click to select CSV file</div>
                        <div class="text-sm text-dark-500">or drag and drop</div>
                    </div>
                    
                    <div id="file-name" class="text-center text-accent-400 hidden"></div>
                    
                    <div id="balance-file-section" class="hidden">
                        <div class="border-t border-dark-700 pt-4 mt-2">
                            <label class="label">
                                üìä Balance History (for cross-validation) 
                                <span class="text-dark-500 font-normal">- Optional</span>
                            </label>
                            <div class="border-2 border-dashed border-success-500/30 rounded-xl p-4 text-center hover:border-success-500 transition cursor-pointer bg-success-500/5"
                                 onclick="document.getElementById('balance-file-input').click()">
                                <input type="file" id="balance-file-input" accept=".csv" class="hidden" onchange="handleBalanceFileSelect(this)">
                                <div class="text-2xl mb-1">üìä</div>
                                <div class="text-dark-300 text-sm">Add Balance History for validation</div>
                            </div>
                            <div id="balance-file-name" class="text-center text-success-400 text-sm hidden"></div>
                        </div>
                    </div>
                    
                    <button type="submit" id="upload-btn" class="btn btn-primary w-full" disabled>
                        üì§ Upload & Import
                    </button>
                </form>

                <div class="mt-6 pt-6 border-t border-dark-700">
                    <h3 class="font-medium text-white mb-2">Or import from folder:</h3>
                    <p class="text-sm text-dark-400 mb-3">
                        Drop CSV files in: <code class="bg-dark-900 px-2 py-1 rounded text-accent-400">{{ imports_path }}</code>
                    </p>
                    <button onclick="bulkImport()" class="btn btn-secondary w-full">
                        üì• Import All from Folder
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <h2 class="text-xl font-bold text-white mb-4">üìã Format Instructions</h2>
                
                <div id="format-info-generic" class="format-info">
                    <h3 class="font-medium text-white mb-2">Generic CSV Format</h3>
                    <div class="bg-dark-900/50 rounded-xl p-4 font-mono text-sm overflow-x-auto text-dark-300">
                        <div class="text-dark-500">ticker,direction,entry_price,exit_price,size,trade_date,sl,tp,notes</div>
                        <div>SPY,long,475.50,478.00,100,2024-01-15,474.00,480.00,Strong pullback</div>
                    </div>
                    <div class="mt-3 text-sm text-dark-400">
                        Required: ticker, entry_price, exit_price. Optional: direction, size, sl (stop loss), tp (take profit), strategy, notes.
                    </div>
                </div>

                <div id="format-info-tv_order_history" class="format-info hidden">
                    <h3 class="font-medium text-white mb-2">‚≠ê TradingView - Order History</h3>
                    <div class="bg-success-500/10 border border-success-500/30 rounded-xl p-4 text-sm">
                        <p class="mb-2 text-success-400"><strong>‚úì Best format for multi-leg trades!</strong></p>
                        <ol class="list-decimal list-inside space-y-1 text-dark-300">
                            <li>Open TradingView Paper Trading panel</li>
                            <li>Go to "Order History" tab</li>
                            <li>Click the download button (‚Üì)</li>
                        </ol>
                    </div>
                </div>

                <div id="format-info-tv_balance_history" class="format-info hidden">
                    <h3 class="font-medium text-white mb-2">TradingView - Balance History</h3>
                    <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                        Export from Paper Trading ‚Üí Balance History ‚Üí Download
                    </div>
                </div>

                <div id="format-info-thinkorswim" class="format-info hidden">
                    <h3 class="font-medium text-white mb-2">TD Ameritrade ThinkOrSwim</h3>
                    <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                        Export from: Monitor ‚Üí Account Statement ‚Üí Trades ‚Üí Export
                    </div>
                </div>

                <div id="format-info-tradovate" class="format-info hidden">
                    <h3 class="font-medium text-white mb-2">Tradovate</h3>
                    <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                        Export from: Performance ‚Üí Trade History ‚Üí Download CSV
                    </div>
                </div>

                <div id="format-info-interactive_brokers" class="format-info hidden">
                    <h3 class="font-medium text-white mb-2">Interactive Brokers</h3>
                    <div class="bg-dark-900/50 rounded-xl p-4 text-sm text-dark-300">
                        Export from: Reports ‚Üí Flex Queries ‚Üí Trade Confirmations
                    </div>
                </div>

                <div class="mt-6 p-4 bg-accent-500/10 border border-accent-500/30 rounded-xl">
                    <div class="font-medium text-accent-400 mb-1">üß† AI Classification</div>
                    <p class="text-sm text-accent-300">
                        The AI will automatically classify each trade into Brooks-style setups.
                    </p>
                </div>
            </div>
        </div>

        {% if import_files %}
        <div class="card mt-6">
            <h2 class="text-xl font-bold text-white mb-4">üìÇ Files Ready to Import</h2>
            <div class="space-y-2">
                {% for f in import_files %}
                <div class="flex items-center justify-between p-3 bg-dark-900/50 rounded-xl border border-dark-700">
                    <span class="font-mono text-dark-200">{{ f.name }}</span>
                    <span class="text-dark-500 text-sm">{{ f.stat().st_size // 1024 }} KB</span>
                </div>
                {% endfor %}
            </div>
            <button onclick="bulkImport()" class="btn btn-primary mt-4">
                Import All ({{ import_files|length }} files)
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set datetime field to current time
function setNow(fieldId) {
    const now = new Date();
    // Format as YYYY-MM-DDTHH:MM:SS for datetime-local input
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const formatted = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    document.getElementById(fieldId).value = formatted;
}

// Validate trade form before submission
function validateTradeForm() {
    const entryTime = document.getElementById('entry_time').value;
    const exitTime = document.getElementById('exit_time').value;
    const entryPrice = parseFloat(document.querySelector('input[name="entry_price"]').value);
    const exitPrice = parseFloat(document.querySelector('input[name="exit_price"]').value);
    const stopLoss = document.querySelector('input[name="stop_loss"]').value;
    
    // Validate times if both are provided
    if (entryTime && exitTime) {
        const entry = new Date(entryTime);
        const exit = new Date(exitTime);
        if (exit < entry) {
            alert('Exit time must be after entry time');
            return false;
        }
    }
    
    // Validate prices are positive
    if (entryPrice <= 0) {
        alert('Entry price must be positive');
        return false;
    }
    if (exitPrice <= 0) {
        alert('Exit price must be positive');
        return false;
    }
    
    // Validate stop loss if provided
    if (stopLoss) {
        const sl = parseFloat(stopLoss);
        const direction = document.querySelector('select[name="direction"]').value;
        if (sl <= 0) {
            alert('Stop loss must be positive');
            return false;
        }
        // For long trades, stop should be below entry
        if (direction === 'long' && sl >= entryPrice) {
            if (!confirm('Warning: Stop loss is at or above entry price for a long trade. Continue?')) {
                return false;
            }
        }
        // For short trades, stop should be above entry
        if (direction === 'short' && sl <= entryPrice) {
            if (!confirm('Warning: Stop loss is at or below entry price for a short trade. Continue?')) {
                return false;
            }
        }
    }
    
    return true;
}

// Tab switching
function showTab(tab) {
    document.querySelectorAll('.trade-panel').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.trade-tab').forEach(t => {
        t.classList.remove('border-accent-500', 'text-accent-400');
        t.classList.add('border-transparent', 'text-dark-400');
    });
    
    document.getElementById('panel-' + tab).classList.remove('hidden');
    const tabEl = document.getElementById('tab-' + tab);
    tabEl.classList.add('border-accent-500', 'text-accent-400');
    tabEl.classList.remove('border-transparent', 'text-dark-400');

    // Persist tab in URL for refresh/back navigation
    try {
        const url = new URL(window.location.href);
        if (tab === 'import') url.searchParams.set('tab', 'import');
        else url.searchParams.delete('tab');
        window.history.replaceState({}, '', url);
    } catch (e) {}
}

// Initial tab: honor ?tab=import or #import
try {
    const url = new URL(window.location.href);
    const tab = url.searchParams.get('tab') || (window.location.hash || '').replace('#', '');
    if (tab === 'import') showTab('import');
} catch (e) {}

// ===== SINGLE TRADE FORM =====
const entryInput = document.querySelector('input[name="entry_price"]');
const exitInput = document.querySelector('input[name="exit_price"]');
const stopInput = document.querySelector('input[name="stop_loss"]');
const directionSelect = document.querySelector('select[name="direction"]');
const rPreview = document.getElementById('r-preview');
const riskPreview = document.getElementById('risk-preview');
const pnlPreview = document.getElementById('pnl-preview');
const rrPreview = document.getElementById('rr-preview');
const stopValidPreview = document.getElementById('stop-valid-preview');
const tpInput = document.querySelector('input[name="take_profit"]');

function calculateR() {
    const entry = parseFloat(entryInput.value);
    const exit = parseFloat(exitInput.value);
    const stop = parseFloat(stopInput.value);
    const direction = directionSelect.value;
    const tp = tpInput ? parseFloat(tpInput.value) : NaN;
    
    // P&L per share preview (no SL required)
    if (entry && exit && pnlPreview) {
        const pnlPerShare = direction === 'long' ? (exit - entry) : (entry - exit);
        pnlPreview.textContent = pnlPerShare.toFixed(4);
        pnlPreview.className = 'font-mono font-semibold ' + (pnlPerShare >= 0 ? 'positive' : 'negative');
    } else if (pnlPreview) {
        pnlPreview.textContent = '--';
        pnlPreview.className = 'font-mono font-semibold text-dark-300';
    }

    // Stop validity preview
    if (stopValidPreview) {
        if (!entry || !stop) {
            stopValidPreview.textContent = '--';
            stopValidPreview.className = 'font-mono font-semibold text-dark-300';
        } else {
            const ok = direction === 'long' ? stop < entry : stop > entry;
            stopValidPreview.textContent = ok ? 'OK' : 'CHECK';
            stopValidPreview.className = 'font-mono font-semibold ' + (ok ? 'positive' : 'negative');
        }
    }

    // Risk / share and RR to TP preview (needs SL; TP optional)
    if (entry && stop && riskPreview) {
        const riskPerShare = Math.abs(entry - stop);
        riskPreview.textContent = riskPerShare.toFixed(4);
        riskPreview.className = 'font-mono font-semibold ' + (riskPerShare > 0 ? 'text-dark-200' : 'negative');

        if (rrPreview) {
            if (tp && riskPerShare > 0) {
                const rewardPerShare = direction === 'long' ? (tp - entry) : (entry - tp);
                const rr = rewardPerShare / riskPerShare;
                if (Number.isFinite(rr)) {
                    rrPreview.textContent = rr.toFixed(2);
                    rrPreview.className = 'font-mono font-semibold ' + (rr >= 1 ? 'positive' : 'text-dark-200');
                } else {
                    rrPreview.textContent = '--';
                    rrPreview.className = 'font-mono font-semibold text-dark-300';
                }
            } else {
                rrPreview.textContent = '--';
                rrPreview.className = 'font-mono font-semibold text-dark-300';
            }
        }
    } else {
        if (riskPreview) {
            riskPreview.textContent = '--';
            riskPreview.className = 'font-mono font-semibold text-dark-300';
        }
        if (rrPreview) {
            rrPreview.textContent = '--';
            rrPreview.className = 'font-mono font-semibold text-dark-300';
        }
    }

    if (!entry || !exit || !stop) {
        rPreview.textContent = '--';
        rPreview.className = 'text-3xl font-mono font-bold text-dark-500';
        return;
    }
    
    let r;
    if (direction === 'long') {
        const risk = entry - stop;
        if (risk <= 0) {
            rPreview.textContent = 'Invalid stop';
            return;
        }
        r = (exit - entry) / risk;
    } else {
        const risk = stop - entry;
        if (risk <= 0) {
            rPreview.textContent = 'Invalid stop';
            return;
        }
        r = (entry - exit) / risk;
    }
    
    rPreview.textContent = r.toFixed(2) + 'R';
    rPreview.className = 'text-3xl font-mono font-bold ' + (r >= 0 ? 'positive' : 'negative');
}

entryInput.addEventListener('input', calculateR);
exitInput.addEventListener('input', calculateR);
stopInput.addEventListener('input', calculateR);
directionSelect.addEventListener('change', calculateR);
if (tpInput) tpInput.addEventListener('input', calculateR);

// Trade date is derived from entry/exit time, no separate field needed

// ===== BULK IMPORT =====
const fileInput = document.getElementById('file-input');
const fileName = document.getElementById('file-name');
const uploadBtn = document.getElementById('upload-btn');
const uploadForm = document.getElementById('upload-form');
const formatSelect = document.getElementById('format-select');
const balanceFileInput = document.getElementById('balance-file-input');
const balanceFileName = document.getElementById('balance-file-name');
const balanceFileSection = document.getElementById('balance-file-section');

// ===== AUTO-IMPORT (BROKER SELECTOR) =====
function updateAutoImportBroker() {
    const brokerSelect = document.getElementById('auto-import-broker');
    const hint = document.getElementById('auto-import-hint');
    const rhPanel = document.getElementById('auto-import-panel-robinhood');
    const ibkrPanel = document.getElementById('auto-import-panel-ibkr');
    const rhStatus = document.getElementById('rh-status');
    const ibkrStatus = document.getElementById('ibkr-status');

    if (!brokerSelect || !rhPanel || !ibkrPanel) return;
    const broker = brokerSelect.value || 'robinhood';

    const showRobinhood = broker === 'robinhood';
    rhPanel.classList.toggle('hidden', !showRobinhood);
    ibkrPanel.classList.toggle('hidden', showRobinhood);

    if (rhStatus) rhStatus.classList.toggle('hidden', !showRobinhood);
    if (ibkrStatus) ibkrStatus.classList.toggle('hidden', showRobinhood);

    if (hint) {
        hint.textContent = showRobinhood
            ? 'Robinhood: enter credentials, approve in app. MFA only if prompted.'
            : 'IBKR: uses Flex Web Service (read-only). Provide token/query, or set env vars.';
    }
}

// Initialize broker UI on load
updateAutoImportBroker();

checkRobinhoodSession();
checkIbkrStatus();

async function checkRobinhoodSession() {
    try {
        const response = await fetch('/api/robinhood/status');
        const data = await response.json();
        const loginPanel = document.getElementById('rh-login-form');
        const connectedPanel = document.getElementById('rh-connected');

        if (data.has_session) {
            const badge = document.getElementById('rh-status');
            if (badge) {
                const wasHidden = badge.classList.contains('hidden');
                badge.textContent = 'Session Stored';
                badge.className = 'badge bg-amber-500/20 text-amber-400 border-amber-500/30' + (wasHidden ? ' hidden' : '');
            }
            if (loginPanel) loginPanel.classList.add('hidden');
            if (connectedPanel) connectedPanel.classList.remove('hidden');
        } else {
            if (loginPanel) loginPanel.classList.remove('hidden');
            if (connectedPanel) connectedPanel.classList.add('hidden');
        }
    } catch (e) {}
}

async function checkIbkrStatus() {
    const badge = document.getElementById('ibkr-status');
    if (!badge) return;
    try {
        const response = await fetch('/api/ibkr/status');
        const data = await response.json();

        if (data.configured) {
            const wasHidden = badge.classList.contains('hidden');
            badge.textContent = 'Configured';
            badge.className = 'badge bg-success-500/20 text-success-400 border-success-500/30' + (wasHidden ? ' hidden' : '');
        } else if (data.has_token || data.has_query_id) {
            const wasHidden = badge.classList.contains('hidden');
            badge.textContent = 'Partial';
            badge.className = 'badge bg-amber-500/20 text-amber-400 border-amber-500/30' + (wasHidden ? ' hidden' : '');
        } else {
            const wasHidden = badge.classList.contains('hidden');
            badge.textContent = 'Not Configured';
            badge.className = 'badge bg-dark-700 text-dark-300 border-dark-600' + (wasHidden ? ' hidden' : '');
        }
    } catch (e) {
        // Leave as default if status check fails.
    }
}

async function importFromIbkrFlex() {
    showStartToast('IBKR import');

    const tokenEl = document.getElementById('ibkr-token');
    const queryEl = document.getElementById('ibkr-query-id');
    const daysEl = document.getElementById('ibkr-days');
    const tzEl = document.getElementById('ibkr-timezone');

    const token = tokenEl && tokenEl.value.trim() ? tokenEl.value.trim() : null;
    const query_id = queryEl && queryEl.value.trim() ? queryEl.value.trim() : null;
    const days_back = daysEl ? parseInt(daysEl.value) : 30;
    const input_timezone = tzEl ? tzEl.value : 'America/New_York';

    try {
        const response = await fetch('/api/ibkr/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token, query_id, days_back, input_timezone })
        });
        const data = await response.json();

        // Clear token field for safety
        if (tokenEl) tokenEl.value = '';

        if (data.error) {
            showToast('Error: ' + data.error, 'error');
            return;
        }

        const imported = data.imported || 0;
        const errors = data.errors || 0;
        const msg = (data.messages && data.messages.length) ? data.messages[0] : '';

        if (errors > 0 && imported === 0) {
            showToast(msg || 'IBKR import failed', 'error', 6000);
            return;
        }

        if (imported === 0) {
            showToast(msg || 'No new IBKR trades found', 'info', 5000);
            return;
        }

        showFinishToast('IBKR import', `${imported} trades`);
        setTimeout(() => window.location.reload(), 2000);
    } catch (err) {
        showToast('IBKR import failed: ' + err.message, 'error', 6000);
    }
}

function startRobinhoodConnect() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    if (!username || !password) {
        showToast('Please enter username and password', 'error');
        return;
    }
    document.getElementById('rh-instructions').classList.remove('hidden');
    importFromRobinhood();
}

async function importFromRobinhood() {
    const username = document.getElementById('rh-username').value;
    const password = document.getElementById('rh-password').value;
    const mfaEl = document.getElementById('rh-mfa');
    const mfa = mfaEl ? mfaEl.value : '';
    const days = document.getElementById('rh-days').value;
    
    try {
        const response = await fetch('/api/robinhood/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username, password, mfa_code: mfa || null, days_back: parseInt(days)
            })
        });
        const data = await response.json();
        document.getElementById('rh-instructions').classList.add('hidden');
        
        if (data.needs_device_approval) {
            showToast('Check Robinhood app to approve login', 'warning');
            return;
        }
        if (data.needs_mfa) {
            showToast('Enter MFA code and try again', 'warning');
            document.querySelector('#rh-login-form details').open = true;
            return;
        }
        if (data.error) {
            showToast('Error: ' + data.error, 'error');
        } else {
            showFinishToast('Robinhood import', `${data.imported} trades`);
            setTimeout(() => window.location.reload(), 2000);
        }
    } catch (err) {
        document.getElementById('rh-instructions').classList.add('hidden');
        showToast('Connection failed', 'error');
    }
}

async function importFromRobinhoodSession() {
    showStartToast('Robinhood import');
    const days = document.getElementById('rh-days').value;
    try {
        const response = await fetch('/api/robinhood/import-session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days_back: parseInt(days)})
        });
        const data = await response.json();
        if (data.error) showToast('Error: ' + data.error, 'error');
        else {
            showFinishToast('Robinhood import', `${data.imported} trades`);
            setTimeout(() => window.location.reload(), 2000);
        }
    } catch (err) {
        showToast('Import failed', 'error');
    }
}

async function disconnectRobinhood() {
    await fetch('/api/robinhood/disconnect', {method: 'POST'});
    const badge = document.getElementById('rh-status');
    if (badge) {
        const wasHidden = badge.classList.contains('hidden');
        badge.textContent = 'Not Connected';
        badge.className = 'badge bg-dark-700 text-dark-300 border-dark-600' + (wasHidden ? ' hidden' : '');
    }
    const loginPanel = document.getElementById('rh-login-form');
    const connectedPanel = document.getElementById('rh-connected');
    if (loginPanel) loginPanel.classList.remove('hidden');
    if (connectedPanel) connectedPanel.classList.add('hidden');

    // Clear sensitive fields
    const pw = document.getElementById('rh-password');
    const mfa = document.getElementById('rh-mfa');
    if (pw) pw.value = '';
    if (mfa) mfa.value = '';
    showToast('Disconnected');
}

function handleFileSelect(input) {
    if (input.files.length > 0) {
        fileName.textContent = input.files[0].name;
        fileName.classList.remove('hidden');
        uploadBtn.disabled = false;
        const name = input.files[0].name.toLowerCase();
        if (name.includes('order-history')) {
            formatSelect.value = 'tv_order_history';
            updateFormatInfo();
        } else if (name.includes('balance-history')) {
            formatSelect.value = 'tv_balance_history';
            updateFormatInfo();
        }
    }
}

function handleBalanceFileSelect(input) {
    if (input.files.length > 0) {
        balanceFileName.textContent = '‚úì ' + input.files[0].name;
        balanceFileName.classList.remove('hidden');
    }
}

function updateFormatInfo() {
    document.querySelectorAll('.format-info').forEach(el => el.classList.add('hidden'));
    const selected = formatSelect.value;
    const infoEl = document.getElementById('format-info-' + selected);
    if (infoEl) infoEl.classList.remove('hidden');
    
    // Show timezone selector for formats that include timestamps
    const timezoneSection = document.getElementById('timezone-section');
    const needsTimezone = (selected === 'tv_order_history' || selected === 'interactive_brokers');
    if (timezoneSection) timezoneSection.classList.toggle('hidden', !needsTimezone);

    // Balance-history cross-validation only applies to TradingView order history
    if (selected === 'tv_order_history') balanceFileSection.classList.remove('hidden');
    else balanceFileSection.classList.add('hidden');
}

formatSelect.addEventListener('change', updateFormatInfo);
updateFormatInfo();

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!fileInput.files.length) return;
    showStartToast('Importing trades');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('format', formatSelect.value);
    
    // Include timezone if TV order history format
    const timezoneSelect = document.getElementById('timezone-select');
    if (timezoneSelect && (formatSelect.value === 'tv_order_history' || formatSelect.value === 'interactive_brokers')) {
        formData.append('input_timezone', timezoneSelect.value);
    }
    
    if (balanceFileInput && balanceFileInput.files.length > 0) {
        formData.append('balance_file', balanceFileInput.files[0]);
    }
    try {
        const response = await fetch('/api/import-csv', {method: 'POST', body: formData});
        const data = await response.json();
        if (data.error) showToast('Error: ' + data.error, 'error');
        else {
            showFinishToast('Import', `${data.imported} trades`);
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (err) {
        showToast('Import failed', 'error');
    }
});

async function bulkImport() {
    showStartToast('Bulk import');
    try {
        const response = await fetch('/api/bulk-import', {method: 'POST'});
        const data = await response.json();
        showFinishToast('Bulk import', `${data.imported} trades`);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showToast('Import failed', 'error');
    }
}

// Drag and drop
const dropZone = document.getElementById('csv-dropzone');
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-accent-500');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-accent-500');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-accent-500');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.csv')) {
            fileInput.files = files;
            handleFileSelect(fileInput);
        }
    });
}
</script>
{% endblock %}
