{% extends "base.html" %}

{% block title %}Statistics - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <h1 class="text-3xl font-bold text-gray-900">Statistics & Edge Analysis</h1>

    <!-- Edge Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Strengths -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-green-600">ðŸ’ª Your Strengths</h2>
            {% if edge_analysis.strengths %}
            <ul class="space-y-2">
                {% for s in edge_analysis.strengths %}
                <li class="p-3 bg-green-50 rounded-lg text-green-800">âœ“ {{ s }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500">Add more trades to discover your strengths.</p>
            {% endif %}
        </div>

        <!-- Weaknesses -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-red-600">ðŸ“‰ Your Weaknesses</h2>
            {% if edge_analysis.weaknesses %}
            <ul class="space-y-2">
                {% for w in edge_analysis.weaknesses %}
                <li class="p-3 bg-red-50 rounded-lg text-red-800">âœ— {{ w }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500">No major weaknesses identified yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Coaching -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Stop Doing -->
        <div class="card border-l-4 border-red-500">
            <h2 class="text-xl font-bold mb-4">ðŸ›‘ Stop Doing</h2>
            {% if edge_analysis.stop_doing %}
            <ul class="space-y-2">
                {% for item in edge_analysis.stop_doing %}
                <li class="text-gray-700">â€¢ {{ item }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500">Keep trading to get recommendations.</p>
            {% endif %}
        </div>

        <!-- Double Down -->
        <div class="card border-l-4 border-green-500">
            <h2 class="text-xl font-bold mb-4">âœ… Double Down On</h2>
            {% if edge_analysis.double_down %}
            <ul class="space-y-2">
                {% for item in edge_analysis.double_down %}
                <li class="text-gray-700">â€¢ {{ item }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-500">Keep trading to get recommendations.</p>
            {% endif %}
        </div>
    </div>

    <!-- Coaching Focus -->
    {% if edge_analysis.coaching_focus %}
    <div class="card bg-blue-50 border border-blue-200">
        <h2 class="text-xl font-bold mb-4 text-blue-800">ðŸŽ¯ Coaching Focus</h2>
        <ul class="space-y-2">
            {% for item in edge_analysis.coaching_focus %}
            <li class="text-blue-700 text-lg">ðŸ“Œ {{ item }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Strategy Leaderboard -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">ðŸ“Š Strategy Leaderboard</h2>
        
        {% if strategy_stats %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-gray-500 text-sm border-b">
                        <th class="pb-3">Rank</th>
                        <th class="pb-3">Strategy</th>
                        <th class="pb-3">Category</th>
                        <th class="pb-3 text-right">Trades</th>
                        <th class="pb-3 text-right">Win Rate</th>
                        <th class="pb-3 text-right">Avg R</th>
                        <th class="pb-3 text-right">Expectancy</th>
                        <th class="pb-3 text-right">PF</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in strategy_stats %}
                    <tr class="border-b border-gray-100">
                        <td class="py-3 text-gray-500">#{{ loop.index }}</td>
                        <td class="py-3 font-medium">{{ stat.strategy_name }}</td>
                        <td class="py-3">
                            <span class="px-2 py-1 rounded text-xs
                                {% if stat.category == 'with_trend' %}bg-green-100 text-green-700
                                {% elif stat.category == 'countertrend' %}bg-red-100 text-red-700
                                {% elif stat.category == 'trading_range' %}bg-yellow-100 text-yellow-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ stat.category }}
                            </span>
                        </td>
                        <td class="py-3 text-right">{{ stat.trade_count }}</td>
                        <td class="py-3 text-right">{{ "%.0f"|format(stat.win_rate * 100) }}%</td>
                        <td class="py-3 text-right font-mono {% if stat.avg_r >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.2f"|format(stat.avg_r) }}
                        </td>
                        <td class="py-3 text-right font-mono font-bold {% if stat.expectancy >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.3f"|format(stat.expectancy) }}R
                        </td>
                        <td class="py-3 text-right">{{ "%.1f"|format(stat.profit_factor) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <p>No strategy data yet. Start logging trades!</p>
        </div>
        {% endif %}
    </div>

    <!-- Equity Curve -->
    {% if equity_data %}
    <div class="card">
        <h2 class="text-xl font-bold mb-4">ðŸ“ˆ Equity Curve (R)</h2>
        <div id="equity-chart" class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
            <canvas id="equityCanvas" width="800" height="250"></canvas>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if equity_data %}
<script>
// Simple equity curve drawing
const canvas = document.getElementById('equityCanvas');
const ctx = canvas.getContext('2d');
const data = {{ equity_data | tojson }};

if (data.length > 1) {
    const padding = 40;
    const width = canvas.width - padding * 2;
    const height = canvas.height - padding * 2;
    
    const rValues = data.map(d => d.r);
    const minR = Math.min(0, ...rValues);
    const maxR = Math.max(0, ...rValues);
    const range = maxR - minR || 1;
    
    // Draw axes
    ctx.strokeStyle = '#e5e7eb';
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height + padding);
    ctx.lineTo(width + padding, height + padding);
    ctx.stroke();
    
    // Draw zero line
    const zeroY = padding + height - ((0 - minR) / range * height);
    ctx.strokeStyle = '#9ca3af';
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(padding, zeroY);
    ctx.lineTo(width + padding, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Draw equity curve
    ctx.strokeStyle = rValues[rValues.length - 1] >= 0 ? '#16a34a' : '#dc2626';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    data.forEach((d, i) => {
        const x = padding + (i / (data.length - 1)) * width;
        const y = padding + height - ((d.r - minR) / range * height);
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
    
    // Fill area
    ctx.lineTo(width + padding, zeroY);
    ctx.lineTo(padding, zeroY);
    ctx.closePath();
    ctx.fillStyle = rValues[rValues.length - 1] >= 0 ? 'rgba(22, 163, 74, 0.1)' : 'rgba(220, 38, 38, 0.1)';
    ctx.fill();
    
    // Labels
    ctx.fillStyle = '#374151';
    ctx.font = '12px system-ui';
    ctx.fillText(`${maxR.toFixed(1)}R`, 5, padding + 5);
    ctx.fillText(`${minR.toFixed(1)}R`, 5, height + padding);
    ctx.fillText(`Current: ${rValues[rValues.length - 1].toFixed(2)}R`, width - 60, padding - 10);
}
</script>
{% endif %}
{% endblock %}
