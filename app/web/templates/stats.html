{% extends "base.html" %}

{% block title %}Statistics - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
            Statistics & Edge Analysis
        </h1>
        <p class="text-dark-400 text-sm mt-1">Analyze your trading performance and edge</p>
    </div>

    <!-- Portfolio Overview -->
    {% if portfolio_stats %}
    <div class="card bg-gradient-to-r from-dark-800 to-dark-700">
        <h2 class="text-xl font-bold mb-4 text-white">Portfolio Overview</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <div class="text-center">
                <div class="text-2xl font-bold {% if total_pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                    ${{ "%.0f"|format(total_pnl_usd) }}
                </div>
                <div class="text-xs text-dark-400">Total P&L</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold {% if portfolio_stats.expectancy >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "%.2f"|format(portfolio_stats.expectancy) }}R
                </div>
                <div class="text-xs text-dark-400">Expectancy</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold {% if portfolio_stats.profit_factor >= 1 %}positive{% else %}negative{% endif %}">
                    {{ "%.2f"|format(portfolio_stats.profit_factor) }}
                </div>
                <div class="text-xs text-dark-400">Profit Factor</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold negative">
                    -{{ "%.2f"|format(portfolio_stats.max_drawdown_r) }}R
                </div>
                <div class="text-xs text-dark-400">Max Drawdown</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-white">
                    {{ "%.0f"|format(portfolio_stats.avg_trade_duration_minutes) }}m
                </div>
                <div class="text-xs text-dark-400">Avg Duration</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold {% if portfolio_stats.recent_20_avg_r >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "%.2f"|format(portfolio_stats.recent_20_avg_r) }}R
                </div>
                <div class="text-xs text-dark-400">Last 20 Avg</div>
            </div>
        </div>
        
        <!-- Second row of metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-4 pt-4 border-t border-dark-600/50">
            <div class="text-center">
                <div class="text-lg font-semibold positive">{{ "%.2f"|format(portfolio_stats.avg_winner_r) }}R</div>
                <div class="text-xs text-dark-400">Avg Winner</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold negative">{{ "%.2f"|format(portfolio_stats.avg_loser_r) }}R</div>
                <div class="text-xs text-dark-400">Avg Loser</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold positive">+{{ "%.2f"|format(portfolio_stats.largest_winner_r) }}R</div>
                <div class="text-xs text-dark-400">Best Trade</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold negative">{{ "%.2f"|format(portfolio_stats.largest_loser_r) }}R</div>
                <div class="text-xs text-dark-400">Worst Trade</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-white">{{ portfolio_stats.max_win_streak }}</div>
                <div class="text-xs text-dark-400">Max Win Streak</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-white">{{ portfolio_stats.max_loss_streak }}</div>
                <div class="text-xs text-dark-400">Max Loss Streak</div>
            </div>
        </div>
        
        {% if portfolio_stats.best_time_of_day or portfolio_stats.best_day_of_week %}
        <div class="mt-4 pt-4 border-t border-dark-600/50 flex flex-wrap gap-4">
            {% if portfolio_stats.best_time_of_day %}
            <div class="text-sm text-dark-300">
                Best time: <span class="text-accent-400 font-medium">{{ portfolio_stats.best_time_of_day }}</span>
            </div>
            {% endif %}
            {% if portfolio_stats.best_day_of_week %}
            <div class="text-sm text-dark-300">
                Best day: <span class="text-accent-400 font-medium">{{ portfolio_stats.best_day_of_week }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Edge Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Strengths -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-success-400">ðŸ’ª Your Strengths</h2>
            {% if edge_analysis.strengths %}
            <ul class="space-y-2">
                {% for s in edge_analysis.strengths %}
                <li class="p-3 bg-success-500/10 border border-success-500/30 rounded-xl text-success-300">âœ“ {{ s }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-dark-500">Add more trades to discover your strengths.</p>
            {% endif %}
        </div>

        <!-- Weaknesses -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-danger-400">ðŸ“‰ Your Weaknesses</h2>
            {% if edge_analysis.weaknesses %}
            <ul class="space-y-2">
                {% for w in edge_analysis.weaknesses %}
                <li class="p-3 bg-danger-500/10 border border-danger-500/30 rounded-xl text-danger-300">âœ— {{ w }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-dark-500">No major weaknesses identified yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Coaching -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Stop Doing -->
        <div class="card border-l-4 border-danger-500">
            <h2 class="text-xl font-bold mb-4 text-white">ðŸ›‘ Stop Doing</h2>
            {% if edge_analysis.stop_doing %}
            <ul class="space-y-2">
                {% for item in edge_analysis.stop_doing %}
                <li class="text-dark-300">â€¢ {{ item }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-dark-500">Keep trading to get recommendations.</p>
            {% endif %}
        </div>

        <!-- Double Down -->
        <div class="card border-l-4 border-success-500">
            <h2 class="text-xl font-bold mb-4 text-white">âœ… Double Down On</h2>
            {% if edge_analysis.double_down %}
            <ul class="space-y-2">
                {% for item in edge_analysis.double_down %}
                <li class="text-dark-300">â€¢ {{ item }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-dark-500">Keep trading to get recommendations.</p>
            {% endif %}
        </div>
    </div>

    <!-- Coaching Focus -->
    {% if edge_analysis.coaching_focus %}
    <div class="card bg-accent-500/10 border border-accent-500/30">
        <h2 class="text-xl font-bold mb-4 text-accent-400">ðŸŽ¯ Coaching Focus</h2>
        <ul class="space-y-2">
            {% for item in edge_analysis.coaching_focus %}
            <li class="text-accent-300 text-lg">ðŸ“Œ {{ item }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Strategy Leaderboard -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4 text-white">ðŸ“Š Strategy Leaderboard</h2>
        
        {% if strategy_stats %}
        <div class="overflow-x-auto">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Strategy</th>
                        <th>Category</th>
                        <th class="text-right">Trades</th>
                        <th class="text-right">Win Rate</th>
                        <th class="text-right">Avg R</th>
                        <th class="text-right">Avg W</th>
                        <th class="text-right">Avg L</th>
                        <th class="text-right">Expectancy</th>
                        <th class="text-right">PF</th>
                        <th class="text-right">Last 20</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in strategy_stats %}
                    <tr>
                        <td class="text-dark-500">#{{ loop.index }}</td>
                        <td class="font-medium text-white">{{ stat.strategy_name }}</td>
                        <td>
                            <span class="badge
                                {% if stat.category == 'with_trend' %}badge-success
                                {% elif stat.category == 'countertrend' %}bg-danger-500/20 text-danger-400 border border-danger-500/30
                                {% elif stat.category == 'trading_range' %}badge-warning
                                {% else %}bg-dark-700 text-dark-300 border-dark-600{% endif %}">
                                {{ stat.category }}
                            </span>
                        </td>
                        <td class="text-right text-dark-200">{{ stat.trade_count }}</td>
                        <td class="text-right text-dark-200">{{ "%.0f"|format(stat.win_rate * 100) }}%</td>
                        <td class="text-right font-mono {% if stat.avg_r >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.2f"|format(stat.avg_r) }}
                        </td>
                        <td class="text-right font-mono positive">+{{ "%.2f"|format(stat.avg_winner_r) }}</td>
                        <td class="text-right font-mono negative">{{ "%.2f"|format(stat.avg_loser_r) }}</td>
                        <td class="text-right font-mono font-bold {% if stat.expectancy >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.3f"|format(stat.expectancy) }}R
                        </td>
                        <td class="text-right text-dark-200">{{ "%.1f"|format(stat.profit_factor) }}</td>
                        <td class="text-right font-mono {% if stat.recent_20_performance >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.2f"|format(stat.recent_20_performance) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-dark-500">
            <p>No strategy data yet. Start logging trades!</p>
        </div>
        {% endif %}
    </div>

    <!-- Equity Curve -->
    {% if equity_data %}
    <div class="card">
        <h2 class="text-xl font-bold mb-4 text-white">ðŸ“ˆ Equity Curve (R)</h2>
        <div id="equity-chart" class="h-64 bg-dark-900/50 rounded-xl flex items-center justify-center">
            <canvas id="equityCanvas" width="800" height="250"></canvas>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if equity_data %}
<script>
// Simple equity curve drawing
const canvas = document.getElementById('equityCanvas');
const ctx = canvas.getContext('2d');
const data = {{ equity_data | tojson }};

// Check for dark mode
const isDark = document.documentElement.classList.contains('dark');
const textColor = isDark ? '#94a3b8' : '#475569';
const gridColor = isDark ? '#334155' : '#e2e8f0';

if (data.length > 1) {
    const padding = 40;
    const width = canvas.width - padding * 2;
    const height = canvas.height - padding * 2;
    
    const rValues = data.map(d => d.r);
    const minR = Math.min(0, ...rValues);
    const maxR = Math.max(0, ...rValues);
    const range = maxR - minR || 1;
    
    // Draw axes
    ctx.strokeStyle = gridColor;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height + padding);
    ctx.lineTo(width + padding, height + padding);
    ctx.stroke();
    
    // Draw zero line
    const zeroY = padding + height - ((0 - minR) / range * height);
    ctx.strokeStyle = textColor;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(padding, zeroY);
    ctx.lineTo(width + padding, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Draw equity curve
    ctx.strokeStyle = rValues[rValues.length - 1] >= 0 ? '#4ade80' : '#f87171';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    data.forEach((d, i) => {
        const x = padding + (i / (data.length - 1)) * width;
        const y = padding + height - ((d.r - minR) / range * height);
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
    
    // Fill area
    ctx.lineTo(width + padding, zeroY);
    ctx.lineTo(padding, zeroY);
    ctx.closePath();
    ctx.fillStyle = rValues[rValues.length - 1] >= 0 ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)';
    ctx.fill();
    
    // Labels
    ctx.fillStyle = textColor;
    ctx.font = '12px system-ui';
    ctx.fillText(`${maxR.toFixed(1)}R`, 5, padding + 5);
    ctx.fillText(`${minR.toFixed(1)}R`, 5, height + padding);
    ctx.fillText(`Current: ${rValues[rValues.length - 1].toFixed(2)}R`, width - 60, padding - 10);
}
</script>
{% endif %}
{% endblock %}
