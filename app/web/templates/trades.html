{% extends "base.html" %}

{% block title %}Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
                Trade Journal
            </h1>
            <p class="text-dark-400 text-sm mt-1">Track and review your trades</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
            <button onclick="recalculateMetrics()" class="btn btn-secondary">üîÑ Recalculate</button>
            <button onclick="reclassifyTrades()" class="btn btn-secondary">üß† Reclassify</button>
            <button onclick="deleteAllTrades()" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">üóëÔ∏è Delete All</button>
        </div>
    </div>

    <!-- Stats Summary -->
    {% if trades %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="stat-card">
            <div class="stat-value">{{ trades | length }}</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'win') | list | length }}
            </div>
            <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
            <div class="stat-value negative">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'loss') | list | length }}
            </div>
            <div class="stat-label">Losses</div>
        </div>
        <div class="stat-card">
            {% set total_pnl = trades | sum(attribute='pnl_dollars') if trades else 0 %}
            <div class="stat-value {% if total_pnl >= 0 %}positive{% else %}negative{% endif %}">
                {{ "+" if total_pnl > 0 else "" }}${{ "%.2f"|format(total_pnl or 0) }}
            </div>
            <div class="stat-label">Total P&L</div>
        </div>
    </div>
    {% endif %}

    <!-- Trades Table -->
    <div class="card overflow-hidden">
        {% if trades %}
        <div class="overflow-x-auto">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th class="rounded-tl-xl">ID</th>
                        <th>Exit Time</th>
                        <th>Ticker</th>
                        <th>Dir</th>
                        <th>Shares</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>P&L</th>
                        <th>R</th>
                        <th>Duration</th>
                        <th>Result</th>
                        <th>Strategy</th>
                        <th class="rounded-tr-xl">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr class="group">
                        <td class="text-dark-500 text-sm">#{{ trade.id }}</td>
                        <td class="text-sm font-mono text-dark-400">
                            {% if trade.exit_time %}
                                {{ trade.exit_time.strftime('%m/%d %H:%M') }}
                            {% else %}
                                {{ trade.trade_date }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="font-bold text-white">{{ trade.ticker }}</span>
                        </td>
                        <td>
                            {% if trade.direction.value == 'long' %}
                                <span class="badge badge-success">LONG</span>
                            {% else %}
                                <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">SHORT</span>
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">{{ "%.0f"|format(trade.size) if trade.size else '-' }}</td>
                        <td class="font-mono text-sm">
                            {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                <span class="text-white">${{ "%.2f"|format(trade.entry_price / trade.currency_rate) }}</span>
                                <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.entry_price) }}</span>
                            {% else %}
                                ${{ "%.4f"|format(trade.entry_price) }}
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">
                            {% if trade.exit_price %}
                                {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                    <span class="text-white">${{ "%.2f"|format(trade.exit_price / trade.currency_rate) }}</span>
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.exit_price) }}</span>
                                {% else %}
                                    ${{ "%.4f"|format(trade.exit_price) }}
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.pnl_dollars and trade.pnl_dollars >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.pnl_dollars %}
                                {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                    <span class="text-inherit">${{ "%.2f"|format(trade.pnl_dollars / trade.currency_rate) }}</span>
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }}</span>
                                {% else %}
                                    {{ "+" if trade.pnl_dollars > 0 else "" }}${{ "%.2f"|format(trade.pnl_dollars) }}
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                        </td>
                        <td class="text-sm text-dark-400 font-mono">
                            {{ trade.duration_display }}
                        </td>
                        <td>
                            {% if trade.outcome %}
                                {% if trade.outcome.value == 'win' %}
                                    <span class="win">WIN</span>
                                {% elif trade.outcome.value == 'loss' %}
                                    <span class="loss">LOSS</span>
                                {% else %}
                                    <span class="breakeven">B/E</span>
                                {% endif %}
                            {% else %}
                                <span class="text-dark-500">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-dark-700 text-dark-300 border-dark-600">
                                {{ trade.strategy.name if trade.strategy else 'unclassified' }}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center space-x-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                <button onclick="openEditModal({{ trade.id }}, {{ trade.size or 0 }}, {{ trade.entry_price }}, {{ trade.exit_price or 0 }}, {{ trade.stop_price or 0 }}, '{{ trade.currency or "USD" }}', {{ trade.currency_rate or 1.0 }}, '{{ trade.entry_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.entry_time else '' }}', '{{ trade.exit_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.exit_time else '' }}')" 
                                        class="btn btn-ghost p-2 text-sm" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <a href="/trades/{{ trade.id }}" class="btn btn-ghost p-2 text-sm text-accent-400" title="Review">
                                    üëÅÔ∏è
                                </a>
                                <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost p-2 text-sm text-danger-400" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl font-semibold text-white mb-2">No trades yet</h3>
            <p class="text-dark-400 mb-6">Start tracking your trades to get AI-powered coaching</p>
            <div class="flex justify-center gap-4">
                <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
                <a href="/import" class="btn btn-secondary">üì• Import CSV</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Trade Modal -->
<div id="edit-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="card w-full max-w-lg animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white">Edit Trade #<span id="edit-trade-id"></span></h3>
                <p id="edit-date-display" class="text-sm text-dark-400"></p>
            </div>
            <button onclick="closeEditModal()" class="btn btn-ghost text-2xl p-2">&times;</button>
        </div>
        
        <form id="edit-form" class="space-y-4">
            <input type="hidden" id="edit-id">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Time</label>
                    <input type="datetime-local" id="edit-entry-time" step="1" class="input text-sm">
                </div>
                <div>
                    <label class="label">Exit Time</label>
                    <input type="datetime-local" id="edit-exit-time" step="1" class="input text-sm">
                </div>
            </div>

            <div>
                <label class="label">Shares</label>
                <input type="number" id="edit-shares" step="1" min="1" class="input">
            </div>
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Entry Price</label>
                    <input type="number" id="edit-entry" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Exit Price</label>
                    <input type="number" id="edit-exit" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Stop Price</label>
                    <input type="number" id="edit-stop" step="0.0001" min="0" class="input">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Currency</label>
                    <select id="edit-currency" class="select">
                        <option value="USD">USD ($)</option>
                        <option value="HKD">HKD (HK$)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="JPY">JPY (¬•)</option>
                        <option value="CNY">CNY (¬•)</option>
                        <option value="CAD">CAD (C$)</option>
                        <option value="AUD">AUD (A$)</option>
                    </select>
                </div>
                <div>
                    <label class="label">Rate to USD</label>
                    <div class="flex space-x-2">
                        <input type="number" id="edit-rate" step="0.0001" min="0" class="input flex-1">
                        <button type="button" onclick="fetchHistoricalRate()" class="btn btn-secondary">üîÑ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-dark-700">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTradeId = null;
let currentTradeDate = null;

function openEditModal(id, shares, entry, exit, stop, currency, rate, entryTime, exitTime) {
    currentTradeId = id;
    currentTradeDate = exitTime || entryTime;
    
    document.getElementById('edit-trade-id').textContent = id;
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-shares').value = shares;
    document.getElementById('edit-entry').value = entry;
    document.getElementById('edit-exit').value = exit;
    document.getElementById('edit-stop').value = stop;
    document.getElementById('edit-currency').value = currency || 'USD';
    document.getElementById('edit-rate').value = rate;
    
    if (entryTime) document.getElementById('edit-entry-time').value = entryTime;
    if (exitTime) document.getElementById('edit-exit-time').value = exitTime;
    
    document.getElementById('edit-date-display').textContent = 
        currentTradeDate ? `Trade date: ${currentTradeDate.split('T')[0]}` : '';
    
    document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    currentTradeId = null;
}

async function fetchHistoricalRate() {
    const currency = document.getElementById('edit-currency').value;
    if (currency === 'USD') {
        document.getElementById('edit-rate').value = 1.0;
        return;
    }
    
    const date = currentTradeDate ? currentTradeDate.split('T')[0] : new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/api/exchange-rate?currency=${currency}&date=${date}`);
        const data = await response.json();
        
        if (data.rate) {
            document.getElementById('edit-rate').value = data.rate;
            showToast(`Rate fetched: 1 USD = ${data.rate} ${currency}`);
        } else {
            showToast('Could not fetch rate', 'error');
        }
    } catch (err) {
        showToast('Error fetching rate', 'error');
    }
}

document.getElementById('edit-currency').addEventListener('change', fetchHistoricalRate);

document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('edit-id').value;
    const data = {
        size: parseFloat(document.getElementById('edit-shares').value),
        entry_price: parseFloat(document.getElementById('edit-entry').value),
        exit_price: parseFloat(document.getElementById('edit-exit').value),
        stop_price: parseFloat(document.getElementById('edit-stop').value),
        currency: document.getElementById('edit-currency').value,
        currency_rate: parseFloat(document.getElementById('edit-rate').value),
        entry_time: document.getElementById('edit-entry-time').value || null,
        exit_time: document.getElementById('edit-exit-time').value || null,
    };
    
    try {
        const response = await fetch(`/api/trades/${id}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('Trade updated!');
            closeEditModal();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to update trade', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
});

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    
    try {
        const response = await fetch(`/api/trades/${id}`, { method: 'DELETE' });
        if (response.ok) {
            showToast('Trade deleted');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (err) {
        showToast('Error deleting trade', 'error');
    }
}

async function recalculateMetrics() {
    showStartToast('Recalculating metrics');
    try {
        const response = await fetch('/api/recalculate-metrics', { method: 'POST' });
        const data = await response.json();
        showFinishToast('Metrics recalculated', `${data.count || 'all'} trades updated`);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showToast('Recalculation failed', 'error');
    }
}

async function reclassifyTrades() {
    showStartToast('AI reclassification');
    try {
        const response = await fetch('/api/reclassify-trades', { method: 'POST' });
        const data = await response.json();
        showFinishToast('AI reclassification', `${data.count || 'all'} trades classified`);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showToast('Reclassification failed', 'error');
    }
}

async function deleteAllTrades() {
    if (!confirm('‚ö†Ô∏è Delete ALL trades? This cannot be undone!')) return;
    if (!confirm('Are you REALLY sure? This will delete your entire trade history!')) return;
    
    showStartToast('Deleting all trades');
    try {
        await fetch('/api/trades', { method: 'DELETE' });
        showFinishToast('All trades deleted');
        setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
        showToast('Delete failed', 'error');
    }
}
</script>
{% endblock %}
