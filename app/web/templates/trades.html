{% extends "base.html" %}

{% block title %}Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
                Trade Journal
            </h1>
            <p class="text-dark-400 text-sm mt-1">Track and review your trades</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
            <button onclick="recalculateMetrics()" class="btn btn-secondary">üîÑ Recalculate</button>
            <button onclick="analyzeAllTrades()" class="btn btn-secondary">üß† Analyze All</button>
            <button onclick="deleteAllTrades()" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">üóëÔ∏è Delete All</button>
        </div>
    </div>

    <!-- Stats Summary -->
    {% if trades %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="stat-card">
            <div class="stat-value">{{ trades | length }}</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'win') | list | length }}
            </div>
            <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
            <div class="stat-value negative">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'loss') | list | length }}
            </div>
            <div class="stat-label">Losses</div>
        </div>
        <div class="stat-card">
            {% set ns = namespace(total_pnl_usd=0) %}
            {% for trade in trades %}
                {% if trade.pnl_usd %}
                    {% set ns.total_pnl_usd = ns.total_pnl_usd + trade.pnl_usd %}
                {% endif %}
            {% endfor %}
            <div class="stat-value {% if ns.total_pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                {{ "+" if ns.total_pnl_usd > 0 else "" }}${{ "%.2f"|format(ns.total_pnl_usd) }}
            </div>
            <div class="stat-label">Total P&L (USD)</div>
        </div>
    </div>
    {% endif %}

    <!-- Trades Table -->
    <div class="card overflow-hidden">
        {% if trades %}
        <!-- Legend -->
        <div class="flex items-center justify-between px-4 py-2 border-b border-dark-700/50 text-sm">
            <div class="flex items-center gap-4 text-dark-400">
                <span class="flex items-center gap-1">
                    <span class="text-accent-400">ü§ñ</span> AI Reviewed
                </span>
                <span class="flex items-center gap-1">
                    <span class="text-dark-600">‚óã</span> Pending Review
                </span>
            </div>
            <span class="text-dark-500">
                {{ trades|selectattr('cached_review')|list|length }}/{{ trades|length }} reviewed
            </span>
        </div>
        <div class="overflow-x-auto">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th class="rounded-tl-xl">ID</th>
                        <th>Exit Time</th>
                        <th>Ticker</th>
                        <th>Dir</th>
                        <th>Shares</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>P&L</th>
                        <th>R</th>
                        <th>Duration</th>
                        <th>Result</th>
                        <th>Strategy</th>
                        <th class="rounded-tr-xl">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr class="group {% if not trade.cached_review %}bg-dark-800/30{% endif %}">
                        <td class="text-dark-500 text-sm">
                            <span class="flex items-center gap-1">
                                #{{ trade.trade_number or trade.id }}
                                {% if trade.cached_review and trade.review_generated_at %}
                                <span class="text-accent-400 text-xs" title="AI Reviewed on {{ trade.review_generated_at.strftime('%Y-%m-%d %H:%M') }}">ü§ñ</span>
                                {% else %}
                                <span class="text-dark-600 text-xs" title="Not yet reviewed">‚óã</span>
                                {% endif %}
                            </span>
                        </td>
                        <td class="text-sm font-mono text-dark-400">
                            {% if trade.exit_time %}
                                {{ trade.exit_time.strftime('%m/%d %H:%M') }}
                                {% if trade.input_timezone and trade.input_timezone != trade.market_timezone %}
                                <div class="text-xs text-dark-500">
                                    ({{ trade.exit_time_local.strftime('%H:%M') if trade.exit_time_local else '' }} {{ trade.input_timezone.split('/')[-1] | replace('_', ' ') }})
                                </div>
                                {% endif %}
                            {% else %}
                                {{ trade.trade_date }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="font-bold text-white">{{ trade.ticker }}</span>
                        </td>
                        <td>
                            {% if trade.direction.value == 'long' %}
                                <span class="badge badge-success">LONG</span>
                            {% else %}
                                <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">SHORT</span>
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">{{ "%.0f"|format(trade.size) if trade.size else '-' }}</td>
                        <td class="font-mono text-sm">
                            {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                <span class="text-white">${{ "%.2f"|format(trade.entry_price / trade.currency_rate) }}</span>
                                <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.entry_price) }}</span>
                            {% else %}
                                ${{ "%.4f"|format(trade.entry_price) }}
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">
                            {% if trade.exit_price %}
                                {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                    <span class="text-white">${{ "%.2f"|format(trade.exit_price / trade.currency_rate) }}</span>
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.exit_price) }}</span>
                                {% else %}
                                    ${{ "%.4f"|format(trade.exit_price) }}
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.pnl_usd and trade.pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.pnl_usd %}
                                {{ "+" if trade.pnl_usd > 0 else "" }}${{ "%.2f"|format(trade.pnl_usd) }}
                                {% if trade.currency and trade.currency != 'USD' %}
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }}</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                        </td>
                        <td class="text-sm text-dark-400 font-mono">
                            {{ trade.duration_display }}
                        </td>
                        <td>
                            {% if trade.outcome %}
                                {% if trade.outcome.value == 'win' %}
                                    <span class="win">WIN</span>
                                {% elif trade.outcome.value == 'loss' %}
                                    <span class="loss">LOSS</span>
                                {% else %}
                                    <span class="breakeven">B/E</span>
                                {% endif %}
                            {% else %}
                                <span class="text-dark-500">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-dark-700 text-dark-300 border-dark-600">
                                {{ trade.strategy.name if trade.strategy else 'unclassified' }}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center space-x-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                <button onclick="openEditModal({{ trade.id }}, '{{ trade.ticker }}', {{ trade.size or 0 }}, {{ trade.entry_price }}, {{ trade.exit_price or 0 }}, {{ trade.stop_loss or trade.stop_price or 0 }}, {{ trade.take_profit or trade.target_price or 0 }}, '{{ trade.currency or "USD" }}', {{ trade.currency_rate or 1.0 }}, '{{ trade.entry_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.entry_time else '' }}', '{{ trade.exit_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.exit_time else '' }}', '{{ trade.timeframe or "5m" }}')"
                                        class="btn btn-ghost p-2 text-sm" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <a href="/trades/{{ trade.id }}" class="btn btn-ghost p-2 text-sm text-accent-400" title="Review">
                                    üëÅÔ∏è
                                </a>
                                <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost p-2 text-sm text-danger-400" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl font-semibold text-white mb-2">No trades yet</h3>
            <p class="text-dark-400 mb-6">Start tracking your trades to get AI-powered coaching</p>
            <div class="flex justify-center gap-4">
                <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
                <a href="/import" class="btn btn-secondary">üì• Import CSV</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Trade Modal -->
<div id="edit-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="card w-full max-w-lg animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white">Edit Trade #<span id="edit-trade-id"></span></h3>
                <p id="edit-date-display" class="text-sm text-dark-400"></p>
            </div>
            <button onclick="closeEditModal()" class="btn btn-ghost text-2xl p-2">&times;</button>
        </div>
        
        <form id="edit-form" class="space-y-4">
            <input type="hidden" id="edit-id">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Ticker</label>
                    <input type="text" id="edit-ticker" class="input text-sm uppercase" placeholder="SPY">
                </div>
                <div>
                    <label class="label">Shares</label>
                    <input type="number" id="edit-shares" step="1" min="1" class="input">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Time</label>
                    <input type="datetime-local" id="edit-entry-time" step="1" class="input text-sm">
                </div>
                <div>
                    <label class="label">Exit Time</label>
                    <input type="datetime-local" id="edit-exit-time" step="1" class="input text-sm">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Entry Price</label>
                    <input type="number" id="edit-entry" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Exit Price</label>
                    <input type="number" id="edit-exit" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Stop Loss (SL)</label>
                    <input type="number" id="edit-sl" step="0.0001" min="0" class="input" placeholder="Where trade is wrong">
                </div>
                <div>
                    <label class="label">Take Profit (TP)</label>
                    <input type="number" id="edit-tp" step="0.0001" min="0" class="input" placeholder="Target exit">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Timeframe</label>
                    <select id="edit-timeframe" class="select">
                        <option value="5m">5 min (Scalp)</option>
                        <option value="2h">2 hour (Swing)</option>
                        <option value="1d">Daily (Position)</option>
                    </select>
                    <p class="text-xs text-dark-500 mt-1">Used for AI context data</p>
                </div>
                <div>
                    <label class="label">Currency</label>
                    <select id="edit-currency" class="select">
                        <option value="USD">USD ($)</option>
                        <option value="HKD">HKD (HK$)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="JPY">JPY (¬•)</option>
                        <option value="CNY">CNY (¬•)</option>
                        <option value="CAD">CAD (C$)</option>
                        <option value="AUD">AUD (A$)</option>
                    </select>
                </div>
                <div>
                    <label class="label">Rate to USD</label>
                    <div class="flex space-x-2">
                        <input type="number" id="edit-rate" step="0.0001" min="0" class="input flex-1">
                        <button type="button" onclick="fetchHistoricalRate()" class="btn btn-secondary">üîÑ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-dark-700">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTradeId = null;
let currentTradeDate = null;

function openEditModal(id, ticker, shares, entry, exit, sl, tp, currency, rate, entryTime, exitTime, timeframe) {
    currentTradeId = id;
    currentTradeDate = exitTime || entryTime;
    
    document.getElementById('edit-trade-id').textContent = id;
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-ticker').value = ticker || '';
    document.getElementById('edit-shares').value = shares;
    document.getElementById('edit-entry').value = entry;
    document.getElementById('edit-exit').value = exit;
    document.getElementById('edit-sl').value = sl || '';
    document.getElementById('edit-tp').value = tp || '';
    document.getElementById('edit-currency').value = currency || 'USD';
    document.getElementById('edit-rate').value = rate;
    document.getElementById('edit-timeframe').value = timeframe || '5m';

    if (entryTime) document.getElementById('edit-entry-time').value = entryTime;
    if (exitTime) document.getElementById('edit-exit-time').value = exitTime;
    
    document.getElementById('edit-date-display').textContent = 
        currentTradeDate ? `Trade date: ${currentTradeDate.split('T')[0]}` : '';
    
    document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    currentTradeId = null;
}

async function fetchHistoricalRate() {
    const currency = document.getElementById('edit-currency').value;
    if (currency === 'USD') {
        document.getElementById('edit-rate').value = 1.0;
        return;
    }
    
    const date = currentTradeDate ? currentTradeDate.split('T')[0] : new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/api/exchange-rate?currency=${currency}&date=${date}`);
        const data = await response.json();
        
        if (data.rate) {
            document.getElementById('edit-rate').value = data.rate;
            showToast(`Rate fetched: 1 USD = ${data.rate} ${currency}`);
        } else {
            showToast('Could not fetch rate', 'error');
        }
    } catch (err) {
        showToast('Error fetching rate', 'error');
    }
}

document.getElementById('edit-currency').addEventListener('change', fetchHistoricalRate);

document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('edit-id').value;
    const slValue = document.getElementById('edit-sl').value;
    const tpValue = document.getElementById('edit-tp').value;
    
    const data = {
        ticker: document.getElementById('edit-ticker').value.toUpperCase(),
        size: parseFloat(document.getElementById('edit-shares').value),
        entry_price: parseFloat(document.getElementById('edit-entry').value),
        exit_price: parseFloat(document.getElementById('edit-exit').value),
        stop_loss: slValue ? parseFloat(slValue) : null,
        take_profit: tpValue ? parseFloat(tpValue) : null,
        currency: document.getElementById('edit-currency').value,
        currency_rate: parseFloat(document.getElementById('edit-rate').value),
        entry_time: document.getElementById('edit-entry-time').value || null,
        exit_time: document.getElementById('edit-exit-time').value || null,
        timeframe: document.getElementById('edit-timeframe').value,
    };
    
    try {
        const response = await fetch(`/api/trades/${id}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('Trade updated!');
            closeEditModal();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to update trade', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
});

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    
    try {
        const response = await fetch(`/api/trades/${id}`, { method: 'DELETE' });
        if (response.ok) {
            showToast('Trade deleted');
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (err) {
        showToast('Error deleting trade', 'error');
    }
}

async function recalculateMetrics() {
    showStartToast('Recalculating metrics');
    try {
        const response = await fetch('/api/recalculate-metrics', { method: 'POST' });
        const data = await response.json();
        showFinishToast('Metrics recalculated', `${data.count || 'all'} trades updated`);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showToast('Recalculation failed', 'error');
    }
}

async function analyzeAllTrades() {
    // Ask if force re-analyze
    const force = confirm('Analyze ALL trades? (Cancel to only analyze unreviewed trades)');

    // Show persistent loading message
    showToast('üß† AI analysis started... This may take 1-2 minutes for many trades.', 'info', 120000);
    console.log('Analyze started, force=' + force);
    
    try {
        const url = force ? '/api/analyze-all-trades?force=true' : '/api/analyze-all-trades';
        console.log('Calling: ' + url);
        
        // Use AbortController for timeout (10 minutes)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000);
        
        const response = await fetch(url, { 
            method: 'POST',
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        console.log('Response status: ' + response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.error) {
            showToast(data.error, 'error');
            return;
        }

        const analyzed = data.analyzed || 0;
        const skipped = data.skipped || 0;
        const errors = data.errors || 0;

        let msg = `${analyzed} analyzed`;
        if (skipped > 0) msg += `, ${skipped} skipped (already done)`;
        if (errors > 0) msg += `, ${errors} failed`;

        showToast('‚úÖ ' + msg, 'success', 5000);
        setTimeout(() => window.location.reload(), 2000);
    } catch (err) {
        console.error('Analyze error:', err);
        if (err.name === 'AbortError') {
            showToast('Analysis timed out. Try again or analyze individual trades.', 'error');
        } else {
            showToast('Analysis failed: ' + err.message, 'error');
        }
    }
}

async function deleteAllTrades() {
    if (!confirm('‚ö†Ô∏è Delete ALL trades? This cannot be undone!')) return;
    if (!confirm('Are you REALLY sure? This will delete your entire trade history!')) return;
    
    showStartToast('Deleting all trades');
    try {
        await fetch('/api/trades', { method: 'DELETE' });
        showFinishToast('All trades deleted');
        setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
        showToast('Delete failed', 'error');
    }
}
</script>
{% endblock %}
