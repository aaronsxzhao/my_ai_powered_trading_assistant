{% extends "base.html" %}

{% block title %}Trades - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-dark-300 bg-clip-text text-transparent">
                Trade Journal
            </h1>
            <p class="text-dark-400 text-sm mt-1">Track and review your trades</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
            <button onclick="recalculateMetrics()" class="btn btn-secondary">üîÑ Recalculate</button>
            <button onclick="analyzeAllTrades()" class="btn btn-secondary">üß† Analyze All</button>
            <button onclick="deleteAllTrades()" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">üóëÔ∏è Delete All</button>
        </div>
    </div>

    <!-- Stats Summary -->
    {% if trades %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="stat-card">
            <div class="stat-value">{{ total_trades if total_trades is defined else trades | length }}</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'win') | list | length }}
            </div>
            <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
            <div class="stat-value negative">
                {{ trades | selectattr('outcome') | selectattr('outcome.value', 'equalto', 'loss') | list | length }}
            </div>
            <div class="stat-label">Losses</div>
        </div>
        <div class="stat-card">
            {% set ns = namespace(total_pnl_usd=0) %}
            {% for trade in trades %}
                {% if trade.pnl_usd %}
                    {% set ns.total_pnl_usd = ns.total_pnl_usd + trade.pnl_usd %}
                {% endif %}
            {% endfor %}
            <div class="stat-value {% if ns.total_pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                {{ "+" if ns.total_pnl_usd > 0 else "" }}${{ "%.2f"|format(ns.total_pnl_usd) }}
            </div>
            <div class="stat-label">Total P&L (USD)</div>
        </div>
    </div>
    {% endif %}

    <!-- Trades Table -->
    <div class="card overflow-hidden">
        {% if trades %}
        <!-- Legend -->
        <div class="flex items-center justify-between px-4 py-2 border-b border-dark-700/50 text-sm">
            <div class="flex items-center gap-4 text-dark-400">
                <span class="flex items-center gap-1">
                    <span class="text-accent-400">ü§ñ</span> AI Reviewed
                </span>
                <span class="flex items-center gap-1">
                    <span class="text-dark-600">‚óã</span> Pending Review
                </span>
            </div>
            <span class="text-dark-500">
                {{ trades|selectattr('cached_review')|list|length }}/{{ trades|length }} reviewed
            </span>
        </div>
        <div class="overflow-x-auto">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th class="rounded-tl-xl">ID</th>
                        <th>Exit Time</th>
                        <th>Ticker</th>
                        <th>Dir</th>
                        <th>Shares</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>P&L</th>
                        <th>R</th>
                        <th>Duration</th>
                        <th>Result</th>
                        <th>Strategy</th>
                        <th class="rounded-tr-xl">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr class="group {% if not trade.cached_review %}bg-dark-800/30{% endif %}">
                        <td class="text-dark-500 text-sm">
                            <span class="flex items-center gap-1">
                                #{{ trade.trade_number or trade.id }}
                                {% if trade.cached_review and trade.review_generated_at %}
                                <span class="text-accent-400 text-xs" title="AI Reviewed on {{ trade.review_generated_at.strftime('%Y-%m-%d %H:%M') }}">ü§ñ</span>
                                {% else %}
                                <span class="text-dark-600 text-xs" title="Not yet reviewed">‚óã</span>
                                {% endif %}
                            </span>
                        </td>
                        <td class="text-sm font-mono text-dark-400">
                            {% if trade.exit_time %}
                                {{ trade.exit_time.strftime('%m/%d/%y %H:%M') }}
                                {% if trade.input_timezone and trade.input_timezone != trade.market_timezone %}
                                <div class="text-xs text-dark-500">
                                    ({{ trade.exit_time_local.strftime('%H:%M') if trade.exit_time_local else '' }} {{ trade.input_timezone.split('/')[-1] | replace('_', ' ') }})
                                </div>
                                {% endif %}
                            {% else %}
                                {{ trade.trade_date }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="font-bold text-white">{{ trade.ticker | ticker_display }}</span>
                            {% if trade.ticker | ticker_exchange %}
                            <span class="text-xs text-dark-500 ml-1">({{ trade.ticker | ticker_exchange }})</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.direction.value == 'long' %}
                                <span class="badge badge-success">LONG</span>
                            {% else %}
                                <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">SHORT</span>
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">{{ "%.0f"|format(trade.size) if trade.size else '-' }}</td>
                        <td class="font-mono text-sm">
                            {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                <span class="text-white">${{ "%.2f"|format(trade.entry_price / trade.currency_rate) }}</span>
                                <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.entry_price) }}</span>
                            {% else %}
                                ${{ "%.4f"|format(trade.entry_price) }}
                            {% endif %}
                        </td>
                        <td class="font-mono text-sm">
                            {% if trade.exit_price %}
                                {% if trade.currency and trade.currency != 'USD' and trade.currency_rate %}
                                    <span class="text-white">${{ "%.2f"|format(trade.exit_price / trade.currency_rate) }}</span>
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.exit_price) }}</span>
                                {% else %}
                                    ${{ "%.4f"|format(trade.exit_price) }}
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.pnl_usd and trade.pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.pnl_usd %}
                                {{ "+" if trade.pnl_usd > 0 else "" }}${{ "%.2f"|format(trade.pnl_usd) }}
                                {% if trade.currency and trade.currency != 'USD' %}
                                    <span class="text-xs text-dark-500 block">{{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }}</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </td>
                        <td class="font-mono font-semibold {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                        </td>
                        <td class="text-sm text-dark-400 font-mono">
                            {{ trade.duration_display }}
                        </td>
                        <td>
                            {% if trade.outcome %}
                                {% if trade.outcome.value == 'win' %}
                                    <span class="win">WIN</span>
                                {% elif trade.outcome.value == 'loss' %}
                                    <span class="loss">LOSS</span>
                                {% else %}
                                    <span class="breakeven">B/E</span>
                                {% endif %}
                            {% else %}
                                <span class="text-dark-500">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-dark-700 text-dark-300 border-dark-600">
                                {{ trade.strategy.name if trade.strategy else 'unclassified' }}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center space-x-1 opacity-50 group-hover:opacity-100 transition-opacity">
                                <button onclick="openEditModal({{ trade.id }}, '{{ trade.ticker }}', {{ trade.size or 0 }}, {{ trade.entry_price }}, {{ trade.exit_price or 0 }}, {{ trade.stop_loss or trade.stop_price or 0 }}, {{ trade.take_profit or trade.target_price or 0 }}, '{{ trade.currency or "USD" }}', {{ trade.currency_rate or 1.0 }}, '{{ trade.entry_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.entry_time else '' }}', '{{ trade.exit_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.exit_time else '' }}', '{{ trade.timeframe or "5m" }}', '{{ trade.direction.value if trade.direction else "long" }}')"
                                        class="btn btn-ghost p-2 text-sm" title="Edit">
                                    ‚úèÔ∏è
                                </button>
                                <a href="/trades/{{ trade.id }}" class="btn btn-ghost p-2 text-sm text-accent-400" title="Review">
                                    üëÅÔ∏è
                                </a>
                                <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost p-2 text-sm text-danger-400" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        {% if total_pages is defined and total_pages > 1 %}
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 pt-4 border-t border-dark-700">
            <!-- Page info -->
            <div class="text-sm text-dark-400">
                Showing {{ ((page - 1) * per_page) + 1 }}-{{ [page * per_page, total_trades] | min }} of {{ total_trades }} trades
            </div>
            
            <!-- Page navigation -->
            <div class="flex items-center gap-2">
                <!-- First page -->
                <a href="?page=1&per_page={{ per_page }}{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}"
                   class="btn btn-ghost px-3 py-1 text-sm {% if page == 1 %}opacity-50 pointer-events-none{% endif %}">
                    ‚ü®‚ü®
                </a>
                
                <!-- Previous page -->
                <a href="?page={{ page - 1 }}&per_page={{ per_page }}{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}"
                   class="btn btn-ghost px-3 py-1 text-sm {% if not has_prev %}opacity-50 pointer-events-none{% endif %}">
                    ‚ü® Prev
                </a>
                
                <!-- Page numbers -->
                <div class="flex items-center gap-1">
                    {% set start_page = [1, page - 2] | max %}
                    {% set end_page = [total_pages, page + 2] | min %}
                    
                    {% if start_page > 1 %}
                    <span class="text-dark-500 px-2">...</span>
                    {% endif %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                    <a href="?page={{ p }}&per_page={{ per_page }}{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}"
                       class="btn {% if p == page %}btn-primary{% else %}btn-ghost{% endif %} px-3 py-1 text-sm min-w-[2.5rem]">
                        {{ p }}
                    </a>
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                    <span class="text-dark-500 px-2">...</span>
                    {% endif %}
                </div>
                
                <!-- Next page -->
                <a href="?page={{ page + 1 }}&per_page={{ per_page }}{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}"
                   class="btn btn-ghost px-3 py-1 text-sm {% if not has_next %}opacity-50 pointer-events-none{% endif %}">
                    Next ‚ü©
                </a>
                
                <!-- Last page -->
                <a href="?page={{ total_pages }}&per_page={{ per_page }}{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}"
                   class="btn btn-ghost px-3 py-1 text-sm {% if page == total_pages %}opacity-50 pointer-events-none{% endif %}">
                    ‚ü©‚ü©
                </a>
            </div>
            
            <!-- Per page selector -->
            <div class="flex items-center gap-2 text-sm">
                <span class="text-dark-400">Show:</span>
                <select onchange="window.location.href='?page=1&per_page=' + this.value + '{% if filter_ticker %}&ticker={{ filter_ticker }}{% endif %}{% if filter_outcome %}&outcome={{ filter_outcome }}{% endif %}'" 
                        class="input py-1 px-2 text-sm w-20">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                </select>
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-16">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl font-semibold text-white mb-2">No trades yet</h3>
            <p class="text-dark-400 mb-6">Start tracking your trades to get AI-powered coaching</p>
            <div class="flex justify-center gap-4">
                <a href="/add-trade" class="btn btn-primary">‚ûï Add Trade</a>
                <a href="/import" class="btn btn-secondary">üì• Import CSV</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Trade Modal -->
<div id="edit-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="card w-full max-w-lg animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white">Edit Trade #<span id="edit-trade-id"></span></h3>
                <p id="edit-date-display" class="text-sm text-dark-400"></p>
            </div>
            <button onclick="closeEditModal()" class="btn btn-ghost text-2xl p-2">&times;</button>
        </div>
        
        <form id="edit-form" class="space-y-4">
            <input type="hidden" id="edit-id">
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Ticker</label>
                    <input type="text" id="edit-ticker" class="input text-sm uppercase" placeholder="SPY">
                </div>
                <div>
                    <label class="label">Direction</label>
                    <select id="edit-direction" class="select">
                        <option value="long">LONG</option>
                        <option value="short">SHORT</option>
                    </select>
                </div>
                <div>
                    <label class="label">Shares</label>
                    <input type="number" id="edit-shares" step="1" min="1" class="input">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Time</label>
                    <input type="datetime-local" id="edit-entry-time" step="1" class="input text-sm">
                </div>
                <div>
                    <label class="label">Exit Time</label>
                    <input type="datetime-local" id="edit-exit-time" step="1" class="input text-sm">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Entry Price</label>
                    <input type="number" id="edit-entry" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Exit Price</label>
                    <input type="number" id="edit-exit" step="0.0001" min="0" class="input">
                </div>
                <div>
                    <label class="label">Stop Loss (SL)</label>
                    <input type="number" id="edit-sl" step="0.0001" min="0" class="input" placeholder="Where trade is wrong">
                </div>
                <div>
                    <label class="label">Take Profit (TP)</label>
                    <input type="number" id="edit-tp" step="0.0001" min="0" class="input" placeholder="Target exit">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Timeframe</label>
                    <select id="edit-timeframe" class="select">
                        <option value="5m">5 min (Scalp)</option>
                        <option value="2h">2 hour (Swing)</option>
                        <option value="1d">Daily (Position)</option>
                    </select>
                    <p class="text-xs text-dark-500 mt-1">Used for AI context data</p>
                </div>
                <div>
                    <label class="label">Currency</label>
                    <select id="edit-currency" class="select">
                        <option value="USD">USD ($)</option>
                        <option value="HKD">HKD (HK$)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="JPY">JPY (¬•)</option>
                        <option value="CNY">CNY (¬•)</option>
                        <option value="CAD">CAD (C$)</option>
                        <option value="AUD">AUD (A$)</option>
                    </select>
                </div>
                <div>
                    <label class="label">Rate to USD</label>
                    <div class="flex space-x-2">
                        <input type="number" id="edit-rate" step="0.0001" min="0" class="input flex-1">
                        <button type="button" onclick="fetchHistoricalRate()" class="btn btn-secondary">üîÑ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-dark-700">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Trades page JavaScript -->
<script src="/static/js/trades.js"></script>
{% endblock %}
