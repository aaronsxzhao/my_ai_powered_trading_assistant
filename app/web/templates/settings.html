{% extends "base.html" %}

{% block title %}Settings - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">Settings</h1>
            <p class="text-dark-400 text-sm mt-1">Configure your trading coach</p>
        </div>
        <div class="flex gap-2">
            <span class="px-3 py-1.5 rounded-full text-xs font-medium {% if llm_available %}bg-green-500/20 text-green-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                LLM: {% if llm_available %}Connected{% else %}Not Connected{% endif %}
            </span>
            <span class="px-3 py-1.5 rounded-full text-xs font-medium bg-accent-500/20 text-accent-400">
                {{ data_provider|upper }}
            </span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar Navigation -->
        <div class="lg:col-span-1">
            <nav class="sticky top-4 space-y-1">
                <div class="text-xs font-semibold text-dark-500 uppercase tracking-wider mb-3 px-3">Navigation</div>
                <a href="#quick-actions" class="nav-settings-link active">Quick Actions</a>
                <a href="#data-settings" class="nav-settings-link">Data Settings</a>
                <a href="#ai-prompts" class="nav-settings-link">AI Prompts</a>
                <a href="#system-info" class="nav-settings-link">System Info</a>
                
                <div class="border-t border-dark-700 my-4 pt-4">
                    <button onclick="resetToDefaults()" class="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                        Reset All Settings
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Quick Actions -->
            <section id="quick-actions" class="scroll-mt-4">
                <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-accent-500/20 flex items-center justify-center text-accent-400">1</span>
                    Quick Actions
                </h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                    <a href="/tickers" class="settings-action-card">
                        <span class="text-2xl">üéØ</span>
                        <span class="text-sm font-medium">Tickers</span>
                    </a>
                    <a href="/strategies" class="settings-action-card">
                        <span class="text-2xl">üè∑Ô∏è</span>
                        <span class="text-sm font-medium">Strategies</span>
                    </a>
                    <a href="/materials" class="settings-action-card">
                        <span class="text-2xl">üìö</span>
                        <span class="text-sm font-medium">Materials</span>
                    </a>
                    <a href="/reports" class="settings-action-card">
                        <span class="text-2xl">üìã</span>
                        <span class="text-sm font-medium">Reports</span>
                    </a>
                    <a href="/analysis" class="settings-action-card">
                        <span class="text-2xl">üîç</span>
                        <span class="text-sm font-medium">Bulk Analysis</span>
                    </a>
                </div>
            </section>

            <!-- Data Settings -->
            <section id="data-settings" class="scroll-mt-4">
                <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-accent-500/20 flex items-center justify-center text-accent-400">2</span>
                    Data Settings
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Candle Settings -->
                    <div class="settings-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium text-white">OHLCV Bar Counts</h3>
                            <span class="text-xs text-dark-500">For AI context</span>
                        </div>
                        <form id="candle-form" class="space-y-3">
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs text-dark-400 block mb-1">Daily</label>
                                    <input type="number" id="candles-daily" min="1" max="365" value="{{ candles.daily }}" class="input text-center py-2">
                                </div>
                                <div>
                                    <label class="text-xs text-dark-400 block mb-1">2-Hour</label>
                                    <input type="number" id="candles-hourly" min="1" max="500" value="{{ candles.hourly }}" class="input text-center py-2">
                                </div>
                                <div>
                                    <label class="text-xs text-dark-400 block mb-1">5-Min</label>
                                    <input type="number" id="candles-5min" min="1" max="1000" value="{{ candles['5min'] }}" class="input text-center py-2">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full py-2 text-sm">Save</button>
                        </form>
                    </div>

                    <!-- Cache Settings -->
                    <div class="settings-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium text-white">AI Cache</h3>
                            <span class="text-xs px-2 py-0.5 rounded-full {% if cache_settings.enable_review_cache %}bg-green-500/20 text-green-400{% else %}bg-dark-600 text-dark-400{% endif %}">
                                {% if cache_settings.enable_review_cache %}Enabled{% else %}Disabled{% endif %}
                            </span>
                        </div>
                        <form id="cache-form" class="space-y-3">
                            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" id="enable-review-cache" class="w-4 h-4 rounded bg-dark-700 border-dark-600 text-accent-500 focus:ring-accent-500"
                                    {{ 'checked' if cache_settings.enable_review_cache else '' }}>
                                <div class="flex-1">
                                    <span class="text-sm text-white">Enable Cache</span>
                                    <p class="text-xs text-dark-500">Reuse AI reviews</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-700/50 cursor-pointer transition-colors">
                                <input type="checkbox" id="auto-regenerate" class="w-4 h-4 rounded bg-dark-700 border-dark-600 text-accent-500 focus:ring-accent-500"
                                    {{ 'checked' if cache_settings.auto_regenerate else '' }}>
                                <div class="flex-1">
                                    <span class="text-sm text-white">Force Regenerate</span>
                                    <p class="text-xs text-dark-500">Always fresh (testing)</p>
                                </div>
                            </label>
                            <button type="submit" class="btn btn-primary w-full py-2 text-sm">Save</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- AI Prompts -->
            <section id="ai-prompts" class="scroll-mt-4">
                <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-accent-500/20 flex items-center justify-center text-accent-400">3</span>
                    AI Prompts
                </h2>

                <!-- Prompt Type Selector -->
                <div class="settings-card">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="selectPromptType('trade_analysis')" id="prompt-btn-trade_analysis" class="prompt-type-btn active">
                            Trade Review
                        </button>
                        <button onclick="selectPromptType('market_context')" id="prompt-btn-market_context" class="prompt-type-btn">
                            Market Context
                        </button>
                    </div>

                    <!-- Trade Analysis Prompts -->
                    <div id="prompt-section-trade_analysis" class="prompt-section space-y-4">
                        <!-- Placeholders Reference -->
                        <details class="bg-dark-800/50 rounded-lg border border-dark-700">
                            <summary class="px-4 py-3 cursor-pointer text-sm font-medium text-dark-300 hover:text-white transition-colors">
                                üìã Available Placeholders
                            </summary>
                            <div class="px-4 pb-4 pt-2 grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs border-t border-dark-700">
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Trade Identity</div>
                                    <code class="text-accent-400 text-xs">{ticker} {market} {timezone} {trade_date} {timeframe} {tf_traded} {direction}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Execution</div>
                                    <code class="text-accent-400 text-xs">{entry_time} {entry_price} {exit_time} {exit_price} {size} {order_type} {stop_loss} {take_profit} {target_price} {fees} {slippage}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Performance</div>
                                    <code class="text-accent-400 text-xs">{r_multiple} {outcome} {mae} {mfe}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Intent</div>
                                    <code class="text-accent-400 text-xs">{intended_setup} {trade_type} {entry_reason} {invalidation} {management_plan}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Session</div>
                                    <code class="text-accent-400 text-xs">{today_open} {pd_high} {pd_low} {pd_close}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">OHLCV Data</div>
                                    <code class="text-accent-400 text-xs">{daily_bars} {twohour_bars} {fivemin_bars} {ohlcv_context}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Extended Analysis</div>
                                    <code class="text-accent-400 text-xs">{trend_assessment} {signal_reason} {was_signal_present} {strategy_alignment} {entry_exit_emotions} {entry_tp_distance}</code>
                                </div>
                                <div>
                                    <div class="text-dark-500 mb-1 font-medium">Notes & Review</div>
                                    <code class="text-accent-400 text-xs">{notes} {mistakes} {lessons} {mistakes_and_lessons} {stop_reason} {target_reason} {confidence} {emotional_state} {followed_plan}</code>
                                </div>
                            </div>
                        </details>

                        <!-- System Prompt -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-accent-400">System Prompt</label>
                                <span class="text-xs text-dark-500">AI persona & instructions</span>
                            </div>
                            <textarea id="system-trade_analysis" rows="10" class="input font-mono text-xs leading-relaxed">{{ system_prompts.trade_analysis }}</textarea>
                            <button onclick="savePrompt('trade_analysis', false)" class="btn btn-primary mt-2 text-sm">Save System Prompt</button>
                        </div>

                        <!-- User Prompt -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-purple-400">User Prompt</label>
                                <span class="text-xs text-dark-500">Data template with placeholders</span>
                            </div>
                            <textarea id="user-trade_analysis" rows="10" class="input font-mono text-xs leading-relaxed">{{ user_prompts.trade_analysis }}</textarea>
                            <button onclick="savePrompt('trade_analysis', true)" class="btn bg-purple-600 hover:bg-purple-700 text-white mt-2 text-sm">Save User Prompt</button>
                        </div>
                    </div>

                    <!-- Market Context Prompts -->
                    <div id="prompt-section-market_context" class="prompt-section hidden space-y-4">
                        <!-- Placeholders Reference -->
                        <details class="bg-dark-800/50 rounded-lg border border-dark-700">
                            <summary class="px-4 py-3 cursor-pointer text-sm font-medium text-dark-300 hover:text-white transition-colors">
                                üìã Available Placeholders
                            </summary>
                            <div class="px-4 pb-4 pt-2 text-xs border-t border-dark-700">
                                <code class="text-accent-400">{ticker} {date} {timeframe} {ohlcv_context}</code>
                            </div>
                        </details>

                        <!-- System Prompt -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-accent-400">System Prompt</label>
                                <span class="text-xs text-dark-500">AI persona & instructions</span>
                            </div>
                            <textarea id="system-market_context" rows="10" class="input font-mono text-xs leading-relaxed">{{ system_prompts.market_context }}</textarea>
                            <button onclick="savePrompt('market_context', false)" class="btn btn-primary mt-2 text-sm">Save System Prompt</button>
                        </div>

                        <!-- User Prompt -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium text-purple-400">User Prompt</label>
                                <span class="text-xs text-dark-500">Data template with placeholders</span>
                            </div>
                            <textarea id="user-market_context" rows="10" class="input font-mono text-xs leading-relaxed">{{ user_prompts.market_context }}</textarea>
                            <button onclick="savePrompt('market_context', true)" class="btn bg-purple-600 hover:bg-purple-700 text-white mt-2 text-sm">Save User Prompt</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Info -->
            <section id="system-info" class="scroll-mt-4">
                <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-lg bg-accent-500/20 flex items-center justify-center text-accent-400">4</span>
                    System Info
                </h2>
                <div class="settings-card">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-dark-500">Settings File:</span>
                            <code class="text-accent-400 ml-2 text-xs break-all">{{ settings_file }}</code>
                        </div>
                        <div>
                            <span class="text-dark-500">Data Provider:</span>
                            <span class="text-white ml-2">{{ data_provider }}</span>
                        </div>
                        <div>
                            <span class="text-dark-500">LLM Status:</span>
                            <span class="ml-2 {% if llm_available %}text-green-400{% else %}text-red-400{% endif %}">
                                {% if llm_available %}Connected{% else %}Not Connected{% endif %}
                            </span>
                        </div>
                        <div>
                            <span class="text-dark-500">Cache Status:</span>
                            <span class="ml-2 {% if cache_settings.enable_review_cache %}text-green-400{% else %}text-dark-400{% endif %}">
                                {% if cache_settings.enable_review_cache %}Enabled{% else %}Disabled{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.nav-settings-link {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: #9ca3af;
    border-radius: 0.5rem;
    transition: all 0.15s ease;
}
.nav-settings-link:hover {
    color: #fff;
    background: rgba(55, 65, 81, 0.5);
}
.nav-settings-link.active {
    color: #06b6d4;
    background: rgba(6, 182, 212, 0.1);
}
.settings-card {
    background: rgba(31, 41, 55, 0.5);
    border: 1px solid #374151;
    border-radius: 0.75rem;
    padding: 1rem;
}
.settings-action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: rgba(31, 41, 55, 0.5);
    border: 1px solid #374151;
    border-radius: 0.75rem;
    transition: all 0.15s ease;
    cursor: pointer;
    text-align: center;
    color: #d1d5db;
}
.settings-action-card:hover {
    border-color: rgba(6, 182, 212, 0.5);
    background: rgba(55, 65, 81, 0.5);
}
.prompt-type-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0.5rem;
    border: 1px solid #4b5563;
    color: #9ca3af;
    background: transparent;
    transition: all 0.15s ease;
    cursor: pointer;
}
.prompt-type-btn:hover {
    color: #fff;
    border-color: #6b7280;
}
.prompt-type-btn.active {
    background: rgba(6, 182, 212, 0.2);
    border-color: rgba(6, 182, 212, 0.5);
    color: #06b6d4;
}

/* Light mode support */
:root:not(.dark) .nav-settings-link { color: #6b7280; background: transparent; }
:root:not(.dark) .nav-settings-link:hover { color: #111827; background: #f8fafc; }
:root:not(.dark) .nav-settings-link.active { color: #0891b2; background: rgba(6, 182, 212, 0.06); }
:root:not(.dark) .settings-card { background: #ffffff !important; border-color: #e5e7eb !important; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
:root:not(.dark) .settings-action-card { background: #ffffff !important; border-color: #e5e7eb !important; color: #374151; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
:root:not(.dark) .settings-action-card:hover { border-color: #0891b2 !important; background: #fafbfc !important; }
:root:not(.dark) .prompt-type-btn { border-color: #e5e7eb; color: #6b7280; background: #ffffff; }
:root:not(.dark) .prompt-type-btn:hover { color: #111827; border-color: #d1d5db; background: #fafbfc; }
:root:not(.dark) .prompt-type-btn.active { background: rgba(6, 182, 212, 0.06) !important; border-color: #0891b2 !important; color: #0891b2; }

/* Additional light mode fixes for settings */
:root:not(.dark) details { background: #ffffff !important; border-color: #e5e7eb !important; }
:root:not(.dark) details summary { color: #4b5563 !important; }
:root:not(.dark) details[open] > div { background: #fafbfc !important; }
</style>

<script>
// Prompt type selection
function selectPromptType(type) {
    document.querySelectorAll('.prompt-type-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.prompt-section').forEach(sec => sec.classList.add('hidden'));
    
    document.getElementById('prompt-btn-' + type).classList.add('active');
    document.getElementById('prompt-section-' + type).classList.remove('hidden');
}

// Sidebar navigation highlighting
document.querySelectorAll('.nav-settings-link').forEach(link => {
    link.addEventListener('click', function() {
        document.querySelectorAll('.nav-settings-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
    });
});

// Save candle settings
document.getElementById('candle-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        daily: parseInt(document.getElementById('candles-daily').value),
        hourly: parseInt(document.getElementById('candles-hourly').value),
        '5min': parseInt(document.getElementById('candles-5min').value)
    };
    
    try {
        const response = await fetch('/api/settings/candles', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            showToast('Candle settings saved', 'success');
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
});

// Save cache settings
document.getElementById('cache-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        enable_review_cache: document.getElementById('enable-review-cache').checked,
        auto_regenerate: document.getElementById('auto-regenerate').checked
    };
    
    try {
        const response = await fetch('/api/settings/cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            showToast('Cache settings saved', 'success');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
});

// Save prompt
async function savePrompt(promptType, isUserPrompt) {
    const prefix = isUserPrompt ? 'user-' : 'system-';
    const textarea = document.getElementById(prefix + promptType);
    const promptText = textarea.value;
    const label = isUserPrompt ? 'User' : 'System';
    
    try {
        const response = await fetch('/api/settings/prompts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                prompt_type: promptType,
                prompt_text: promptText,
                is_user_prompt: isUserPrompt
            })
        });
        if (response.ok) {
            showToast(`${label} prompt saved`, 'success');
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

// Reset to defaults
async function resetToDefaults() {
    if (!confirm('Reset all settings to defaults? This cannot be undone.')) return;
    
    try {
        const response = await fetch('/api/settings/reset', { method: 'POST' });
        if (response.ok) {
            showToast('Settings reset', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to reset', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}
</script>
{% endblock %}
