{% extends "base.html" %}

{% block title %}Reports - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Reports</h1>
        <div class="flex space-x-3">
            <button onclick="generatePremarket()" class="btn btn-primary">ğŸ“Š Generate Premarket</button>
            <button onclick="generateEOD()" class="btn btn-secondary">ğŸ“‹ Generate EOD</button>
        </div>
    </div>

    <!-- Generate for Ticker -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">Generate Premarket Report</h2>
        <div class="flex space-x-3">
            <select id="ticker-select" class="input flex-1">
                <option value="">All watchlist tickers</option>
                {% for ticker in tickers %}
                <option value="{{ ticker }}">{{ ticker }}</option>
                {% endfor %}
            </select>
            <button onclick="generatePremarketForTicker()" class="btn btn-primary">Generate</button>
        </div>
    </div>

    <!-- Report History -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4">Report History</h2>
        
        {% if reports %}
        <div class="space-y-3">
            {% for report in reports %}
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div>
                    <div class="font-bold">{{ report.date }}</div>
                    <div class="text-sm text-gray-500">
                        {% if report.has_premarket %}
                            <span class="text-green-600">âœ“ Premarket</span>
                        {% endif %}
                        {% if report.has_eod %}
                            <span class="text-blue-600 ml-2">âœ“ EOD</span>
                        {% endif %}
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    {{ report.path }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-4xl mb-4">ğŸ“„</div>
            <p class="text-xl mb-4">No reports yet</p>
            <button onclick="generatePremarket()" class="btn btn-primary">
                Generate First Report
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Output Folder -->
    <div class="card bg-gray-50">
        <h3 class="font-medium mb-2">ğŸ“ Output Location</h3>
        <p class="text-sm text-gray-600">
            Reports are saved to <code class="bg-white px-2 py-1 rounded">outputs/YYYY-MM-DD/</code>
            as Markdown files. You can open them in any text editor or Markdown viewer.
        </p>
    </div>
</div>

<div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg hidden">
    <span id="toast-message"></span>
</div>

<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin text-4xl mb-4">â³</div>
        <div class="text-xl font-medium">Generating report...</div>
        <div class="text-gray-500">AI is analyzing market data</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toast-message').textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

async function generatePremarket() {
    showLoading(true);
    try {
        const response = await fetch('/api/generate-premarket', { method: 'POST' });
        const data = await response.json();
        showLoading(false);
        showToast(data.message);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showLoading(false);
        showToast('Failed to generate report');
    }
}

async function generatePremarketForTicker() {
    const ticker = document.getElementById('ticker-select').value;
    showLoading(true);
    
    const formData = new FormData();
    if (ticker) formData.append('ticker', ticker);
    
    try {
        const response = await fetch('/api/generate-premarket', { 
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        showLoading(false);
        showToast(data.message);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showLoading(false);
        showToast('Failed to generate report');
    }
}

async function generateEOD() {
    showLoading(true);
    try {
        const response = await fetch('/api/generate-eod', { method: 'POST' });
        const data = await response.json();
        showLoading(false);
        showToast(data.message);
        setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
        showLoading(false);
        showToast('Failed to generate report');
    }
}
</script>
{% endblock %}
