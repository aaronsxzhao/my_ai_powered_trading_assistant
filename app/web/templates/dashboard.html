{% extends "base.html" %}

{% block title %}Dashboard - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-white via-dark-100 to-dark-300 bg-clip-text text-transparent">
                Trading Dashboard
            </h1>
            <p class="text-dark-400 mt-1">Your AI-powered trading coach</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button onclick="generatePremarket()" class="btn btn-primary">
                ðŸ“Š Generate Premarket
            </button>
            <button onclick="generateEOD()" class="btn btn-secondary">
                ðŸ“‹ EOD Report
            </button>
        </div>
    </div>

    <!-- Primary Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="stat-card glow-pulse" style="animation-delay: 0s;">
            <div class="stat-value">{{ total_trades }}</div>
            <div class="stat-label">Total Trades</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.1s;">
            <div class="stat-value {% if total_r >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.2f"|format(total_r) }}R
            </div>
            <div class="stat-label">Total R-Multiple</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.2s;">
            <div class="stat-value {% if total_pnl >= 0 %}positive{% else %}negative{% endif %}">
                {{ "+" if total_pnl > 0 else "" }}${{ "%.0f"|format(total_pnl) }}
            </div>
            <div class="stat-label">Total P&L (USD)</div>
        </div>
        <div class="stat-card" style="animation-delay: 0.3s;">
            <div class="stat-value">{{ "%.1f"|format(win_rate * 100) }}%</div>
            <div class="stat-label">Win Rate</div>
        </div>
    </div>

    <!-- Advanced Stats (if portfolio_stats available) -->
    {% if portfolio_stats %}
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="stat-card-sm-colored {% if portfolio_stats.expectancy >= 0 %}bg-positive{% else %}bg-negative{% endif %}">
            <div class="stat-value-sm {% if portfolio_stats.expectancy >= 0 %}positive{% else %}negative{% endif %}">
                {{ "%.2f"|format(portfolio_stats.expectancy) }}R
            </div>
            <div class="stat-label-sm">Expectancy</div>
        </div>
        <div class="stat-card-sm-colored {% if portfolio_stats.profit_factor >= 1 %}bg-positive{% else %}bg-negative{% endif %}">
            <div class="stat-value-sm {% if portfolio_stats.profit_factor >= 1 %}positive{% else %}negative{% endif %}">
                {{ "%.2f"|format(portfolio_stats.profit_factor) }}
            </div>
            <div class="stat-label-sm">Profit Factor</div>
        </div>
        <div class="stat-card-sm-colored bg-negative">
            <div class="stat-value-sm negative">
                -{{ "%.2f"|format(portfolio_stats.max_drawdown_r) }}R
            </div>
            <div class="stat-label-sm">Max Drawdown</div>
        </div>
        <div class="stat-card-sm-colored bg-positive">
            <div class="stat-value-sm positive">{{ "%.2f"|format(portfolio_stats.avg_winner_r) }}R</div>
            <div class="stat-label-sm">Avg Winner</div>
        </div>
        <div class="stat-card-sm-colored bg-negative">
            <div class="stat-value-sm negative">{{ "%.2f"|format(portfolio_stats.avg_loser_r) }}R</div>
            <div class="stat-label-sm">Avg Loser</div>
        </div>
        <div class="stat-card-sm-colored {% if portfolio_stats.current_streak >= 0 %}bg-positive{% else %}bg-negative{% endif %}">
            <div class="stat-value-sm {% if portfolio_stats.current_streak >= 0 %}positive{% else %}negative{% endif %}">
                {% if portfolio_stats.current_streak >= 0 %}+{% endif %}{{ portfolio_stats.current_streak }}
            </div>
            <div class="stat-label-sm">Current Streak</div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Trades -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Recent Trades</h2>
                <a href="/trades" class="text-accent-400 hover:text-accent-300 text-sm font-medium">
                    View All â†’
                </a>
            </div>
            
            {% if recent_trades %}
            <div class="space-y-2">
                {% for trade in recent_trades %}
                <a href="/trades/{{ trade.id }}" 
                   class="flex items-center justify-between p-3 bg-dark-700/30 rounded-xl hover:bg-dark-700/50 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center
                            {% if trade.direction.value == 'long' %}bg-success-500/20 text-success-400
                            {% else %}bg-danger-500/20 text-danger-400{% endif %}">
                            {% if trade.direction.value == 'long' %}â–²{% else %}â–¼{% endif %}
                        </div>
                        <div>
                            <div class="font-semibold text-white group-hover:text-accent-400 transition-colors">
                                {{ trade.ticker | ticker_display }}
                            </div>
                            <div class="text-xs text-dark-400">{{ trade.trade_date }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono font-bold {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                            {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                        </div>
                        {% if trade.pnl_usd %}
                        <div class="text-xs text-dark-400">${{ "%.0f"|format(trade.pnl_usd) }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-4xl mb-3">ðŸ“­</div>
                <p class="text-dark-400 mb-4">No trades yet</p>
                <a href="/add-trade" class="btn btn-primary">âž• Add Your First Trade</a>
            </div>
            {% endif %}
        </div>

        <!-- Strategy Performance -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Top Strategies</h2>
                <a href="/stats" class="text-accent-400 hover:text-accent-300 text-sm font-medium">
                    Full Stats â†’
                </a>
            </div>
            
            {% if strategy_stats %}
            <div class="space-y-3">
                {% for stat in strategy_stats %}
                <div class="flex items-center justify-between p-4 bg-dark-700/30 rounded-xl">
                    <div>
                        <div class="font-medium text-white">{{ stat.strategy_name }}</div>
                        <div class="text-sm text-dark-400 flex items-center gap-2 mt-1">
                            <span>{{ stat.trade_count }} trades</span>
                            <span class="text-dark-600">â€¢</span>
                            <span>{{ "%.0f"|format(stat.win_rate * 100) }}% win</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono text-lg font-bold {% if stat.expectancy >= 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.2f"|format(stat.expectancy) }}R
                        </div>
                        <div class="text-xs text-dark-500">expectancy</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-4xl mb-3">ðŸ“ˆ</div>
                <p class="text-dark-400">Strategy data will appear after more trades</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h2 class="text-xl font-bold text-white mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="/add-trade" class="group p-6 bg-gradient-to-br from-accent-500/10 to-accent-600/5 rounded-xl text-center 
                                        border border-accent-500/20 hover:border-accent-500/40 transition-all hover:scale-[1.02]">
                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">âž•</div>
                <div class="font-medium text-white">Add Trade</div>
            </a>
            <a href="/import" class="group p-6 bg-gradient-to-br from-success-500/10 to-emerald-600/5 rounded-xl text-center 
                                     border border-success-500/20 hover:border-success-500/40 transition-all hover:scale-[1.02]">
                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ðŸ“¥</div>
                <div class="font-medium text-white">Import CSV</div>
            </a>
            <a href="/tickers" class="group p-6 bg-gradient-to-br from-purple-500/10 to-purple-600/5 rounded-xl text-center 
                                      border border-purple-500/20 hover:border-purple-500/40 transition-all hover:scale-[1.02]">
                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ðŸŽ¯</div>
                <div class="font-medium text-white">Watchlist</div>
            </a>
            <a href="/reports" class="group p-6 bg-gradient-to-br from-amber-500/10 to-orange-600/5 rounded-xl text-center 
                                      border border-amber-500/20 hover:border-amber-500/40 transition-all hover:scale-[1.02]">
                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ðŸ“Š</div>
                <div class="font-medium text-white">Reports</div>
            </a>
        </div>
    </div>

    <!-- Watchlist -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Watchlist</h2>
            <a href="/tickers" class="text-accent-400 hover:text-accent-300 text-sm font-medium">Edit â†’</a>
        </div>
        <div class="flex flex-wrap gap-2">
            {% for ticker in tickers %}
            <span class="px-4 py-2 bg-dark-700/50 border border-dark-600 rounded-xl text-sm font-medium text-dark-200 
                         hover:border-dark-500 transition-colors cursor-default">
                {{ ticker }}
            </span>
            {% endfor %}
            {% if not tickers %}
            <p class="text-dark-500">No tickers in watchlist. <a href="/tickers" class="text-accent-400 hover:underline">Add some â†’</a></p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function generatePremarket() {
    showLoading(true);
    showToast('Generating premarket reports... This may take a minute.');
    
    try {
        const response = await fetch('/api/generate-premarket', { method: 'POST' });
        const data = await response.json();
        showToast(data.message || 'Premarket reports generated!');
    } catch (err) {
        showToast('Error generating reports', 'error');
    }
    showLoading(false);
}

async function generateEOD() {
    showLoading(true);
    showToast('Generating EOD report...');
    
    try {
        const response = await fetch('/api/generate-eod', { method: 'POST' });
        const data = await response.json();
        showToast(data.message || 'EOD report generated!');
    } catch (err) {
        showToast('Error generating report', 'error');
    }
    showLoading(false);
}
</script>
{% endblock %}
