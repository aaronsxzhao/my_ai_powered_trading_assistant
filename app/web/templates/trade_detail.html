{% extends "base.html" %}

{% block title %}Trade #{{ trade.id }} - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Link -->
    <a href="/trades" class="inline-flex items-center text-dark-400 hover:text-white transition-colors">
        <span class="mr-2">‚Üê</span> Back to Trades
    </a>

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-4xl font-bold text-white">{{ trade.ticker }}</h1>
                {% if trade.direction.value == 'long' %}
                    <span class="badge badge-success">‚ñ≤ LONG</span>
                {% else %}
                    <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">‚ñº SHORT</span>
                {% endif %}
            </div>
            <p class="text-dark-400 mt-1">Trade #{{ trade.id }} ‚Ä¢ {{ trade.trade_date }}</p>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-sm text-dark-400">R-Multiple</div>
                <div class="text-4xl font-bold font-mono {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                    {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                </div>
            </div>
            {% if trade.pnl_usd %}
            <div class="text-right">
                <div class="text-sm text-dark-400">P&L (USD)</div>
                <div class="text-2xl font-mono {% if trade.pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "+" if trade.pnl_usd > 0 else "" }}${{ "%.2f"|format(trade.pnl_usd) }}
                    {% if trade.currency and trade.currency != 'USD' %}
                        <span class="text-sm text-dark-400 block">({{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }})</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Trade Details -->
        <div class="card">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                üìä Trade Details
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Entry</div>
                    <div class="text-xl font-mono font-bold text-white">${{ "%.4f"|format(trade.entry_price) }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Exit</div>
                    <div class="text-xl font-mono font-bold text-white">${{ "%.4f"|format(trade.exit_price) if trade.exit_price else '-' }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Stop</div>
                    <div class="text-xl font-mono font-bold text-white">${{ "%.4f"|format(trade.stop_price) if trade.stop_price else '-' }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Size</div>
                    <div class="text-xl font-bold text-white">{{ "%.0f"|format(trade.size) if trade.size else '1' }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Duration</div>
                    <div class="text-lg font-mono text-white">{{ trade.duration_display }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Timeframe</div>
                    <div class="text-sm font-medium">
                        {% set tf = trade.timeframe or '5m' %}
                        {% if tf == '5m' %}
                            <span class="badge bg-purple-500/20 text-purple-400 border border-purple-500/30">5 min</span>
                        {% elif tf == '2h' %}
                            <span class="badge bg-amber-500/20 text-amber-400 border border-amber-500/30">2 hour</span>
                        {% elif tf == '1d' %}
                            <span class="badge bg-cyan-500/20 text-cyan-400 border border-cyan-500/30">Daily</span>
                        {% else %}
                            <span class="badge bg-dark-600 text-dark-300">{{ tf }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="stat-card overflow-hidden">
                    <div class="text-sm text-dark-400 mb-1">Strategy</div>
                    <div class="text-sm font-medium text-accent-400 truncate max-w-full" title="{{ trade.strategy.name if trade.strategy else 'Unclassified' }}">
                        {{ trade.strategy.name if trade.strategy else 'Unclassified' }}
                    </div>
                    {% if trade.ai_setup_classification and trade.strategy and trade.ai_setup_classification != trade.strategy.name %}
                    <div class="text-xs text-dark-500 mt-1 truncate" title="AI: {{ trade.ai_setup_classification }}">AI: {{ trade.ai_setup_classification }}</div>
                    {% endif %}
                    <button onclick="openStrategyModal()" class="text-xs text-dark-400 hover:text-accent-400 mt-1">‚úèÔ∏è Edit</button>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Result</div>
                    {% if trade.outcome %}
                        {% if trade.outcome.value == 'win' %}
                            <span class="win text-base">WIN</span>
                        {% elif trade.outcome.value == 'loss' %}
                            <span class="loss text-base">LOSS</span>
                        {% else %}
                            <span class="breakeven text-base">B/E</span>
                        {% endif %}
                    {% else %}
                        <span class="text-dark-500">-</span>
                    {% endif %}
                </div>
            </div>

            {% if trade.mae or trade.mfe %}
            <div class="mt-4 pt-4 border-t border-dark-700 grid grid-cols-2 gap-4">
                {% if trade.mae %}
                <div>
                    <div class="text-sm text-dark-400">MAE (Max Adverse)</div>
                    <div class="font-mono text-danger-400 text-lg">{{ "%.2f"|format(trade.mae) }}R</div>
                </div>
                {% endif %}
                {% if trade.mfe %}
                <div>
                    <div class="text-sm text-dark-400">MFE (Max Favorable)</div>
                    <div class="font-mono text-success-400 text-lg">{{ "%.2f"|format(trade.mfe) }}R</div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if trade.notes %}
            <div class="mt-4 pt-4 border-t border-dark-700">
                <div class="text-sm text-dark-400 mb-2">Notes</div>
                <div class="text-dark-200 bg-dark-900/50 rounded-lg p-3">{{ trade.notes }}</div>
            </div>
            {% endif %}

            {% if trade.entry_reason %}
            <div class="mt-4 pt-4 border-t border-dark-700">
                <div class="text-sm text-dark-400 mb-2">Entry Reason</div>
                <div class="text-dark-200 bg-dark-900/50 rounded-lg p-3">{{ trade.entry_reason }}</div>
            </div>
            {% endif %}
        </div>

        <!-- AI Review -->
        <div class="card" id="review-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    üß† AI Coaching Review
                    <span id="cache-badge" class="badge bg-dark-700 text-dark-400 text-xs hidden">Cached</span>
                </h2>
                <div id="review-grade" class="flex items-center gap-2 hidden">
                    <span class="text-sm text-dark-400">Grade:</span>
                    <span id="grade-value" class="text-3xl font-bold"></span>
                </div>
            </div>
            <div id="review-meta" class="text-xs text-dark-500 mb-3 hidden">
                Generated: <span id="generated-at"></span>
            </div>

            <!-- Loading State with Progress -->
            <div id="review-loading" class="py-8">
                <div class="loading-spinner w-10 h-10 border-4 border-accent-500 border-t-transparent mx-auto mb-4"></div>
                <p class="text-dark-300 text-center mb-4" id="loading-status">Initializing analysis...</p>
                
                <!-- Progress Steps -->
                <div class="space-y-2 max-w-md mx-auto text-sm">
                    <div id="step-1" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">1</span>
                        <span>Checking cached review...</span>
                    </div>
                    <div id="step-2" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">2</span>
                        <span>Fetching OHLCV data (Daily, 2H, 5min)...</span>
                    </div>
                    <div id="step-3" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">3</span>
                        <span>Building Brooks Audit prompt...</span>
                    </div>
                    <div id="step-4" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">4</span>
                        <span>Calling LLM for analysis...</span>
                    </div>
                    <div id="step-5" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">5</span>
                        <span>Caching results...</span>
                    </div>
                </div>
            </div>

            <!-- Review Content (hidden until loaded) -->
            <div id="review-content" class="hidden space-y-4">
                <!-- Context -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Market Context</div>
                    <div class="flex flex-wrap gap-2">
                        <span id="review-regime" class="badge badge-primary"></span>
                        <span id="review-always-in" class="badge bg-purple-500/20 text-purple-400 border border-purple-500/30"></span>
                    </div>
                    <p id="review-context-desc" class="text-dark-300 mt-3 text-sm leading-relaxed"></p>
                </div>

                <!-- Setup -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Setup Classification</div>
                    <span id="review-setup" class="badge"></span>
                </div>

                <!-- What was good -->
                <div id="good-section" class="hidden bg-success-500/10 border border-success-500/30 rounded-xl p-4">
                    <div class="text-sm text-success-400 font-medium mb-2">‚úÖ What Was Good</div>
                    <ul id="good-list" class="space-y-1"></ul>
                </div>

                <!-- What was flawed -->
                <div id="flawed-section" class="hidden bg-danger-500/10 border border-danger-500/30 rounded-xl p-4">
                    <div class="text-sm text-danger-400 font-medium mb-2">‚ö†Ô∏è Areas to Improve</div>
                    <ul id="flawed-list" class="space-y-1"></ul>
                </div>

                <!-- Rule for next time -->
                <div id="rule-section" class="hidden bg-accent-500/10 border border-accent-500/30 rounded-xl p-4">
                    <div class="text-sm text-accent-400 font-medium mb-2">üìå Rule for Next Time</div>
                    <div id="rule-text" class="text-accent-200"></div>
                </div>

                <!-- Grade explanation -->
                <div id="grade-explanation" class="text-sm text-dark-400 italic mt-4"></div>
            </div>

            <!-- Error State -->
            <div id="review-error" class="hidden text-center py-12">
                <div class="text-4xl mb-3">ü§î</div>
                <p class="text-dark-300 mb-2" id="error-message">Review not available</p>
                <p class="text-sm text-dark-500">Check your LLM connection in Settings</p>
                <a href="/settings" class="btn btn-secondary mt-4">‚öôÔ∏è Check Settings</a>
            </div>
        </div>
    </div>

    <!-- Trade Intent Section (Brooks Audit) -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                üìã Trade Plan & Intent
            </h2>
            <span class="text-xs text-dark-500">For comprehensive Brooks Audit</span>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <!-- Trade Type -->
            <div>
                <label class="label">Trade Type</label>
                <select id="trade-type-field" class="select">
                    <option value="">Select...</option>
                    <option value="scalp" {% if trade.trade_type == 'scalp' %}selected{% endif %}>Scalp</option>
                    <option value="swing" {% if trade.trade_type == 'swing' %}selected{% endif %}>Swing</option>
                    <option value="position" {% if trade.trade_type == 'position' %}selected{% endif %}>Position</option>
                </select>
            </div>
            
            <!-- Confidence Level -->
            <div>
                <label class="label">Confidence (1-5)</label>
                <select id="confidence-field" class="select">
                    <option value="">Select...</option>
                    <option value="1" {% if trade.confidence_level == 1 %}selected{% endif %}>1 - Very Low</option>
                    <option value="2" {% if trade.confidence_level == 2 %}selected{% endif %}>2 - Low</option>
                    <option value="3" {% if trade.confidence_level == 3 %}selected{% endif %}>3 - Medium</option>
                    <option value="4" {% if trade.confidence_level == 4 %}selected{% endif %}>4 - High</option>
                    <option value="5" {% if trade.confidence_level == 5 %}selected{% endif %}>5 - Very High</option>
                </select>
            </div>
            
            <!-- Emotional State -->
            <div>
                <label class="label">Emotional State</label>
                <select id="emotional-state-field" class="select">
                    <option value="">Select...</option>
                    <option value="calm" {% if trade.emotional_state == 'calm' %}selected{% endif %}>üòå Calm</option>
                    <option value="focused" {% if trade.emotional_state == 'focused' %}selected{% endif %}>üéØ Focused</option>
                    <option value="rushed" {% if trade.emotional_state == 'rushed' %}selected{% endif %}>‚ö° Rushed</option>
                    <option value="fomo" {% if trade.emotional_state == 'fomo' %}selected{% endif %}>üò∞ FOMO</option>
                    <option value="revenge" {% if trade.emotional_state == 'revenge' %}selected{% endif %}>üò§ Revenge</option>
                    <option value="tired" {% if trade.emotional_state == 'tired' %}selected{% endif %}>üò¥ Tired</option>
                    <option value="anxious" {% if trade.emotional_state == 'anxious' %}selected{% endif %}>üòü Anxious</option>
                </select>
            </div>
            
            <!-- Followed Plan -->
            <div>
                <label class="label">Followed Plan?</label>
                <select id="followed-plan-field" class="select">
                    <option value="">Select...</option>
                    <option value="true" {% if trade.followed_plan == true %}selected{% endif %}>‚úÖ Yes</option>
                    <option value="false" {% if trade.followed_plan == false %}selected{% endif %}>‚ùå No</option>
                </select>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Stop Reason -->
            <div>
                <label class="label">üõë Stop Placement Reason</label>
                <textarea id="stop-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is your stop placed there? (Where setup is WRONG, not money stop)">{{ trade.stop_reason or '' }}</textarea>
            </div>
            
            <!-- Target Reason -->
            <div>
                <label class="label">üéØ Target Reason</label>
                <textarea id="target-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is your target placed there? (Swing high, range boundary, measured move?)">{{ trade.target_reason or '' }}</textarea>
            </div>
            
            <!-- Invalidation -->
            <div class="md:col-span-2">
                <label class="label">‚ö†Ô∏è Invalidation Condition</label>
                <textarea id="invalidation-field" rows="2" class="input resize-none" 
                    placeholder="What would prove this trade idea WRONG? When should you exit regardless of stop?">{{ trade.invalidation_condition or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Personal Notes Section -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                ‚úçÔ∏è My Notes & Review
            </h2>
            <button onclick="saveNotes()" class="btn btn-primary" id="save-notes-btn">
                üíæ Save All
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Entry Reason -->
            <div>
                <label class="label">üìà Entry Setup (Brooks Label)</label>
                <textarea id="entry-reason-field" rows="3" class="input resize-none" 
                    placeholder="What Brooks setup did you see? (e.g., H2 pullback, breakout pullback, failed breakout fade...)">{{ trade.entry_reason or '' }}</textarea>
            </div>
            
            <!-- General Notes -->
            <div>
                <label class="label">üìù Trade Notes</label>
                <textarea id="notes-field" rows="3" class="input resize-none" 
                    placeholder="What happened during this trade? Context, market behavior...">{{ trade.notes or '' }}</textarea>
            </div>
            
            <!-- Mistakes -->
            <div>
                <label class="label">‚ùå Mistakes Made</label>
                <textarea id="mistakes-field" rows="3" class="input resize-none" 
                    placeholder="What mistakes did you make? Selection error or execution error?">{{ trade.mistakes or '' }}</textarea>
            </div>
            
            <!-- Lessons -->
            <div>
                <label class="label">üí° Lessons Learned</label>
                <textarea id="lessons-field" rows="3" class="input resize-none" 
                    placeholder="What rule will you follow for the next 20 trades?">{{ trade.lessons or '' }}</textarea>
            </div>
        </div>
        
        <div id="notes-status" class="text-sm text-dark-500 mt-3 hidden"></div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-3">
        <a href="/trades" class="btn btn-secondary">‚Üê Back to Trades</a>
        <button onclick="refreshReview()" class="btn btn-primary">üîÑ Regenerate Review</button>
        <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">
            üóëÔ∏è Delete Trade
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const TRADE_ID = {{ trade.id }};

// Load review asynchronously when page loads
document.addEventListener('DOMContentLoaded', () => loadReview(false));

async function loadReview(force = false) {
    // Reset and show loading
    resetLoadingSteps();
    
    // Quick start toast only if generating new
    if (force) {
        showStartToast('Regenerating AI analysis');
        updateStep(1, 'active', 'Skipping cache (force refresh)...');
    } else {
        showStartToast('Loading review');
        updateStep(1, 'active', 'Checking cached review...');
    }
    
    try {
        // Simulate progress for better UX
        setTimeout(() => updateStep(1, 'done'), 300);
        setTimeout(() => updateStep(2, 'active', 'Fetching OHLCV data...'), 500);
        
        const url = force 
            ? `/api/trades/${TRADE_ID}/review?force=true`
            : `/api/trades/${TRADE_ID}/review`;
        const response = await fetch(url);
        const data = await response.json();
        
        document.getElementById('review-loading').classList.add('hidden');
        
        if (data.success && data.review) {
            displayReview(data.review);
            
            // Show cache status
            if (data.cached) {
                document.getElementById('cache-badge').classList.remove('hidden');
                showFinishToast('Review loaded', 'From cache (instant)');
            } else {
                document.getElementById('cache-badge').classList.add('hidden');
                const grade = data.review.grade || '?';
                const setup = data.review.setup_classification || 'analyzed';
                showFinishToast('AI analysis complete', `Grade ${grade}, ${setup}`);
            }
            
            // Show generated time
            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        } else {
            document.getElementById('review-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = data.error || 'Review not available';
            showToast(data.error || 'Review failed', 'error');
        }
    } catch (err) {
        document.getElementById('review-loading').classList.add('hidden');
        document.getElementById('review-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'Failed to load review: ' + err.message;
        showToast('AI analysis failed', 'error');
    }
}

function resetLoadingSteps() {
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step-${i}`);
        step.className = 'flex items-center gap-2 text-dark-500';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs';
    }
}

function updateStep(num, status, text) {
    const step = document.getElementById(`step-${num}`);
    if (!step) return;
    
    if (status === 'active') {
        step.className = 'flex items-center gap-2 text-accent-400';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-accent-500 bg-accent-500/20 flex items-center justify-center text-xs animate-pulse';
        document.getElementById('loading-status').textContent = text || 'Processing...';
    } else if (status === 'done') {
        step.className = 'flex items-center gap-2 text-success-400';
        step.querySelector('span:first-child').innerHTML = '‚úì';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full bg-success-500/20 border border-success-500 flex items-center justify-center text-xs';
    }
}

function displayReview(review) {
    // Show content
    document.getElementById('review-content').classList.remove('hidden');
    
    // Grade
    if (review.grade) {
        document.getElementById('review-grade').classList.remove('hidden');
        const gradeEl = document.getElementById('grade-value');
        gradeEl.textContent = review.grade;
        
        const gradeColors = {
            'A': 'text-success-400',
            'B': 'text-accent-400', 
            'C': 'text-amber-400',
            'D': 'text-orange-400',
            'F': 'text-danger-400'
        };
        gradeEl.className = 'text-3xl font-bold ' + (gradeColors[review.grade] || 'text-dark-300');
    }
    
    // Context
    document.getElementById('review-regime').textContent = review.regime || 'Unknown';
    document.getElementById('review-always-in').textContent = 'Always-In: ' + (review.always_in || 'Neutral');
    document.getElementById('review-context-desc').textContent = review.context_description || '';
    
    // Setup - use the consistent setup_classification (matches trade's strategy)
    const setupEl = document.getElementById('review-setup');
    let setupText = `${review.setup_classification || 'Unknown'} (${review.setup_quality || 'unknown'})`;
    
    // Show if AI suggested something different
    if (review.ai_setup_classification && 
        review.ai_setup_classification !== review.setup_classification &&
        review.ai_setup_classification.toLowerCase() !== 'insufficient_information') {
        setupText += ` [AI: ${review.ai_setup_classification}]`;
    }
    setupEl.textContent = setupText;
    
    const qualityClasses = {
        'good': 'badge-success',
        'marginal': 'badge-warning',
        'poor': 'bg-danger-500/20 text-danger-400 border border-danger-500/30'
    };
    setupEl.className = 'badge ' + (qualityClasses[review.setup_quality] || 'bg-dark-600');
    
    // What was good
    if (review.what_was_good && review.what_was_good.length > 0) {
        document.getElementById('good-section').classList.remove('hidden');
        const goodList = document.getElementById('good-list');
        goodList.innerHTML = review.what_was_good
            .map(item => `<li class="text-success-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // What was flawed
    if (review.what_was_flawed && review.what_was_flawed.length > 0) {
        document.getElementById('flawed-section').classList.remove('hidden');
        const flawedList = document.getElementById('flawed-list');
        flawedList.innerHTML = review.what_was_flawed
            .map(item => `<li class="text-danger-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // Rule
    if (review.rule_for_next_time) {
        document.getElementById('rule-section').classList.remove('hidden');
        document.getElementById('rule-text').textContent = review.rule_for_next_time;
    }
    
    // Grade explanation
    if (review.grade_explanation) {
        document.getElementById('grade-explanation').textContent = review.grade_explanation;
    }
}

async function saveNotes() {
    const btn = document.getElementById('save-notes-btn');
    const status = document.getElementById('notes-status');
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Saving...';
    
    // Collect all fields including Brooks intent fields
    const followedPlanVal = document.getElementById('followed-plan-field').value;
    
    const data = {
        // Notes
        notes: document.getElementById('notes-field').value,
        entry_reason: document.getElementById('entry-reason-field').value,
        mistakes: document.getElementById('mistakes-field').value,
        lessons: document.getElementById('lessons-field').value,
        // Brooks intent fields
        trade_type: document.getElementById('trade-type-field').value || null,
        confidence_level: document.getElementById('confidence-field').value ? parseInt(document.getElementById('confidence-field').value) : null,
        emotional_state: document.getElementById('emotional-state-field').value || null,
        followed_plan: followedPlanVal === 'true' ? true : (followedPlanVal === 'false' ? false : null),
        stop_reason: document.getElementById('stop-reason-field').value || null,
        target_reason: document.getElementById('target-reason-field').value || null,
        invalidation_condition: document.getElementById('invalidation-field').value || null,
    };
    
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/notes`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('Trade details saved!');
            status.textContent = '‚úì Saved just now';
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'üíæ Save All';
}

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    
    showStartToast('Deleting trade');
    const response = await fetch(`/api/trades/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
        showFinishToast('Trade deleted');
        setTimeout(() => window.location.href = '/trades', 800);
    } else {
        showToast('Failed to delete trade', 'error');
    }
}

function refreshReview() {
    document.getElementById('review-loading').classList.remove('hidden');
    document.getElementById('review-content').classList.add('hidden');
    document.getElementById('review-error').classList.add('hidden');
    document.getElementById('review-grade').classList.add('hidden');
    document.getElementById('cache-badge').classList.add('hidden');
    document.getElementById('review-meta').classList.add('hidden');
    loadReview(true);  // Force regenerate
}

// Strategy editing
function openStrategyModal() {
    document.getElementById('strategy-modal').classList.remove('hidden');
}

function closeStrategyModal() {
    document.getElementById('strategy-modal').classList.add('hidden');
}

async function saveTradeStrategy() {
    const strategyName = document.getElementById('strategy-input').value.trim();
    if (!strategyName) {
        showToast('Enter a strategy name', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/strategy`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ strategy_name: strategyName })
        });
        const data = await response.json();
        showToast(data.message, 'success');
        closeStrategyModal();
        setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
        showToast('Failed to update strategy', 'error');
    }
}
</script>

<!-- Strategy Edit Modal -->
<div id="strategy-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-dark-600">
        <h3 class="text-xl font-bold text-white mb-4">Edit Strategy</h3>
        <div class="space-y-4">
            <div>
                <label class="label">Strategy Name</label>
                <input type="text" id="strategy-input" class="input" 
                       value="{{ trade.strategy.name if trade.strategy else '' }}"
                       placeholder="e.g., H2_Pullback_Long">
            </div>
            {% if trade.ai_setup_classification %}
            <div class="text-sm text-dark-400">
                <span class="text-dark-500">Original AI classification:</span> 
                <span class="text-accent-400">{{ trade.ai_setup_classification }}</span>
                <button type="button" onclick="document.getElementById('strategy-input').value='{{ trade.ai_setup_classification }}'" 
                        class="text-xs text-dark-400 hover:text-accent-400 ml-2">‚Üê Use this</button>
            </div>
            {% endif %}
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeStrategyModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveTradeStrategy()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}
