{% extends "base.html" %}

{% block title %}Trade #{{ trade.trade_number or trade.id }} - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Link -->
    <a href="/trades" class="inline-flex items-center text-dark-400 hover:text-white transition-colors">
        <span class="mr-2">‚Üê</span> Back to Trades
    </a>

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-4xl font-bold text-white">{{ trade.ticker }}</h1>
                {% if trade.direction.value == 'long' %}
                    <span class="badge badge-success">‚ñ≤ LONG</span>
                {% else %}
                    <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">‚ñº SHORT</span>
                {% endif %}
            </div>
            <p class="text-dark-400 mt-1">
                Trade #{{ trade.trade_number or trade.id }} ‚Ä¢ {{ trade.trade_date }}
                {% if trade.market_timezone %}
                <span class="text-dark-500 text-xs ml-2">({{ trade.market_timezone.split('/')[-1] | replace('_', ' ') }})</span>
                {% endif %}
            </p>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-sm text-dark-400">R-Multiple</div>
                <div class="text-4xl font-bold font-mono {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                    {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                </div>
            </div>
            {% if trade.pnl_usd %}
            <div class="text-right">
                <div class="text-sm text-dark-400">P&L (USD)</div>
                <div class="text-2xl font-mono {% if trade.pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "+" if trade.pnl_usd > 0 else "" }}${{ "%.2f"|format(trade.pnl_usd) }}
                    {% if trade.currency and trade.currency != 'USD' %}
                        <span class="text-sm text-dark-400 block">({{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }})</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Trade Details -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    üìä Trade Details
                </h2>
                <button onclick="openEditTradeModal()" class="btn btn-secondary text-sm py-1.5 px-3">
                    ‚úèÔ∏è Edit
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Entry</div>
                    <div class="text-xl font-mono font-bold text-white">${{ "%.4f"|format(trade.entry_price) }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Exit</div>
                    <div class="text-xl font-mono font-bold text-white">${{ "%.4f"|format(trade.exit_price) if trade.exit_price else '-' }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Stop Loss</div>
                    <div class="text-xl font-mono font-bold text-white">
                        {% if trade.effective_stop_loss %}
                        ${{ "%.4f"|format(trade.effective_stop_loss) }}
                        {% else %}
                        <span class="text-dark-500">Not set</span>
                        {% endif %}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Take Profit</div>
                    <div class="text-xl font-mono font-bold text-white">
                        {% if trade.effective_take_profit %}
                        ${{ "%.4f"|format(trade.effective_take_profit) }}
                        {% else %}
                        <span class="text-dark-500">Not set</span>
                        {% endif %}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Size</div>
                    <div class="text-xl font-bold text-white">{{ "%.0f"|format(trade.size) if trade.size else '1' }}</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Duration</div>
                    <div class="text-lg font-mono text-white">{{ trade.duration_display }}</div>
                </div>
                {% if trade.entry_time %}
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Entry Time</div>
                    <div class="text-sm font-mono text-white">{{ trade.entry_time.strftime('%m/%d %H:%M:%S') }}</div>
                    {% if trade.input_timezone and trade.input_timezone != trade.market_timezone and trade.entry_time_local %}
                    <div class="text-xs text-dark-500 mt-1">({{ trade.entry_time_local.strftime('%H:%M:%S') }} {{ trade.input_timezone.split('/')[-1] | replace('_', ' ') }})</div>
                    {% endif %}
                </div>
                {% endif %}
                {% if trade.exit_time %}
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Exit Time</div>
                    <div class="text-sm font-mono text-white">{{ trade.exit_time.strftime('%m/%d %H:%M:%S') }}</div>
                    {% if trade.input_timezone and trade.input_timezone != trade.market_timezone and trade.exit_time_local %}
                    <div class="text-xs text-dark-500 mt-1">({{ trade.exit_time_local.strftime('%H:%M:%S') }} {{ trade.input_timezone.split('/')[-1] | replace('_', ' ') }})</div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Timeframe</div>
                    <div class="text-sm font-medium">
                        {% set tf = trade.timeframe or '5m' %}
                        {% if tf == '5m' %}
                            <span class="badge bg-purple-500/20 text-purple-400 border border-purple-500/30">5 min</span>
                        {% elif tf == '2h' %}
                            <span class="badge bg-amber-500/20 text-amber-400 border border-amber-500/30">2 hour</span>
                        {% elif tf == '1d' %}
                            <span class="badge bg-cyan-500/20 text-cyan-400 border border-cyan-500/30">Daily</span>
                        {% else %}
                            <span class="badge bg-dark-600 text-dark-300">{{ tf }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="stat-card overflow-hidden">
                    <div class="text-sm text-dark-400 mb-1">Strategy</div>
                    <div class="text-sm font-medium text-accent-400 truncate max-w-full" title="{{ trade.strategy.name if trade.strategy else 'Unclassified' }}">
                        {{ trade.strategy.name if trade.strategy else 'Unclassified' }}
                    </div>
                    {% if trade.ai_setup_classification and trade.strategy and trade.ai_setup_classification != trade.strategy.name %}
                    <div class="text-xs text-dark-500 mt-1 truncate" title="AI: {{ trade.ai_setup_classification }}">AI: {{ trade.ai_setup_classification }}</div>
                    {% endif %}
                    <button onclick="openStrategyModal()" class="text-xs text-dark-400 hover:text-accent-400 mt-1">‚úèÔ∏è Edit</button>
                </div>
                <div class="stat-card">
                    <div class="text-sm text-dark-400 mb-1">Result</div>
                    {% if trade.outcome %}
                        {% if trade.outcome.value == 'win' %}
                            <span class="win text-base">WIN</span>
                        {% elif trade.outcome.value == 'loss' %}
                            <span class="loss text-base">LOSS</span>
                        {% else %}
                            <span class="breakeven text-base">B/E</span>
                        {% endif %}
                    {% else %}
                        <span class="text-dark-500">-</span>
                    {% endif %}
                </div>
            </div>

            {% if trade.mae or trade.mfe %}
            <div class="mt-4 pt-4 border-t border-dark-700 grid grid-cols-2 gap-4">
                {% if trade.mae %}
                <div>
                    <div class="text-sm text-dark-400">MAE (Max Adverse)</div>
                    <div class="font-mono text-danger-400 text-lg">{{ "%.2f"|format(trade.mae) }}R</div>
                </div>
                {% endif %}
                {% if trade.mfe %}
                <div>
                    <div class="text-sm text-dark-400">MFE (Max Favorable)</div>
                    <div class="font-mono text-success-400 text-lg">{{ "%.2f"|format(trade.mfe) }}R</div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if trade.notes %}
            <div class="mt-4 pt-4 border-t border-dark-700">
                <div class="text-sm text-dark-400 mb-2">Notes</div>
                <div class="text-dark-200 bg-dark-900/50 rounded-lg p-3">{{ trade.notes }}</div>
            </div>
            {% endif %}

            {% if trade.entry_reason %}
            <div class="mt-4 pt-4 border-t border-dark-700">
                <div class="text-sm text-dark-400 mb-2">Entry Reason</div>
                <div class="text-dark-200 bg-dark-900/50 rounded-lg p-3">{{ trade.entry_reason }}</div>
            </div>
            {% endif %}
        </div>

        <!-- AI Review -->
        <div class="card" id="review-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    üß† AI Coaching Review
                    <span id="cache-badge" class="badge bg-dark-700 text-dark-400 text-xs hidden">Cached</span>
                </h2>
                <div class="flex items-center gap-3">
                    <div id="review-grade" class="flex items-center gap-2 hidden">
                        <span class="text-sm text-dark-400">Grade:</span>
                        <span id="grade-value" class="text-3xl font-bold"></span>
                    </div>
                </div>
            </div>
            <div id="review-meta" class="text-xs text-dark-500 mb-3 hidden">
                Generated: <span id="generated-at"></span>
            </div>

            <!-- Initial State - Show Generate Button -->
            <div id="review-initial" class="py-12 text-center">
                <div class="text-5xl mb-4">üß†</div>
                <h3 class="text-lg font-medium text-white mb-2">AI Coaching Review</h3>
                <p class="text-dark-400 text-sm mb-6 max-w-sm mx-auto">
                    Get Brooks-style analysis of your trade including setup classification, execution review, and coaching advice.
                </p>
                {% if has_materials %}
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/30 text-green-400 text-xs mb-4">
                    <span>üìö</span>
                    <span>Training materials active</span>
                </div>
                {% endif %}
                <div>
                    <button onclick="loadReview(false)" class="btn btn-primary text-lg px-8 py-3">
                        ‚ú® Generate Review
                    </button>
                </div>
                <p class="text-dark-500 text-xs mt-3">Uses cached review if available</p>
            </div>

            <!-- Loading State with Progress -->
            <div id="review-loading" class="py-8 hidden">
                <div class="loading-spinner w-10 h-10 border-4 border-accent-500 border-t-transparent mx-auto mb-4"></div>
                <p class="text-dark-300 text-center mb-4" id="loading-status">Initializing analysis...</p>
                
                <!-- Progress Steps -->
                <div class="space-y-2 max-w-md mx-auto text-sm">
                    <div id="step-1" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">1</span>
                        <span>Checking cached review...</span>
                    </div>
                    <div id="step-2" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">2</span>
                        <span>Fetching OHLCV data (Daily, 2H, 5min)...</span>
                    </div>
                    <div id="step-3" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">3</span>
                        <span>Building Brooks Audit prompt...</span>
                    </div>
                    <div id="step-4" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">4</span>
                        <span>Calling LLM for analysis...</span>
                    </div>
                    <div id="step-5" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">5</span>
                        <span>Caching results...</span>
                    </div>
                </div>
                
                <!-- Cancel Button -->
                <div class="mt-6 text-center">
                    <button onclick="cancelGeneration()" class="btn btn-secondary" id="cancel-btn">
                        ‚úï Cancel Generation
                    </button>
                </div>
            </div>

            <!-- Review Content (hidden until loaded) -->
            <div id="review-content" class="hidden space-y-4">
                <!-- Context -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Market Context</div>
                    <div class="flex flex-wrap gap-2">
                        <span id="review-regime" class="badge badge-primary"></span>
                        <span id="review-always-in" class="badge bg-purple-500/20 text-purple-400 border border-purple-500/30"></span>
                    </div>
                    <p id="review-context-desc" class="text-dark-300 mt-3 text-sm leading-relaxed"></p>
                </div>

                <!-- Setup -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Setup Classification</div>
                    <span id="review-setup" class="badge"></span>
                </div>

                <!-- What was good -->
                <div id="good-section" class="hidden bg-success-500/10 border border-success-500/30 rounded-xl p-4">
                    <div class="text-sm text-success-400 font-medium mb-2">‚úÖ What Was Good</div>
                    <ul id="good-list" class="space-y-1"></ul>
                </div>

                <!-- What was flawed -->
                <div id="flawed-section" class="hidden bg-danger-500/10 border border-danger-500/30 rounded-xl p-4">
                    <div class="text-sm text-danger-400 font-medium mb-2">‚ö†Ô∏è Areas to Improve</div>
                    <ul id="flawed-list" class="space-y-1"></ul>
                </div>

                <!-- Rules for next time -->
                <div id="rule-section" class="hidden bg-accent-500/10 border border-accent-500/30 rounded-xl p-4">
                    <div class="text-sm text-accent-400 font-medium mb-2">üìå Rules for Next Time</div>
                    <ul id="rule-list" class="space-y-1"></ul>
                </div>

                <!-- Grade explanation -->
                <div id="grade-explanation" class="text-sm text-dark-400 italic mt-4"></div>
                
                <!-- Regenerate button -->
                <div class="mt-6 pt-4 border-t border-dark-700 flex justify-end">
                    <button onclick="refreshReview()" class="btn btn-secondary">
                        üîÑ Regenerate Review
                    </button>
                </div>
            </div>

            <!-- Error State -->
            <div id="review-error" class="hidden text-center py-12">
                <div class="text-4xl mb-3">ü§î</div>
                <p class="text-dark-300 mb-2" id="error-message">Review not available</p>
                <p class="text-sm text-dark-500">Check your LLM connection in Settings</p>
                <a href="/settings" class="btn btn-secondary mt-4">‚öôÔ∏è Check Settings</a>
            </div>
        </div>
    </div>

    <!-- Trade Plan, Notes & Review (Merged Section) -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                üìã Trade Plan & Review
            </h2>
            <div class="flex items-center gap-3">
                <span class="text-xs text-dark-500">Brooks Audit</span>
                <button onclick="saveNotes()" class="btn btn-primary" id="save-notes-btn">
                    üíæ Save All
                </button>
            </div>
        </div>
        
        <!-- Row 1: Quick Selectors (Trade Type, Confidence, Emotional State, Followed Plan) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="label">Trade Type</label>
                <select id="trade-type-field" class="select">
                    <option value="">Select...</option>
                    <option value="scalp" {% if trade.trade_type == 'scalp' %}selected{% endif %}>Scalp</option>
                    <option value="swing" {% if trade.trade_type == 'swing' %}selected{% endif %}>Swing</option>
                    <option value="position" {% if trade.trade_type == 'position' %}selected{% endif %}>Position</option>
                </select>
            </div>
            <div>
                <label class="label">Confidence (1-5)</label>
                <select id="confidence-field" class="select">
                    <option value="">Select...</option>
                    <option value="1" {% if trade.confidence_level == 1 %}selected{% endif %}>1 - Very Low</option>
                    <option value="2" {% if trade.confidence_level == 2 %}selected{% endif %}>2 - Low</option>
                    <option value="3" {% if trade.confidence_level == 3 %}selected{% endif %}>3 - Medium</option>
                    <option value="4" {% if trade.confidence_level == 4 %}selected{% endif %}>4 - High</option>
                    <option value="5" {% if trade.confidence_level == 5 %}selected{% endif %}>5 - Very High</option>
                </select>
            </div>
            <div>
                <label class="label">Emotional State</label>
                <select id="emotional-state-field" class="select">
                    <option value="">Select...</option>
                    <option value="calm" {% if trade.emotional_state == 'calm' %}selected{% endif %}>üòå Calm</option>
                    <option value="focused" {% if trade.emotional_state == 'focused' %}selected{% endif %}>üéØ Focused</option>
                    <option value="rushed" {% if trade.emotional_state == 'rushed' %}selected{% endif %}>‚ö° Rushed</option>
                    <option value="fomo" {% if trade.emotional_state == 'fomo' %}selected{% endif %}>üò∞ FOMO</option>
                    <option value="revenge" {% if trade.emotional_state == 'revenge' %}selected{% endif %}>üò§ Revenge</option>
                    <option value="tired" {% if trade.emotional_state == 'tired' %}selected{% endif %}>üò¥ Tired</option>
                    <option value="anxious" {% if trade.emotional_state == 'anxious' %}selected{% endif %}>üòü Anxious</option>
                </select>
            </div>
            <div>
                <label class="label">Followed Plan?</label>
                <select id="followed-plan-field" class="select">
                    <option value="">Select...</option>
                    <option value="true" {% if trade.followed_plan == true %}selected{% endif %}>‚úÖ Yes</option>
                    <option value="false" {% if trade.followed_plan == false %}selected{% endif %}>‚ùå No</option>
                </select>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Market Context & Entry Analysis -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üìä Market Context & Entry Analysis
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 1. Trend Assessment -->
            <div class="md:col-span-2">
                <label class="label">1Ô∏è‚É£ My Assessment of Current Trend (Major & Minor)</label>
                <textarea id="trend-assessment-field" rows="2" class="input resize-none" 
                    placeholder="Major trend: Uptrend/Downtrend/Range. Minor trend: Pullback/Rally/Breakout. Where are we in the trend?">{{ trade.trend_assessment or '' }}</textarea>
            </div>
            
            <!-- 2. Entry Setup (Brooks Label) -->
            <div>
                <label class="label">2Ô∏è‚É£ Entry Setup (Brooks Label)</label>
                <textarea id="entry-reason-field" rows="2" class="input resize-none" 
                    placeholder="What Brooks setup? (H2 pullback, breakout pullback, failed BO fade, wedge reversal...)">{{ trade.entry_reason or '' }}</textarea>
            </div>
            
            <!-- 3. Reason for Entry -->
            <div>
                <label class="label">3Ô∏è‚É£ Reason for Entry</label>
                <textarea id="signal-reason-field" rows="2" class="input resize-none" 
                    placeholder="Strong Signal Bar, BO & Follow-thru, High 2, Low 2, Gap setup, 2nd entry...">{{ trade.signal_reason or '' }}</textarea>
            </div>
            
            <!-- 4. Was There a Signal? -->
            <div>
                <label class="label">4Ô∏è‚É£ Was There a Signal? If Not, Why?</label>
                <textarea id="was-signal-field" rows="2" class="input resize-none" 
                    placeholder="Did you wait for the signal bar? If you entered without a signal, why?">{{ trade.was_signal_present or '' }}</textarea>
            </div>
            
            <!-- 5. Strategy Alignment & Invalidation -->
            <div>
                <label class="label">5Ô∏è‚É£ Does this entry align with all the criteria of the chosen strategt? Any invalidation?</label>
                <textarea id="strategy-alignment-field" rows="2" class="input resize-none" 
                    placeholder="Does entry align with all criteria? Any invalidation condition met? What would prove trade wrong?">{{ trade.strategy_alignment or trade.invalidation_condition or '' }}</textarea>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Risk & Targets -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üéØ Risk Management & Targets
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 7. Target Reason -->
            <div>
                <label class="label">7Ô∏è‚É£ Where is my TP, why?</label>
                <textarea id="target-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is TP placed there? (Swing high, range boundary, measured move, magnet?)">{{ trade.target_reason or '' }}</textarea>
            </div>
            
            <!-- 8. Stop Placement Reason -->
            <div>
                <label class="label">8Ô∏è‚É£ Where is my SL, why?</label>
                <textarea id="stop-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is SL placed there? (Where setup is WRONG, below signal bar, below swing low?)">{{ trade.stop_reason or '' }}</textarea>
            </div>
            
            <!-- 9. Entry-TP Distance -->
            <div class="md:col-span-2">
                <label class="label">9Ô∏è‚É£ Are Entry and TP Too Far Apart?</label>
                <textarea id="entry-tp-distance-field" rows="2" class="input resize-none" 
                    placeholder="Is the R:R realistic? Is the target too ambitious? Would you scale out?">{{ trade.entry_tp_distance or '' }}</textarea>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Execution & Psychology -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üß† Execution & Psychology
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 10. Entry/Exit Emotions -->
            <div class="md:col-span-2">
                <label class="label">üîü Emotions at Entry & Exit (Any Hesitation?)</label>
                <textarea id="entry-exit-emotions-field" rows="2" class="input resize-none" 
                    placeholder="How did you feel entering? Exiting? Any hesitation? Fear? Greed? Rushed?">{{ trade.entry_exit_emotions or '' }}</textarea>
            </div>
            
            <!-- 6. Mistakes Made & Lessons Learned (Merged) -->
            <div class="md:col-span-2">
                <label class="label">6Ô∏è‚É£ Mistakes Made & Lessons Learned (Why did trade succeed/fail?)</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="mistakes-field" rows="3" class="input resize-none" 
                        placeholder="Mistakes: Selection error? Execution error? Entered too early/late?">{{ trade.mistakes or '' }}</textarea>
                    <textarea id="lessons-field" rows="3" class="input resize-none" 
                        placeholder="Lessons: What rule for next 20 trades? What would you do differently?">{{ trade.lessons or '' }}</textarea>
                </div>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: General Notes -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üìù Trade Notes
        </h3>
        
        <div class="mb-4">
            <!-- 11. Trade Notes -->
            <textarea id="notes-field" rows="4" class="input resize-none w-full" 
                placeholder="General notes about the trade. What happened? Context, market behavior, anything else...">{{ trade.notes or '' }}</textarea>
        </div>
        
        <div id="notes-status" class="text-sm text-dark-500 mt-3 hidden"></div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-3">
        <a href="/trades" class="btn btn-secondary">‚Üê Back to Trades</a>
        <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">
            üóëÔ∏è Delete Trade
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const TRADE_ID = {{ trade.id }};

// Check if there's already a cached review or in-progress generation on page load
document.addEventListener('DOMContentLoaded', () => checkExistingReview());

let pollingInterval = null;
let abortController = null;
let isCancelled = false;

async function checkExistingReview() {
    // Quick check if there's a cached review or in-progress generation
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/review?check_only=true`);
        const data = await response.json();
        
        if (data.in_progress) {
            // There's a generation in progress, show loading and poll
            document.getElementById('review-initial').classList.add('hidden');
            document.getElementById('review-loading').classList.remove('hidden');
            updateStep(3, 'active', 'AI analysis in progress...');
            pollingInterval = setInterval(() => pollForReview(), 3000);
        } else if (data.success && data.review) {
            // There's a cached review, display it
            document.getElementById('review-initial').classList.add('hidden');
            displayReview(data.review);
            document.getElementById('cache-badge').classList.remove('hidden');
            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        }
        // Otherwise, show the initial "Generate Review" button (already visible by default)
    } catch (err) {
        console.log('No existing review found');
    }
}

async function loadReview(force = false) {
    // Reset cancel state
    isCancelled = false;
    abortController = new AbortController();
    
    // Reset and show loading
    resetLoadingSteps();
    document.getElementById('review-initial').classList.add('hidden');
    document.getElementById('review-loading').classList.remove('hidden');
    document.getElementById('review-content').classList.add('hidden');
    document.getElementById('review-error').classList.add('hidden');

    // Quick start toast only if generating new
    if (force) {
        showStartToast('Regenerating AI analysis');
        updateStep(1, 'active', 'Skipping cache (force refresh)...');
    } else {
        showStartToast('Loading review');
        updateStep(1, 'active', 'Checking cached review...');
    }

    try {
        // Simulate progress for better UX
        setTimeout(() => { if (!isCancelled) updateStep(1, 'done'); }, 300);
        setTimeout(() => { if (!isCancelled) updateStep(2, 'active', 'Fetching OHLCV data...'); }, 500);

        const url = force
            ? `/api/trades/${TRADE_ID}/review?force=true`
            : `/api/trades/${TRADE_ID}/review`;
        const response = await fetch(url, { signal: abortController.signal });
        
        if (isCancelled) return;
        
        const data = await response.json();

        // Handle "in progress" status - start polling
        if (data.success && data.in_progress) {
            updateStep(2, 'done');
            updateStep(3, 'active', 'AI analysis in progress...');
            showToast('Review generation in progress...', 'info', 5000);
            
            // Start polling every 3 seconds
            if (!pollingInterval) {
                pollingInterval = setInterval(() => pollForReview(), 3000);
            }
            return;
        }

        // Clear polling if we got a result
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        document.getElementById('review-loading').classList.add('hidden');

        if (data.success && data.review) {
            displayReview(data.review);

            // Show cache status
            if (data.cached) {
                document.getElementById('cache-badge').classList.remove('hidden');
                showFinishToast('Review loaded', 'From cache (instant)');
            } else {
                document.getElementById('cache-badge').classList.add('hidden');
                const grade = data.review.grade || '?';
                const setup = data.review.setup_classification || 'analyzed';
                showFinishToast('AI analysis complete', `Grade ${grade}, ${setup}`);
            }

            // Show generated time
            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        } else {
            document.getElementById('review-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = data.error || 'Review not available';
            showToast(data.error || 'Review failed', 'error');
        }
    } catch (err) {
        if (err.name === 'AbortError') {
            // User cancelled - show initial state again
            document.getElementById('review-loading').classList.add('hidden');
            document.getElementById('review-initial').classList.remove('hidden');
            showToast('Generation cancelled', 'info');
            return;
        }
        
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        document.getElementById('review-loading').classList.add('hidden');
        document.getElementById('review-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'Failed to load review: ' + err.message;
        showToast('AI analysis failed', 'error');
    }
}

async function cancelGeneration() {
    isCancelled = true;
    
    // Abort ongoing fetch
    if (abortController) {
        abortController.abort();
    }
    
    // Stop polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    
    // Try to cancel on the server side
    try {
        await fetch(`/api/trades/${TRADE_ID}/review/cancel`, { method: 'POST' });
    } catch (err) {
        console.log('Cancel request sent');
    }
    
    // Reset UI to initial state
    document.getElementById('review-loading').classList.add('hidden');
    document.getElementById('review-initial').classList.remove('hidden');
    showToast('Generation cancelled', 'info');
}

async function pollForReview() {
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/review`);
        const data = await response.json();

        // Still in progress - keep polling
        if (data.success && data.in_progress) {
            updateStep(3, 'active', 'Still generating... please wait');
            return;
        }

        // Clear polling
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        document.getElementById('review-loading').classList.add('hidden');

        if (data.success && data.review) {
            displayReview(data.review);
            document.getElementById('cache-badge').classList.add('hidden');
            const grade = data.review.grade || '?';
            const setup = data.review.setup_classification || 'analyzed';
            showFinishToast('AI analysis complete', `Grade ${grade}, ${setup}`);

            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        } else {
            document.getElementById('review-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = data.error || 'Review not available';
        }
    } catch (err) {
        // Keep polling on network errors
        console.error('Polling error:', err);
    }
}

function resetLoadingSteps() {
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step-${i}`);
        step.className = 'flex items-center gap-2 text-dark-500';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs';
    }
}

function updateStep(num, status, text) {
    const step = document.getElementById(`step-${num}`);
    if (!step) return;
    
    if (status === 'active') {
        step.className = 'flex items-center gap-2 text-accent-400';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-accent-500 bg-accent-500/20 flex items-center justify-center text-xs animate-pulse';
        document.getElementById('loading-status').textContent = text || 'Processing...';
    } else if (status === 'done') {
        step.className = 'flex items-center gap-2 text-success-400';
        step.querySelector('span:first-child').innerHTML = '‚úì';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full bg-success-500/20 border border-success-500 flex items-center justify-center text-xs';
    }
}

function displayReview(review) {
    // Show content
    document.getElementById('review-content').classList.remove('hidden');
    
    // Grade
    if (review.grade) {
        document.getElementById('review-grade').classList.remove('hidden');
        const gradeEl = document.getElementById('grade-value');
        gradeEl.textContent = review.grade;
        
        const gradeColors = {
            'A': 'text-success-400',
            'B': 'text-accent-400', 
            'C': 'text-amber-400',
            'D': 'text-orange-400',
            'F': 'text-danger-400'
        };
        gradeEl.className = 'text-3xl font-bold ' + (gradeColors[review.grade] || 'text-dark-300');
    }
    
    // Context
    document.getElementById('review-regime').textContent = review.regime || 'Unknown';
    document.getElementById('review-always-in').textContent = 'Always-In: ' + (review.always_in || 'Neutral');
    document.getElementById('review-context-desc').textContent = review.context_description || '';
    
    // Setup - use the consistent setup_classification (matches trade's strategy)
    const setupEl = document.getElementById('review-setup');
    let setupText = `${review.setup_classification || 'Unknown'} (${review.setup_quality || 'unknown'})`;
    
    // Show if AI suggested something different
    if (review.ai_setup_classification && 
        review.ai_setup_classification !== review.setup_classification &&
        review.ai_setup_classification.toLowerCase() !== 'insufficient_information') {
        setupText += ` [AI: ${review.ai_setup_classification}]`;
    }
    setupEl.textContent = setupText;
    
    const qualityClasses = {
        'good': 'badge-success',
        'marginal': 'badge-warning',
        'poor': 'bg-danger-500/20 text-danger-400 border border-danger-500/30'
    };
    setupEl.className = 'badge ' + (qualityClasses[review.setup_quality] || 'bg-dark-600');
    
    // What was good
    if (review.what_was_good && review.what_was_good.length > 0) {
        document.getElementById('good-section').classList.remove('hidden');
        const goodList = document.getElementById('good-list');
        goodList.innerHTML = review.what_was_good
            .map(item => `<li class="text-success-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // What was flawed
    if (review.what_was_flawed && review.what_was_flawed.length > 0) {
        document.getElementById('flawed-section').classList.remove('hidden');
        const flawedList = document.getElementById('flawed-list');
        flawedList.innerHTML = review.what_was_flawed
            .map(item => `<li class="text-danger-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // Rules - handle both array (new) and string (old cached) formats
    if (review.rule_for_next_time) {
        let rules = review.rule_for_next_time;
        // Convert string to array if needed (old cached format)
        if (typeof rules === 'string') {
            rules = rules ? [rules] : [];
        }
        if (rules.length > 0) {
            document.getElementById('rule-section').classList.remove('hidden');
            const ruleList = document.getElementById('rule-list');
            ruleList.innerHTML = rules
                .map(item => `<li class="text-accent-200 text-sm">‚Ä¢ ${item}</li>`)
                .join('');
        }
    }
    
    // Grade explanation
    if (review.grade_explanation) {
        document.getElementById('grade-explanation').textContent = review.grade_explanation;
    }
}

async function saveNotes() {
    const btn = document.getElementById('save-notes-btn');
    const status = document.getElementById('notes-status');

    btn.disabled = true;
    btn.textContent = '‚è≥ Saving...';

    // Collect all fields including Brooks intent fields
    const followedPlanVal = document.getElementById('followed-plan-field').value;

    const data = {
        // Basic notes
        notes: document.getElementById('notes-field').value,
        entry_reason: document.getElementById('entry-reason-field').value,
        mistakes: document.getElementById('mistakes-field').value,
        lessons: document.getElementById('lessons-field').value,
        // Quick selectors
        trade_type: document.getElementById('trade-type-field').value || null,
        confidence_level: document.getElementById('confidence-field').value ? parseInt(document.getElementById('confidence-field').value) : null,
        emotional_state: document.getElementById('emotional-state-field').value || null,
        followed_plan: followedPlanVal === 'true' ? true : (followedPlanVal === 'false' ? false : null),
        // Risk & Targets
        stop_reason: document.getElementById('stop-reason-field').value || null,
        target_reason: document.getElementById('target-reason-field').value || null,
        // Extended Brooks analysis fields
        trend_assessment: document.getElementById('trend-assessment-field').value || null,
        signal_reason: document.getElementById('signal-reason-field').value || null,
        was_signal_present: document.getElementById('was-signal-field').value || null,
        strategy_alignment: document.getElementById('strategy-alignment-field').value || null,
        entry_exit_emotions: document.getElementById('entry-exit-emotions-field').value || null,
        entry_tp_distance: document.getElementById('entry-tp-distance-field').value || null,
    };

    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/notes`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast('Trade details saved!');
            status.textContent = '‚úì Saved just now';
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'üíæ Save All';
}

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    
    showStartToast('Deleting trade');
    const response = await fetch(`/api/trades/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
        showFinishToast('Trade deleted');
        setTimeout(() => window.location.href = '/trades', 800);
    } else {
        showToast('Failed to delete trade', 'error');
    }
}

function refreshReview() {
    document.getElementById('review-initial').classList.add('hidden');
    document.getElementById('review-loading').classList.remove('hidden');
    document.getElementById('review-content').classList.add('hidden');
    document.getElementById('review-error').classList.add('hidden');
    document.getElementById('review-grade').classList.add('hidden');
    document.getElementById('cache-badge').classList.add('hidden');
    document.getElementById('review-meta').classList.add('hidden');
    loadReview(true);  // Force regenerate
}

// Strategy editing
function openStrategyModal() {
    document.getElementById('strategy-modal').classList.remove('hidden');
}

function closeStrategyModal() {
    document.getElementById('strategy-modal').classList.add('hidden');
}

async function saveTradeStrategy() {
    const strategyName = document.getElementById('strategy-input').value.trim();
    if (!strategyName) {
        showToast('Enter a strategy name', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/strategy`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ strategy_name: strategyName })
        });
        const data = await response.json();
        showToast(data.message, 'success');
        closeStrategyModal();
        setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
        showToast('Failed to update strategy', 'error');
    }
}

// Edit Trade Details
const currentTradeDate = '{{ trade.exit_time.strftime("%Y-%m-%d") if trade.exit_time else trade.entry_time.strftime("%Y-%m-%d") if trade.entry_time else "" }}';

function openEditTradeModal() {
    document.getElementById('edit-trade-modal').classList.remove('hidden');
}

function closeEditTradeModal() {
    document.getElementById('edit-trade-modal').classList.add('hidden');
}

async function fetchHistoricalRate() {
    const currency = document.getElementById('edit-currency').value;
    if (currency === 'USD') {
        document.getElementById('edit-rate').value = 1.0;
        return;
    }
    
    const date = currentTradeDate || new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/api/exchange-rate?currency=${currency}&date=${date}`);
        const data = await response.json();
        
        if (data.rate) {
            document.getElementById('edit-rate').value = data.rate;
            showToast(`Rate fetched: 1 USD = ${data.rate} ${currency}`, 'success');
        } else {
            showToast('Could not fetch rate', 'error');
        }
    } catch (err) {
        showToast('Error fetching rate', 'error');
    }
}

// Auto-fetch rate when currency changes
document.getElementById('edit-currency').addEventListener('change', fetchHistoricalRate);

// Form submission handler
document.getElementById('edit-trade-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const slValue = document.getElementById('edit-stop-loss').value;
    const tpValue = document.getElementById('edit-take-profit').value;
    
    const payload = {
        size: parseFloat(document.getElementById('edit-size').value),
        entry_price: parseFloat(document.getElementById('edit-entry-price').value),
        exit_price: parseFloat(document.getElementById('edit-exit-price').value),
        stop_loss: slValue ? parseFloat(slValue) : null,
        take_profit: tpValue ? parseFloat(tpValue) : null,
        currency: document.getElementById('edit-currency').value,
        currency_rate: parseFloat(document.getElementById('edit-rate').value),
        entry_time: document.getElementById('edit-entry-time').value || null,
        exit_time: document.getElementById('edit-exit-time').value || null,
        timeframe: document.getElementById('edit-timeframe').value,
    };

    try {
        const response = await fetch(`/api/trades/${TRADE_ID}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            showToast('Trade updated!', 'success');
            closeEditTradeModal();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const err = await response.json();
            showToast('Error: ' + (err.detail || 'Failed to update'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
});
</script>

<!-- Edit Trade Details Modal -->
<div id="edit-trade-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="card w-full max-w-lg animate-fadeIn my-8">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white">Edit Trade #{{ trade.trade_number or trade.id }}</h3>
                <p class="text-sm text-dark-400">{{ trade.exit_time.strftime('%Y-%m-%d') if trade.exit_time else trade.entry_time.strftime('%Y-%m-%d') if trade.entry_time else '' }}</p>
            </div>
            <button onclick="closeEditTradeModal()" class="btn btn-ghost text-2xl p-2">&times;</button>
        </div>

        <form id="edit-trade-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Time</label>
                    <input type="datetime-local" id="edit-entry-time" step="1" class="input text-sm"
                           value="{{ trade.entry_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.entry_time else '' }}">
                </div>
                <div>
                    <label class="label">Exit Time</label>
                    <input type="datetime-local" id="edit-exit-time" step="1" class="input text-sm"
                           value="{{ trade.exit_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.exit_time else '' }}">
                </div>
            </div>

            <div>
                <label class="label">Shares</label>
                <input type="number" id="edit-size" step="1" min="1" class="input"
                       value="{{ trade.size or 1 }}">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Price</label>
                    <input type="number" id="edit-entry-price" step="0.0001" min="0" class="input"
                           value="{{ trade.entry_price }}">
                </div>
                <div>
                    <label class="label">Exit Price</label>
                    <input type="number" id="edit-exit-price" step="0.0001" min="0" class="input"
                           value="{{ trade.exit_price or '' }}">
                </div>
                <div>
                    <label class="label">Stop Loss (SL)</label>
                    <input type="number" id="edit-stop-loss" step="0.0001" min="0" class="input" placeholder="Where trade is wrong"
                           value="{{ trade.stop_loss or '' }}">
                </div>
                <div>
                    <label class="label">Take Profit (TP)</label>
                    <input type="number" id="edit-take-profit" step="0.0001" min="0" class="input" placeholder="Target exit"
                           value="{{ trade.take_profit or '' }}">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Timeframe</label>
                    <select id="edit-timeframe" class="select">
                        <option value="5m" {% if trade.timeframe == '5m' or not trade.timeframe %}selected{% endif %}>5 min (Scalp)</option>
                        <option value="2h" {% if trade.timeframe == '2h' %}selected{% endif %}>2 hour (Swing)</option>
                        <option value="1d" {% if trade.timeframe == '1d' %}selected{% endif %}>Daily (Position)</option>
                    </select>
                    <p class="text-xs text-dark-500 mt-1">Used for AI context data</p>
                </div>
                <div>
                    <label class="label">Currency</label>
                    <select id="edit-currency" class="select">
                        <option value="USD" {% if trade.currency == 'USD' or not trade.currency %}selected{% endif %}>USD ($)</option>
                        <option value="HKD" {% if trade.currency == 'HKD' %}selected{% endif %}>HKD (HK$)</option>
                        <option value="EUR" {% if trade.currency == 'EUR' %}selected{% endif %}>EUR (‚Ç¨)</option>
                        <option value="GBP" {% if trade.currency == 'GBP' %}selected{% endif %}>GBP (¬£)</option>
                        <option value="JPY" {% if trade.currency == 'JPY' %}selected{% endif %}>JPY (¬•)</option>
                        <option value="CNY" {% if trade.currency == 'CNY' %}selected{% endif %}>CNY (¬•)</option>
                        <option value="CAD" {% if trade.currency == 'CAD' %}selected{% endif %}>CAD (C$)</option>
                        <option value="AUD" {% if trade.currency == 'AUD' %}selected{% endif %}>AUD (A$)</option>
                    </select>
                </div>
                <div>
                    <label class="label">Rate to USD</label>
                    <div class="flex space-x-2">
                        <input type="number" id="edit-rate" step="0.0001" min="0" class="input flex-1"
                               value="{{ trade.currency_rate or 1.0 }}">
                        <button type="button" onclick="fetchHistoricalRate()" class="btn btn-secondary">üîÑ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-dark-700">
                <button type="button" onclick="closeEditTradeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Strategy Edit Modal -->
<div id="strategy-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-dark-600">
        <h3 class="text-xl font-bold text-white mb-4">Edit Strategy</h3>
        <div class="space-y-4">
            <div>
                <label class="label">Strategy Name</label>
                <input type="text" id="strategy-input" class="input" 
                       value="{{ trade.strategy.name if trade.strategy else '' }}"
                       placeholder="e.g., H2_Pullback_Long">
            </div>
            {% if trade.ai_setup_classification %}
            <div class="text-sm text-dark-400">
                <span class="text-dark-500">Original AI classification:</span> 
                <span class="text-accent-400">{{ trade.ai_setup_classification }}</span>
                <button type="button" onclick="document.getElementById('strategy-input').value='{{ trade.ai_setup_classification }}'" 
                        class="text-xs text-dark-400 hover:text-accent-400 ml-2">‚Üê Use this</button>
            </div>
            {% endif %}
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeStrategyModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveTradeStrategy()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}
