{% extends "base.html" %}

{% block title %}Trade #{{ trade.trade_number or trade.id }} - Brooks Trading Coach{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Link -->
    <a href="/trades" class="inline-flex items-center text-dark-400 hover:text-white transition-colors">
        <span class="mr-2">‚Üê</span> Back to Trades
    </a>

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-4xl font-bold text-white">{{ trade.ticker | ticker_display }}</h1>
                {% if trade.ticker | ticker_exchange %}
                <span class="text-sm text-dark-400">({{ trade.ticker | ticker_exchange }})</span>
                {% endif %}
                {% if trade.direction.value == 'long' %}
                    <span class="badge badge-success">‚ñ≤ LONG</span>
                {% else %}
                    <span class="badge bg-danger-500/20 text-danger-400 border border-danger-500/30">‚ñº SHORT</span>
                {% endif %}
            </div>
            <p class="text-dark-400 mt-1">
                Trade #{{ trade.trade_number or trade.id }} ‚Ä¢ {{ trade.trade_date }}
                {% if trade.market_timezone %}
                <span class="text-dark-500 text-xs ml-2">({{ trade.market_timezone.split('/')[-1] | replace('_', ' ') }})</span>
                {% endif %}
            </p>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-sm text-dark-400">R-Multiple</div>
                <div class="text-4xl font-bold font-mono {% if trade.r_multiple and trade.r_multiple >= 0 %}positive{% else %}negative{% endif %}">
                    {% if trade.r_multiple %}{{ "%.2f"|format(trade.r_multiple) }}R{% else %}-{% endif %}
                </div>
            </div>
            {% if trade.pnl_usd %}
            <div class="text-right">
                <div class="text-sm text-dark-400">P&L (USD)</div>
                <div class="text-2xl font-mono {% if trade.pnl_usd >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "+" if trade.pnl_usd > 0 else "" }}${{ "%.2f"|format(trade.pnl_usd) }}
                    {% if trade.currency and trade.currency != 'USD' %}
                        <span class="text-sm text-dark-400 block">({{ trade.currency }} {{ "%.2f"|format(trade.pnl_dollars) }})</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick navigation -->
    <div class="flex flex-wrap gap-2">
        <a href="#chart" class="btn btn-ghost text-sm px-3 py-2">üìà Chart</a>
        <a href="#details" class="btn btn-ghost text-sm px-3 py-2">üìä Details</a>
        <a href="#ai-review" class="btn btn-ghost text-sm px-3 py-2">üß† AI Review</a>
        <a href="#journal" class="btn btn-ghost text-sm px-3 py-2">üìã Journal</a>
        <a href="#notes" class="btn btn-ghost text-sm px-3 py-2">üìù Notes</a>
    </div>

    <!-- TradingView Chart -->
    <div id="chart" class="card">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                üìà Price Chart
            </h2>
            <div class="flex items-center gap-2 flex-wrap">
                <select id="chart-timeframe" class="select text-sm py-1.5 px-3" onchange="loadChartData()">
                    <option value="5m" {% if trade.timeframe == '5m' or not trade.timeframe %}selected{% endif %}>5 min</option>
                    <option value="15m">15 min</option>
                    <option value="1h">1 hour</option>
                    <option value="2h" {% if trade.timeframe == '2h' %}selected{% endif %}>2 hour</option>
                    <option value="1d" {% if trade.timeframe == '1d' %}selected{% endif %}>Daily</option>
                </select>
                
                <!-- RTH/ETH Toggle -->
                <div class="flex items-center gap-1 px-2 py-1 bg-dark-700 rounded-lg">
                    <button id="btn-rth" onclick="setRthMode(true)" class="text-xs px-2 py-1 rounded bg-accent-600 text-white" title="Regular Trading Hours (9:30 AM - 4:00 PM)">
                        RTH
                    </button>
                    <button id="btn-eth" onclick="setRthMode(false)" class="text-xs px-2 py-1 rounded text-dark-400 hover:text-white" title="Electronic Trading Hours (includes overnight)">
                        ETH
                    </button>
                </div>
                
                <!-- Show After Entry Toggle -->
                <label class="flex items-center gap-1 text-xs text-dark-400 cursor-pointer">
                    <input type="checkbox" id="show-after-entry" onchange="loadChartData()" class="rounded">
                    <span title="Show bars after entry (see outcome)">After Entry</span>
                </label>
                
                <button onclick="loadChartData()" class="btn btn-secondary text-sm py-1.5 px-3">
                    üîÑ
                </button>
            </div>
        </div>
        <div id="chart-container" class="w-full h-96 bg-dark-900 rounded-lg relative">
            <div id="chart-loading" class="absolute inset-0 flex items-center justify-center">
                <div class="loading-spinner w-8 h-8 border-4 border-accent-500 border-t-transparent"></div>
            </div>
            <div id="tradingview-chart" class="w-full h-full"></div>
            <!-- OHLC Legend (shows on hover) - dark background for both modes -->
            <div id="ohlc-legend" class="absolute top-2 left-2 backdrop-blur-sm rounded px-3 py-1.5 text-xs font-mono z-10 hidden" style="background-color: rgba(17, 24, 39, 0.95); border: 1px solid #374151;">
                <span id="ohlc-time" style="color: #ffffff; margin-right: 12px;"></span>
                <span style="color: #ffffff;">O:</span><span id="ohlc-open" style="color: #ffffff; margin-left: 4px; margin-right: 8px;"></span>
                <span style="color: #ffffff;">H:</span><span id="ohlc-high" style="color: #ffffff; margin-left: 4px; margin-right: 8px;"></span>
                <span style="color: #ffffff;">L:</span><span id="ohlc-low" style="color: #ffffff; margin-left: 4px; margin-right: 8px;"></span>
                <span style="color: #ffffff;">C:</span><span id="ohlc-close" style="color: #ffffff; margin-left: 4px; margin-right: 8px;"></span>
                <span style="color: #ffffff;">Vol:</span><span id="ohlc-volume" style="color: #ffffff; margin-left: 4px; margin-right: 12px;"></span>
                <span style="color: #ffffff;">Bar:</span><span id="ohlc-barnum" style="color: #facc15; margin-left: 4px;"></span>
            </div>
        </div>
        <div class="mt-3 flex items-center gap-4 text-sm text-dark-400">
            <div class="flex items-center gap-2">
                {% if trade.direction.value == 'long' %}
                <span class="w-3 h-3 rounded-full" style="background-color: #26a69a;"></span>
                <span>BUY: ${{ "%.4f"|format(trade.entry_price) }}</span>
                {% else %}
                <span class="w-3 h-3 rounded-full" style="background-color: #ef5350;"></span>
                <span>SELL: ${{ "%.4f"|format(trade.entry_price) }}</span>
                {% endif %}
            </div>
            {% if trade.exit_price %}
            <div class="flex items-center gap-2">
                {% if trade.direction.value == 'long' %}
                <span class="w-3 h-3 rounded-full" style="background-color: #ef5350;"></span>
                <span>SELL: ${{ "%.4f"|format(trade.exit_price) }}</span>
                {% else %}
                <span class="w-3 h-3 rounded-full" style="background-color: #26a69a;"></span>
                <span>BUY: ${{ "%.4f"|format(trade.exit_price) }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% if trade.effective_stop_loss %}
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                <span>Stop: ${{ "%.4f"|format(trade.effective_stop_loss) }}</span>
            </div>
            {% endif %}
            <div class="flex items-center gap-2">
                <span class="w-4 h-0.5" style="background-color: #f59e0b;"></span>
                <span>EMA 20</span>
            </div>
            <div class="flex items-center gap-2 ml-auto text-xs text-dark-500">
                <span>Times in {% if trade.market_timezone == 'Asia/Hong_Kong' %}HKT{% elif trade.market_timezone == 'Asia/Shanghai' %}CST{% elif trade.market_timezone == 'Asia/Tokyo' %}JST{% elif trade.market_timezone == 'Europe/London' %}GMT{% else %}EST{% endif %}</span>
            </div>
        </div>
    </div>

    <!-- Trade Details (Full Width) -->
    <div id="details" class="card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                üìä Trade Details
            </h2>
            <button onclick="openEditTradeModal()" class="btn btn-secondary text-sm py-1.5 px-3">
                ‚úèÔ∏è Edit
            </button>
        </div>
        
        <!-- Main Stats Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-5 lg:grid-cols-10 gap-3">
            <!-- Entry -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Entry</div>
                <div class="text-lg font-mono font-bold text-white">${{ "%.2f"|format(trade.entry_price) }}</div>
                {% if trade.entry_time %}
                <div class="text-xs text-dark-500 mt-1">{{ trade.entry_time.strftime('%H:%M') }}</div>
                {% endif %}
            </div>
            <!-- Exit -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Exit</div>
                <div class="text-lg font-mono font-bold text-white">${{ "%.2f"|format(trade.exit_price) if trade.exit_price else '-' }}</div>
                {% if trade.exit_time %}
                <div class="text-xs text-dark-500 mt-1">{{ trade.exit_time.strftime('%H:%M') }}</div>
                {% endif %}
            </div>
            <!-- Stop Loss -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Stop</div>
                <div class="text-lg font-mono font-bold {% if trade.effective_stop_loss %}text-orange-400{% else %}text-dark-600{% endif %}">
                    {% if trade.effective_stop_loss %}${{ "%.2f"|format(trade.effective_stop_loss) }}{% else %}‚Äî{% endif %}
                </div>
            </div>
            <!-- Take Profit -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Target</div>
                <div class="text-lg font-mono font-bold {% if trade.effective_take_profit %}text-blue-400{% else %}text-dark-600{% endif %}">
                    {% if trade.effective_take_profit %}${{ "%.2f"|format(trade.effective_take_profit) }}{% else %}‚Äî{% endif %}
                </div>
            </div>
            <!-- Size -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Size</div>
                <div class="text-lg font-bold text-white">{{ "%.0f"|format(trade.size) if trade.size else '1' }}</div>
            </div>
            <!-- Direction -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Direction</div>
                {% if trade.direction.value == 'long' %}
                <div class="text-lg font-bold text-success-400">LONG</div>
                {% else %}
                <div class="text-lg font-bold text-danger-400">SHORT</div>
                {% endif %}
            </div>
            <!-- Duration -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Duration</div>
                <div class="text-sm font-mono text-white">{{ trade.duration_display }}</div>
            </div>
            <!-- Timeframe -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">TF</div>
                {% set tf = trade.timeframe or '5m' %}
                {% if tf == '5m' %}
                <span class="text-sm font-medium text-purple-400">5m</span>
                {% elif tf == '2h' %}
                <span class="text-sm font-medium text-amber-400">2h</span>
                {% elif tf == '1d' %}
                <span class="text-sm font-medium text-cyan-400">1D</span>
                {% else %}
                <span class="text-sm font-medium text-dark-300">{{ tf }}</span>
                {% endif %}
            </div>
            <!-- Strategy -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Setup</div>
                <div class="text-sm font-medium text-accent-400 truncate" title="{{ trade.strategy.name if trade.strategy else 'Unclassified' }}">
                    {{ (trade.strategy.name if trade.strategy else 'Unclassified')[:12] }}{% if trade.strategy and trade.strategy.name|length > 12 %}...{% endif %}
                </div>
                <button onclick="openStrategyModal()" class="text-xs text-dark-500 hover:text-accent-400">edit</button>
            </div>
            <!-- Result -->
            <div class="bg-dark-800/50 rounded-lg p-3 text-center">
                <div class="text-xs text-dark-500 mb-1">Result</div>
                {% if trade.outcome %}
                    {% if trade.outcome.value == 'win' %}
                    <span class="text-lg font-bold text-success-400">WIN</span>
                    {% elif trade.outcome.value == 'loss' %}
                    <span class="text-lg font-bold text-danger-400">LOSS</span>
                    {% else %}
                    <span class="text-lg font-bold text-dark-400">B/E</span>
                    {% endif %}
                {% else %}
                <span class="text-dark-600">‚Äî</span>
                {% endif %}
            </div>
        </div>

        <!-- MAE/MFE Row (if available) -->
        {% if trade.mae or trade.mfe %}
        <div class="mt-3 pt-3 border-t border-dark-700/50 flex items-center gap-6 text-sm">
            {% if trade.mae %}
            <div class="flex items-center gap-2">
                <span class="text-dark-500">MAE:</span>
                <span class="font-mono text-danger-400">{{ "%.2f"|format(trade.mae) }}R</span>
            </div>
            {% endif %}
            {% if trade.mfe %}
            <div class="flex items-center gap-2">
                <span class="text-dark-500">MFE:</span>
                <span class="font-mono text-success-400">{{ "%.2f"|format(trade.mfe) }}R</span>
            </div>
            {% endif %}
            {% if trade.ai_setup_classification and trade.strategy and trade.ai_setup_classification != trade.strategy.name %}
            <div class="flex items-center gap-2 ml-auto">
                <span class="text-dark-500 text-xs">AI classified:</span>
                <span class="text-xs text-dark-400">{{ trade.ai_setup_classification }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div id="ai-review"></div>
    <!-- AI Coaching Review (Full Width) -->
    <div class="card mb-6" id="review-card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                üß† AI Coaching Review
                <span id="cache-badge" class="badge bg-dark-700 text-dark-400 text-xs hidden">Cached</span>
            </h2>
            <div class="flex items-center gap-3">
                <div id="review-grade" class="flex items-center gap-2 hidden">
                    <span class="text-sm text-dark-400">Grade:</span>
                    <span id="grade-value" class="text-2xl font-bold"></span>
                </div>
            </div>
        </div>
        <div id="review-meta" class="text-xs text-dark-500 mb-3 hidden">
            Generated: <span id="generated-at"></span>
        </div>

        <!-- Initial State - Show Generate Button -->
        <div id="review-initial" class="py-8 text-center">
            <div class="text-4xl mb-3">üß†</div>
            <p class="text-dark-400 text-sm mb-4 max-w-sm mx-auto">
                Get Brooks-style analysis including setup classification, execution review, and coaching advice.
            </p>
            {% if has_materials %}
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/30 text-green-400 text-xs mb-4">
                <span>üìö</span>
                <span>Training materials active</span>
            </div>
            {% endif %}
            <div>
                <button onclick="loadReview(false)" class="btn btn-primary px-6 py-2">
                    ‚ú® Generate Review
                </button>
            </div>
            <p class="text-dark-500 text-xs mt-2">Uses cached review if available</p>
        </div>

            <!-- Loading State with Progress -->
            <div id="review-loading" class="py-8 hidden">
                <div class="loading-spinner w-10 h-10 border-4 border-accent-500 border-t-transparent mx-auto mb-4"></div>
                <p class="text-dark-300 text-center mb-4" id="loading-status">Initializing analysis...</p>
                
                <!-- Progress Steps -->
                <div class="space-y-2 max-w-md mx-auto text-sm">
                    <div id="step-1" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">1</span>
                        <span>Checking cached review...</span>
                    </div>
                    <div id="step-2" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">2</span>
                        <span>Fetching OHLCV data (Daily, 2H, 5min bars)...</span>
                    </div>
                    <div id="step-3" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">3</span>
                        <span>Extracting session context (PDH/PDL/PDC)...</span>
                    </div>
                    <div id="step-4" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">4</span>
                        <span>Loading embedding model...</span>
                    </div>
                    <div id="step-5" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">5</span>
                        <span>Retrieving relevant training materials (RAG)...</span>
                    </div>
                    <div id="step-6" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">6</span>
                        <span>Building Brooks Audit prompt...</span>
                    </div>
                    <div id="step-7" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">7</span>
                        <span>Calling LLM for analysis...</span>
                    </div>
                    <div id="step-8" class="flex items-center gap-2 text-dark-500">
                        <span class="w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs">8</span>
                        <span>Parsing response & caching results...</span>
                    </div>
                </div>
                
                <!-- Cancel Button -->
                <div class="mt-6 text-center">
                    <button onclick="cancelGeneration()" class="btn btn-secondary" id="cancel-btn">
                        ‚úï Cancel Generation
                    </button>
                </div>
            </div>

            <!-- Review Content (hidden until loaded) -->
            <div id="review-content" class="hidden space-y-4">
                <!-- Context -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Market Context</div>
                    <div class="flex flex-wrap gap-2">
                        <span id="review-regime" class="badge badge-primary"></span>
                        <span id="review-always-in" class="badge bg-purple-500/20 text-purple-400 border border-purple-500/30"></span>
                    </div>
                    <p id="review-context-desc" class="text-dark-300 mt-3 text-sm leading-relaxed"></p>
                </div>

                <!-- Setup -->
                <div>
                    <div class="text-sm text-dark-400 mb-2">Setup Classification</div>
                    <span id="review-setup" class="badge"></span>
                </div>

                <!-- What was good -->
                <div id="good-section" class="hidden bg-success-500/10 border border-success-500/30 rounded-xl p-4">
                    <div class="text-sm text-success-400 font-medium mb-2">‚úÖ What Was Good</div>
                    <ul id="good-list" class="space-y-1"></ul>
                </div>

                <!-- What was flawed -->
                <div id="flawed-section" class="hidden bg-danger-500/10 border border-danger-500/30 rounded-xl p-4">
                    <div class="text-sm text-danger-400 font-medium mb-2">‚ö†Ô∏è Areas to Improve</div>
                    <ul id="flawed-list" class="space-y-1"></ul>
                </div>

                <!-- Rules for next time -->
                <div id="rule-section" class="hidden bg-accent-500/10 border border-accent-500/30 rounded-xl p-4">
                    <div class="text-sm text-accent-400 font-medium mb-2">üìå Rules for Next Time</div>
                    <ul id="rule-list" class="space-y-1"></ul>
                </div>

                <!-- Grade explanation -->
                <div id="grade-explanation" class="text-sm text-dark-400 italic mt-4"></div>
                
                <!-- Regenerate button -->
                <div class="mt-6 pt-4 border-t border-dark-700 flex justify-end">
                    <button onclick="refreshReview()" class="btn btn-secondary">
                        üîÑ Regenerate Review
                    </button>
                </div>
            </div>

        <!-- Error State -->
        <div id="review-error" class="hidden text-center py-12">
            <div class="text-4xl mb-3">ü§î</div>
            <p class="text-dark-300 mb-2" id="error-message">Review not available</p>
            <p class="text-sm text-dark-500">Check your LLM connection in Settings</p>
            <a href="/settings" class="btn btn-secondary mt-4">‚öôÔ∏è Check Settings</a>
        </div>
    </div>

    <div id="journal"></div>
    <!-- Trade Plan, Notes & Review (Merged Section) -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                üìã Trade Plan & Review
            </h2>
            <div class="flex items-center gap-3">
                <span class="text-xs text-dark-500">Brooks Audit</span>
                <button onclick="saveNotes()" class="btn btn-primary" id="save-notes-btn">
                    üíæ Save All
                </button>
            </div>
        </div>
        
        <!-- Row 1: Quick Selectors (Trade Type, Confidence, Emotional State, Followed Plan) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="label">Trade Type</label>
                <select id="trade-type-field" class="select">
                    <option value="">Select...</option>
                    <option value="scalp" {% if trade.trade_type == 'scalp' %}selected{% endif %}>Scalp</option>
                    <option value="swing" {% if trade.trade_type == 'swing' %}selected{% endif %}>Swing</option>
                    <option value="position" {% if trade.trade_type == 'position' %}selected{% endif %}>Position</option>
                </select>
            </div>
            <div>
                <label class="label">Confidence (1-5)</label>
                <select id="confidence-field" class="select">
                    <option value="">Select...</option>
                    <option value="1" {% if trade.confidence_level == 1 %}selected{% endif %}>1 - Very Low</option>
                    <option value="2" {% if trade.confidence_level == 2 %}selected{% endif %}>2 - Low</option>
                    <option value="3" {% if trade.confidence_level == 3 %}selected{% endif %}>3 - Medium</option>
                    <option value="4" {% if trade.confidence_level == 4 %}selected{% endif %}>4 - High</option>
                    <option value="5" {% if trade.confidence_level == 5 %}selected{% endif %}>5 - Very High</option>
                </select>
            </div>
            <div>
                <label class="label">Emotional State</label>
                <select id="emotional-state-field" class="select">
                    <option value="">Select...</option>
                    <option value="calm" {% if trade.emotional_state == 'calm' %}selected{% endif %}>üòå Calm</option>
                    <option value="focused" {% if trade.emotional_state == 'focused' %}selected{% endif %}>üéØ Focused</option>
                    <option value="rushed" {% if trade.emotional_state == 'rushed' %}selected{% endif %}>‚ö° Rushed</option>
                    <option value="fomo" {% if trade.emotional_state == 'fomo' %}selected{% endif %}>üò∞ FOMO</option>
                    <option value="revenge" {% if trade.emotional_state == 'revenge' %}selected{% endif %}>üò§ Revenge</option>
                    <option value="tired" {% if trade.emotional_state == 'tired' %}selected{% endif %}>üò¥ Tired</option>
                    <option value="anxious" {% if trade.emotional_state == 'anxious' %}selected{% endif %}>üòü Anxious</option>
                </select>
            </div>
            <div>
                <label class="label">Followed Plan?</label>
                <select id="followed-plan-field" class="select">
                    <option value="">Select...</option>
                    <option value="true" {% if trade.followed_plan == true %}selected{% endif %}>‚úÖ Yes</option>
                    <option value="false" {% if trade.followed_plan == false %}selected{% endif %}>‚ùå No</option>
                </select>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Market Context & Entry Analysis -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üìä Market Context & Entry Analysis
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 1. Trend Assessment -->
            <div class="md:col-span-2">
                <label class="label">1Ô∏è‚É£ My Assessment of Current Trend (Major & Minor)</label>
                <textarea id="trend-assessment-field" rows="2" class="input resize-none" 
                    placeholder="Major trend: Uptrend/Downtrend/Range. Minor trend: Pullback/Rally/Breakout. Where are we in the trend?">{{ trade.trend_assessment or '' }}</textarea>
            </div>
            
            <!-- 2. Entry Setup (Brooks Label) -->
            <div>
                <label class="label">2Ô∏è‚É£ Entry Setup (Brooks Label)</label>
                <textarea id="setup-type-field" rows="2" class="input resize-none" 
                    placeholder="What Brooks setup? (H2 pullback, breakout pullback, failed BO fade, wedge reversal...)">{{ trade.setup_type or '' }}</textarea>
            </div>
            
            <!-- 3. Reason for Entry -->
            <div>
                <label class="label">3Ô∏è‚É£ Reason for Entry</label>
                <textarea id="entry-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why did you take this entry? What convinced you to enter?">{{ trade.entry_reason or '' }}</textarea>
            </div>
            
            <!-- 4. Signal Bar Details -->
            <div>
                <label class="label">4Ô∏è‚É£ Was There a Signal? If Not, Why?</label>
                <textarea id="signal-reason-field" rows="3" class="input resize-none" 
                    placeholder="Was there a signal bar? What type? (Strong bull bar, doji, etc.) If no signal, why did you enter anyway?">{{ trade.signal_reason or trade.was_signal_present or '' }}</textarea>
            </div>
            
            <!-- 5. Strategy Alignment & Invalidation -->
            <div>
                <label class="label">5Ô∏è‚É£ Does this entry align with all the criteria of the chosen strategy? Any invalidation?</label>
                <textarea id="strategy-alignment-field" rows="2" class="input resize-none" 
                    placeholder="Does entry align with all criteria? Any invalidation condition met? What would prove trade wrong?">{{ trade.strategy_alignment or trade.invalidation_condition or '' }}</textarea>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Risk & Targets -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üéØ Risk Management & Targets
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 7. Target Reason -->
            <div>
                <label class="label">6Ô∏è‚É£ Where is my TP, why?</label>
                <textarea id="target-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is TP placed there? (Swing high, range boundary, measured move, magnet?)">{{ trade.target_reason or '' }}</textarea>
            </div>
            
            <!-- 8. Stop Placement Reason -->
            <div>
                <label class="label">7Ô∏è‚É£ Where is my SL, why?</label>
                <textarea id="stop-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why is SL placed there? (Where setup is WRONG, below signal bar, below swing low?)">{{ trade.stop_reason or '' }}</textarea>
            </div>
            
            <!-- 9. Entry-TP Distance -->
            <div>
                <label class="label">8Ô∏è‚É£ Are Entry and TP Too Far Apart?</label>
                <textarea id="entry-tp-distance-field" rows="2" class="input resize-none" 
                    placeholder="Is the R:R realistic? Is the target too ambitious? Would you scale out?">{{ trade.entry_tp_distance or '' }}</textarea>
            </div>
            
            <!-- 10. Reason for Exit -->
            <div>
                <label class="label">9Ô∏è‚É£ Reason for Exit</label>
                <textarea id="exit-reason-field" rows="2" class="input resize-none" 
                    placeholder="Why did you exit? Hit target? Hit stop? Trailed out? Time-based? Fear/greed?">{{ trade.exit_reason or '' }}</textarea>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: Execution & Psychology -->
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üß† Execution & Psychology
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 10. Entry/Exit Emotions -->
            <div class="md:col-span-2">
                <label class="label">üîü Emotions at Entry & Exit (Any Hesitation?)</label>
                <textarea id="entry-exit-emotions-field" rows="2" class="input resize-none" 
                    placeholder="How did you feel entering? Exiting? Any hesitation? Fear? Greed? Rushed?">{{ trade.entry_exit_emotions or '' }}</textarea>
            </div>
            
            <!-- 11. Mistakes Made & Lessons Learned (Merged) -->
            <div class="md:col-span-2">
                <label class="label">‚ì´ Mistakes Made & Lessons Learned (Why did trade succeed/fail?)</label>
                <textarea id="mistakes-lessons-field" rows="4" class="input resize-none" 
                    placeholder="What mistakes were made? Selection error? Execution error? Entered too early/late?&#10;What would you do differently next time? What rule for the next 20 trades?">{{ trade.mistakes_and_lessons or ((trade.mistakes or '') + ('\n\n' if trade.mistakes and trade.lessons else '') + (trade.lessons or '')) }}</textarea>
            </div>
        </div>
        
        <hr class="border-dark-700 mb-6">
        
        <!-- Section: General Notes -->
        <div id="notes"></div>
        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            üìù Trade Notes
        </h3>
        
        <div class="mb-4">
            <!-- 11. Trade Notes -->
            <textarea id="notes-field" rows="4" class="input resize-none w-full" 
                placeholder="General notes about the trade. What happened? Context, market behavior, anything else...">{{ trade.notes or '' }}</textarea>
        </div>
        
        <div id="notes-status" class="text-sm text-dark-500 mt-3 hidden"></div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-3">
        <a href="/trades" class="btn btn-secondary">‚Üê Back to Trades</a>
        <button onclick="deleteTrade({{ trade.id }})" class="btn btn-ghost text-danger-400 hover:bg-danger-500/10">
            üóëÔ∏è Delete Trade
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const TRADE_ID = {{ trade.id }};

// Market timezone for chart display (HK stocks use Asia/Hong_Kong, US stocks use America/New_York)
const MARKET_TIMEZONE = '{{ trade.market_timezone or "America/New_York" }}';
const TIMEZONE_ABBREV = {
    'America/New_York': 'EST',
    'Asia/Hong_Kong': 'HKT',
    'Asia/Shanghai': 'CST',
    'Asia/Tokyo': 'JST',
    'Europe/London': 'GMT',
}[MARKET_TIMEZONE] || MARKET_TIMEZONE.split('/').pop().replace('_', ' ');

// ========== TradingView Chart ==========
let chart = null;
let candlestickSeries = null;
let emaSeries = null;
let candleDataMap = {};  // Store candle data by timestamp for OHLC legend lookup
let barNumberMap = {};   // Store bar numbers by timestamp

// Calculate EMA
function calculateEMA(data, period) {
    const ema = [];
    const multiplier = 2 / (period + 1);
    
    // Need at least 'period' data points
    if (data.length < period) return [];
    
    // Start with SMA for first EMA value
    let sum = 0;
    for (let i = 0; i < period; i++) {
        sum += data[i].close;
    }
    let prevEma = sum / period;
    
    // First EMA point
    ema.push({ time: data[period - 1].time, value: prevEma });
    
    // Calculate remaining EMA values
    for (let i = period; i < data.length; i++) {
        const currentEma = (data[i].close - prevEma) * multiplier + prevEma;
        ema.push({ time: data[i].time, value: Math.round(currentEma * 100) / 100 });
        prevEma = currentEma;
    }
    
    return ema;
}

// Calculate bar numbers (reset each trading day in market timezone)
function calculateBarNumbers(candles, timeframe) {
    const barNumbers = {};
    let currentDay = null;
    let barCount = 0;
    
    candles.forEach(candle => {
        const date = new Date(candle.time * 1000);
        
        // Get day in market timezone (not browser local time)
        const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: MARKET_TIMEZONE,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
        });
        const dayKey = formatter.format(date);
        
        if (dayKey !== currentDay) {
            currentDay = dayKey;
            barCount = 1;  // Reset to 1 for new day
        } else {
            barCount++;
        }
        
        barNumbers[candle.time] = barCount;
    });
    
    return barNumbers;
}

// Track RTH mode (default: true)
let rthMode = true;

function setRthMode(isRth) {
    rthMode = isRth;
    
    // Update button styles
    const btnRth = document.getElementById('btn-rth');
    const btnEth = document.getElementById('btn-eth');
    
    if (isRth) {
        btnRth.classList.add('bg-accent-600', 'text-white');
        btnRth.classList.remove('text-dark-400');
        btnEth.classList.remove('bg-accent-600', 'text-white');
        btnEth.classList.add('text-dark-400');
    } else {
        btnEth.classList.add('bg-accent-600', 'text-white');
        btnEth.classList.remove('text-dark-400');
        btnRth.classList.remove('bg-accent-600', 'text-white');
        btnRth.classList.add('text-dark-400');
    }
    
    loadChartData();
}

async function loadChartData() {
    const timeframe = document.getElementById('chart-timeframe').value;
    const showAfterEntry = document.getElementById('show-after-entry')?.checked || false;
    const chartLoading = document.getElementById('chart-loading');
    const chartContainer = document.getElementById('tradingview-chart');
    
    // Show loading
    chartLoading.classList.remove('hidden');
    
    try {
        const params = new URLSearchParams({
            timeframe: timeframe,
            rth_only: rthMode,
            show_after_entry: showAfterEntry,
        });
        const response = await fetch(`/api/trades/${TRADE_ID}/chart-data?${params}`);
        const data = await response.json();
        
        // Log debug info
        console.log('Chart data response:', data);
        if (data.debug) {
            console.log('Debug info:', data.debug);
        }
        
        if (!data.success) {
            console.error('Chart error:', data.error, data.traceback);
            chartLoading.innerHTML = `<div class="text-dark-400 text-center"><span class="text-3xl block mb-2">üìä</span>${data.error || 'No chart data available'}</div>`;
            return;
        }
        
        // Hide loading
        chartLoading.classList.add('hidden');
        
        // Clear previous chart
        chartContainer.innerHTML = '';
        
        // Detect dark mode
        const isDarkMode = document.documentElement.classList.contains('dark');
        
        // Create chart with TradingView Lightweight Charts
        chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight,
            layout: {
                background: { type: 'solid', color: isDarkMode ? '#0f172a' : '#ffffff' },
                textColor: isDarkMode ? '#94a3b8' : '#64748b',
            },
            grid: {
                vertLines: { color: isDarkMode ? '#1e293b' : '#e2e8f0' },
                horzLines: { color: isDarkMode ? '#1e293b' : '#e2e8f0' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: isDarkMode ? '#334155' : '#cbd5e1',
            },
            timeScale: {
                borderColor: isDarkMode ? '#334155' : '#cbd5e1',
                timeVisible: true,
                secondsVisible: false,
                tickMarkFormatter: (time, tickMarkType, locale) => {
                    // Format tick marks on the time scale in market timezone
                    const date = new Date(time * 1000);
                    
                    const formatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: MARKET_TIMEZONE,
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false,
                    });
                    
                    const parts = formatter.formatToParts(date);
                    const get = (type) => parts.find(p => p.type === type)?.value || '';
                    
                    const timeStr = `${get('hour')}:${get('minute')}`;
                    const dateStr = `${get('month')}/${get('day')}`;
                    
                    // For intraday, show time; for daily, show date
                    if (tickMarkType === LightweightCharts.TickMarkType.Time) {
                        return timeStr;
                    } else if (tickMarkType === LightweightCharts.TickMarkType.DayOfMonth) {
                        return dateStr;
                    } else {
                        return `${dateStr} ${timeStr}`;
                    }
                },
            },
            localization: {
                // Display times in market timezone (for crosshair and tooltips)
                timeFormatter: (timestamp) => {
                    const date = new Date(timestamp * 1000);
                    
                    // Create formatter for market timezone
                    const formatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: MARKET_TIMEZONE,
                        weekday: 'short',
                        month: '2-digit',
                        day: '2-digit',
                        year: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false,
                    });
                    
                    const parts = formatter.formatToParts(date);
                    const get = (type) => parts.find(p => p.type === type)?.value || '';
                    
                    // Format: 'Fri 06/27/25 11:00 HKT' or 'Fri 06/27/25 11:00 EST'
                    return `${get('weekday')} ${get('month')}/${get('day')}/${get('year')} ${get('hour')}:${get('minute')} ${TIMEZONE_ABBREV}`;
                },
            },
        });
        
        // Add candlestick series with custom colors (teal for up, red for down)
        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',       // Teal green for up candles
            downColor: '#ef5350',     // Red for down candles
            borderUpColor: '#26a69a',
            borderDownColor: '#ef5350',
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });
        
        // Set data and build lookup map for OHLC legend
        candlestickSeries.setData(data.candles);
        candleDataMap = {};
        data.candles.forEach(candle => {
            candleDataMap[candle.time] = candle;
        });
        
        // Calculate and store bar numbers
        barNumberMap = calculateBarNumbers(data.candles, timeframe);
        
        // Add 20 EMA line
        const emaData = calculateEMA(data.candles, 20);
        if (emaData.length > 0) {
            emaSeries = chart.addLineSeries({
                color: '#f59e0b',  // Amber/orange color
                lineWidth: 1,
                title: 'EMA 20',
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false,
            });
            emaSeries.setData(emaData);
        }
        
        // Add price lines
        if (data.price_lines) {
            data.price_lines.forEach(line => {
                candlestickSeries.createPriceLine({
                    price: line.price,
                    color: line.color,
                    lineWidth: line.lineWidth,
                    lineStyle: line.lineStyle,
                    axisLabelVisible: true,
                    title: line.title,
                });
            });
        }
        
        // Create bar number markers (every 2 bars for 5m, every 5 for 1m, every 10 for others)
        const barInterval = timeframe === '5m' ? 2 : (timeframe === '1m' ? 5 : 10);
        const barMarkers = [];
        
        data.candles.forEach(candle => {
            const barNum = barNumberMap[candle.time];
            // Show marker at bar 1 (start of day) and every barInterval bars
            if (barNum === 1 || barNum % barInterval === 0) {
                barMarkers.push({
                    time: candle.time,
                    position: 'belowBar',
                    color: '#9ca3af',  // Gray text color
                    shape: 'arrowUp',  // Arrow shape (less obtrusive than square)
                    text: barNum.toString(),
                    size: 0.001,  // Extremely small, practically invisible shape
                });
            }
        });
        
        // Combine trade markers with bar number markers
        // Trade markers need to come first since they're more important
        const allMarkers = [];
        
        if (data.markers && data.markers.length > 0) {
            allMarkers.push(...data.markers);
        }
        
        // Add bar markers (these will show below the trade markers)
        allMarkers.push(...barMarkers);
        
        // Sort markers by time (required by Lightweight Charts)
        allMarkers.sort((a, b) => a.time - b.time);
        
        if (allMarkers.length > 0) {
            candlestickSeries.setMarkers(allMarkers);
        }
        
        // Fit content
        chart.timeScale().fitContent();
        
        // OHLC Legend - Subscribe to crosshair move
        const ohlcLegend = document.getElementById('ohlc-legend');
        const ohlcTime = document.getElementById('ohlc-time');
        const ohlcOpen = document.getElementById('ohlc-open');
        const ohlcHigh = document.getElementById('ohlc-high');
        const ohlcLow = document.getElementById('ohlc-low');
        const ohlcClose = document.getElementById('ohlc-close');
        const ohlcVolume = document.getElementById('ohlc-volume');
        
        chart.subscribeCrosshairMove((param) => {
            if (!param || !param.time || param.point === undefined) {
                ohlcLegend.classList.add('hidden');
                return;
            }
            
            const candleData = param.seriesData.get(candlestickSeries);
            if (!candleData) {
                ohlcLegend.classList.add('hidden');
                return;
            }
            
            // Get full candle data from our map (includes volume)
            const fullCandle = candleDataMap[param.time] || candleData;
            
            // Format time in market timezone
            const date = new Date(param.time * 1000);
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: MARKET_TIMEZONE,
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
            });
            const parts = formatter.formatToParts(date);
            const get = (type) => parts.find(p => p.type === type)?.value || '';
            const timeStr = `${get('month')}/${get('day')} ${get('hour')}:${get('minute')}`;
            
            // Format numbers
            const formatPrice = (price) => price !== undefined ? price.toFixed(2) : '-';
            const formatVolume = (vol) => {
                if (vol === undefined || vol === null) return '-';
                if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
                if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
                return Math.round(vol).toString();
            };
            
            // Get bar number
            const barNum = barNumberMap[param.time] || '-';
            const ohlcBarnum = document.getElementById('ohlc-barnum');
            
            // Update legend
            ohlcTime.textContent = timeStr;
            ohlcOpen.textContent = formatPrice(candleData.open);
            ohlcHigh.textContent = formatPrice(candleData.high);
            ohlcLow.textContent = formatPrice(candleData.low);
            ohlcClose.textContent = formatPrice(candleData.close);
            ohlcVolume.textContent = formatVolume(fullCandle.volume);
            ohlcBarnum.textContent = barNum;
            
            // Color close based on bar direction
            const isUp = candleData.close >= candleData.open;
            ohlcClose.style.color = isUp ? '#26a69a' : '#ef5350';
            
            ohlcLegend.classList.remove('hidden');
        });
        
        // Handle resize
        const resizeObserver = new ResizeObserver(entries => {
            if (chart) {
                const { width, height } = entries[0].contentRect;
                chart.resize(width, height);
            }
        });
        resizeObserver.observe(chartContainer);
        
    } catch (err) {
        console.error('Chart error:', err);
        chartLoading.innerHTML = `<div class="text-dark-400 text-center"><span class="text-3xl block mb-2">‚ö†Ô∏è</span>Failed to load chart: ${err.message}</div>`;
    }
}

// Load chart on page load
document.addEventListener('DOMContentLoaded', () => {
    loadChartData();
});

// ========== AI Review Functions ==========

// Check if there's already a cached review or in-progress generation on page load
document.addEventListener('DOMContentLoaded', () => checkExistingReview());

let pollingInterval = null;
let abortController = null;
let isCancelled = false;

async function checkExistingReview() {
    // Quick check if there's a cached review or in-progress generation
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/review?check_only=true`);
        const data = await response.json();
        
        if (data.in_progress) {
            // There's a generation in progress, show loading and poll
            document.getElementById('review-initial').classList.add('hidden');
            document.getElementById('review-loading').classList.remove('hidden');
            updateStep(7, 'active', 'AI analysis in progress...');
            pollingInterval = setInterval(() => pollForReview(), 1500);  // Poll every 1.5s for faster feedback
        } else if (data.success && data.review) {
            // There's a cached review, display it
            document.getElementById('review-initial').classList.add('hidden');
            displayReview(data.review);
            document.getElementById('cache-badge').classList.remove('hidden');
            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        }
        // Otherwise, show the initial "Generate Review" button (already visible by default)
    } catch (err) {
        console.log('No existing review found');
    }
}

// Track if we should skip data check (user chose to continue anyway)
let skipDataCheck = false;

// Data modal functions
function openDataModal() {
    document.getElementById('data-download-modal').classList.remove('hidden');
}

function closeDataModal() {
    document.getElementById('data-download-modal').classList.add('hidden');
    document.getElementById('data-download-progress').classList.add('hidden');
    document.getElementById('data-download-error').classList.add('hidden');
}

async function checkFuturesData() {
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/check-data`);
        const data = await response.json();
        return data;
    } catch (e) {
        console.error('Error checking data:', e);
        return { success: false, error: e.message };
    }
}

function updateDataStatus(data) {
    const statusDiv = document.getElementById('data-status');
    const downloadBtn = document.getElementById('download-data-btn');
    const continueBtn = document.getElementById('continue-anyway-btn');
    
    if (data.has_data) {
        statusDiv.innerHTML = `
            <div class="flex items-center gap-2 text-green-400">
                <span>‚úÖ</span>
                <span>All required data is available locally</span>
            </div>
        `;
        downloadBtn.classList.add('hidden');
        continueBtn.textContent = 'Continue';
        continueBtn.classList.remove('hidden');
    } else {
        let html = `
            <div class="text-dark-300 mb-2">
                <strong>Ticker:</strong> ${data.ticker} &nbsp;|&nbsp;
                <strong>Trade Date:</strong> ${data.trade_date}
            </div>
            <div class="text-yellow-400 mb-2">Missing data for:</div>
            <ul class="list-disc list-inside text-dark-400 space-y-1">
        `;
        
        for (const schema of data.missing_schemas || []) {
            const details = data.missing_details?.[schema] || {};
            html += `<li><code>${schema}</code>`;
            if (details.have !== undefined) {
                html += ` (have ${details.have} days, need ${details.need})`;
            }
            html += `</li>`;
        }
        
        html += '</ul>';
        statusDiv.innerHTML = html;
        
        downloadBtn.classList.remove('hidden');
        continueBtn.textContent = 'Skip (may fail)';
        continueBtn.classList.remove('hidden');
    }
}

async function downloadFuturesData() {
    const downloadBtn = document.getElementById('download-data-btn');
    const progressDiv = document.getElementById('data-download-progress');
    const errorDiv = document.getElementById('data-download-error');
    const statusText = document.getElementById('download-status-text');
    
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Downloading...';
    progressDiv.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/download-data`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            // Show success and update status
            statusText.textContent = 'Download complete!';
            
            // Re-check data status
            const checkData = await checkFuturesData();
            updateDataStatus(checkData);
            
            progressDiv.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            
            showToast('Data downloaded successfully!', 'success');
        } else {
            throw new Error(data.error || 'Download failed');
        }
    } catch (e) {
        console.error('Download error:', e);
        errorDiv.textContent = e.message;
        errorDiv.classList.remove('hidden');
        progressDiv.classList.add('hidden');
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'üì• Retry Download';
    }
}

function continueWithoutData() {
    skipDataCheck = true;
    closeDataModal();
    loadReview(false);
}

async function loadReview(force = false) {
    // Reset cancel state
    isCancelled = false;
    abortController = new AbortController();
    
    // Check for futures data first (unless skipping or force regenerating cached)
    if (!skipDataCheck && !force) {
        const dataCheck = await checkFuturesData();
        
        if (dataCheck.success && dataCheck.is_futures && !dataCheck.has_data) {
            // Show data download modal
            updateDataStatus(dataCheck);
            openDataModal();
            return;
        }
    }
    
    // Reset skip flag for next time
    skipDataCheck = false;
    
    // Reset and show loading
    resetLoadingSteps();
    document.getElementById('review-initial').classList.add('hidden');
    document.getElementById('review-loading').classList.remove('hidden');
    document.getElementById('review-content').classList.add('hidden');
    document.getElementById('review-error').classList.add('hidden');

    // Quick start toast only if generating new
    if (force) {
        showStartToast('Regenerating AI analysis');
        updateStep(1, 'active', 'Skipping cache (force refresh)...');
    } else {
        showStartToast('Loading review');
        updateStep(1, 'active', 'Checking cached review...');
    }

    try {
        // Simulate progress for better UX (8 steps total)
        setTimeout(() => { if (!isCancelled) updateStep(1, 'done'); }, 300);
        setTimeout(() => { if (!isCancelled) updateStep(2, 'active', 'Fetching OHLCV data (Daily, 2H, 5min bars)...'); }, 500);
        setTimeout(() => { if (!isCancelled) updateStep(2, 'done'); }, 3000);
        setTimeout(() => { if (!isCancelled) updateStep(3, 'active', 'Extracting session context (PDH/PDL/PDC)...'); }, 3200);
        setTimeout(() => { if (!isCancelled) updateStep(3, 'done'); }, 4000);
        setTimeout(() => { if (!isCancelled) updateStep(4, 'active', 'Loading embedding model...'); }, 4200);
        setTimeout(() => { if (!isCancelled) updateStep(4, 'done'); }, 5500);
        setTimeout(() => { if (!isCancelled) updateStep(5, 'active', 'Retrieving relevant training materials (RAG)...'); }, 5700);
        setTimeout(() => { if (!isCancelled) updateStep(5, 'done'); }, 7000);
        setTimeout(() => { if (!isCancelled) updateStep(6, 'active', 'Building Brooks Audit prompt...'); }, 7200);
        setTimeout(() => { if (!isCancelled) updateStep(6, 'done'); }, 8000);
        setTimeout(() => { if (!isCancelled) updateStep(7, 'active', 'Calling LLM for analysis...'); }, 8200);

        const url = force
            ? `/api/trades/${TRADE_ID}/review?force=true`
            : `/api/trades/${TRADE_ID}/review`;
        const response = await fetch(url, { signal: abortController.signal });
        
        if (isCancelled) return;
        
        const data = await response.json();

        // Handle "in progress" status - start polling
        if (data.success && data.in_progress) {
            // Mark early steps done, show LLM step as active
            for (let i = 1; i <= 6; i++) updateStep(i, 'done');
            updateStep(7, 'active', 'AI analysis in progress...');
            showToast('Review generation in progress...', 'info', 5000);
            
            // Start polling every 3 seconds
            if (!pollingInterval) {
                pollingInterval = setInterval(() => pollForReview(), 1500);  // Poll every 1.5s for faster feedback
            }
            return;
        }

        // Clear polling if we got a result
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        document.getElementById('review-loading').classList.add('hidden');

        if (data.success && data.review) {
            // Mark all steps done
            for (let i = 1; i <= 8; i++) updateStep(i, 'done');
            
            displayReview(data.review);

            // Show cache status
            if (data.cached) {
                document.getElementById('cache-badge').classList.remove('hidden');
                showFinishToast('Review loaded', 'From cache (instant)');
            } else {
                document.getElementById('cache-badge').classList.add('hidden');
                const grade = data.review.grade || '?';
                const setup = data.review.setup_classification || 'analyzed';
                showFinishToast('AI analysis complete', `Grade ${grade}, ${setup}`);
            }

            // Show generated time
            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        } else {
            document.getElementById('review-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = data.error || 'Review not available';
            showToast(data.error || 'Review failed', 'error');
        }
    } catch (err) {
        if (err.name === 'AbortError') {
            // User cancelled - show initial state again
            document.getElementById('review-loading').classList.add('hidden');
            document.getElementById('review-initial').classList.remove('hidden');
            showToast('Generation cancelled', 'info');
            return;
        }
        
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        document.getElementById('review-loading').classList.add('hidden');
        document.getElementById('review-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'Failed to load review: ' + err.message;
        showToast('AI analysis failed', 'error');
    }
}

async function cancelGeneration() {
    isCancelled = true;
    
    // Abort ongoing fetch
    if (abortController) {
        abortController.abort();
    }
    
    // Stop polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    
    // Try to cancel on the server side
    try {
        await fetch(`/api/trades/${TRADE_ID}/review/cancel`, { method: 'POST' });
    } catch (err) {
        console.log('Cancel request sent');
    }
    
    // Reset UI to initial state
    document.getElementById('review-loading').classList.add('hidden');
    document.getElementById('review-initial').classList.remove('hidden');
    showToast('Generation cancelled', 'info');
}

let pollCount = 0;
const MAX_POLL_COUNT = 60;  // 60 * 1.5s = 90 seconds max wait

async function pollForReview() {
    pollCount++;
    
    // Timeout after 90 seconds
    if (pollCount > MAX_POLL_COUNT) {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        pollCount = 0;
        document.getElementById('review-loading').classList.add('hidden');
        document.getElementById('review-initial').classList.remove('hidden');
        updateStep(7, 'error', 'Timed out waiting for AI response');
        showToast('Review generation timed out. Please try again.', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/review`);
        const data = await response.json();

        // Still in progress - keep polling with time estimate
        if (data.success && data.in_progress) {
            const elapsed = Math.round(pollCount * 1.5);
            updateStep(7, 'active', `Still generating... (${elapsed}s)`);
            return;
        }

        // Clear polling
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        pollCount = 0;

        document.getElementById('review-loading').classList.add('hidden');

        if (data.success && data.review) {
            // Mark all steps done
            for (let i = 1; i <= 8; i++) updateStep(i, 'done');
            
            displayReview(data.review);
            document.getElementById('cache-badge').classList.add('hidden');
            const grade = data.review.grade || '?';
            const setup = data.review.setup_classification || 'analyzed';
            showFinishToast('AI analysis complete', `Grade ${grade}, ${setup}`);

            if (data.generated_at) {
                document.getElementById('review-meta').classList.remove('hidden');
                const genDate = new Date(data.generated_at);
                document.getElementById('generated-at').textContent = genDate.toLocaleString();
            }
        } else {
            document.getElementById('review-error').classList.remove('hidden');
            document.getElementById('error-message').textContent = data.error || 'Review not available';
        }
    } catch (err) {
        // Keep polling on network errors
        console.error('Polling error:', err);
    }
}

function resetLoadingSteps() {
    for (let i = 1; i <= 8; i++) {
        const step = document.getElementById(`step-${i}`);
        if (step) {
            step.className = 'flex items-center gap-2 text-dark-500';
            step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-dark-600 flex items-center justify-center text-xs';
            step.querySelector('span:first-child').innerHTML = i;
        }
    }
}

function updateStep(num, status, text) {
    const step = document.getElementById(`step-${num}`);
    if (!step) return;
    
    if (status === 'active') {
        step.className = 'flex items-center gap-2 text-accent-400';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full border border-accent-500 bg-accent-500/20 flex items-center justify-center text-xs animate-pulse';
        document.getElementById('loading-status').textContent = text || 'Processing...';
    } else if (status === 'done') {
        step.className = 'flex items-center gap-2 text-success-400';
        step.querySelector('span:first-child').innerHTML = '‚úì';
        step.querySelector('span:first-child').className = 'w-5 h-5 rounded-full bg-success-500/20 border border-success-500 flex items-center justify-center text-xs';
    }
}

function displayReview(review) {
    // Show content
    document.getElementById('review-content').classList.remove('hidden');
    
    // Grade
    if (review.grade) {
        document.getElementById('review-grade').classList.remove('hidden');
        const gradeEl = document.getElementById('grade-value');
        gradeEl.textContent = review.grade;
        
        const gradeColors = {
            'A': 'text-success-400',
            'B': 'text-accent-400', 
            'C': 'text-amber-400',
            'D': 'text-orange-400',
            'F': 'text-danger-400'
        };
        gradeEl.className = 'text-3xl font-bold ' + (gradeColors[review.grade] || 'text-dark-300');
    }
    
    // Context
    document.getElementById('review-regime').textContent = review.regime || 'Unknown';
    document.getElementById('review-always-in').textContent = 'Always-In: ' + (review.always_in || 'Neutral');
    document.getElementById('review-context-desc').textContent = review.context_description || '';
    
    // Setup - use the consistent setup_classification (matches trade's strategy)
    const setupEl = document.getElementById('review-setup');
    let setupText = `${review.setup_classification || 'Unknown'} (${review.setup_quality || 'unknown'})`;
    
    // Show if AI suggested something different
    if (review.ai_setup_classification && 
        review.ai_setup_classification !== review.setup_classification &&
        review.ai_setup_classification.toLowerCase() !== 'insufficient_information') {
        setupText += ` [AI: ${review.ai_setup_classification}]`;
    }
    setupEl.textContent = setupText;
    
    const qualityClasses = {
        'good': 'badge-success',
        'marginal': 'badge-warning',
        'poor': 'bg-danger-500/20 text-danger-400 border border-danger-500/30'
    };
    setupEl.className = 'badge ' + (qualityClasses[review.setup_quality] || 'bg-dark-600');
    
    // What was good
    if (review.what_was_good && review.what_was_good.length > 0) {
        document.getElementById('good-section').classList.remove('hidden');
        const goodList = document.getElementById('good-list');
        goodList.innerHTML = review.what_was_good
            .map(item => `<li class="text-success-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // What was flawed
    if (review.what_was_flawed && review.what_was_flawed.length > 0) {
        document.getElementById('flawed-section').classList.remove('hidden');
        const flawedList = document.getElementById('flawed-list');
        flawedList.innerHTML = review.what_was_flawed
            .map(item => `<li class="text-danger-300 text-sm">‚Ä¢ ${item}</li>`)
            .join('');
    }
    
    // Rules - handle both array (new) and string (old cached) formats
    if (review.rule_for_next_time) {
        let rules = review.rule_for_next_time;
        // Convert string to array if needed (old cached format)
        if (typeof rules === 'string') {
            rules = rules ? [rules] : [];
        }
        if (rules.length > 0) {
            document.getElementById('rule-section').classList.remove('hidden');
            const ruleList = document.getElementById('rule-list');
            ruleList.innerHTML = rules
                .map(item => `<li class="text-accent-200 text-sm">‚Ä¢ ${item}</li>`)
                .join('');
        }
    }
    
    // Grade explanation
    if (review.grade_explanation) {
        document.getElementById('grade-explanation').textContent = review.grade_explanation;
    }
}

async function saveNotes() {
    const btn = document.getElementById('save-notes-btn');
    const status = document.getElementById('notes-status');

    btn.disabled = true;
    btn.textContent = '‚è≥ Saving...';

    // Collect all fields including Brooks intent fields
    const followedPlanVal = document.getElementById('followed-plan-field').value;

    const data = {
        // Basic notes
        notes: document.getElementById('notes-field').value,
        setup_type: document.getElementById('setup-type-field').value,
        entry_reason: document.getElementById('entry-reason-field').value,
        signal_reason: document.getElementById('signal-reason-field').value,
        mistakes_and_lessons: document.getElementById('mistakes-lessons-field').value,
        // Quick selectors
        trade_type: document.getElementById('trade-type-field').value || null,
        confidence_level: document.getElementById('confidence-field').value ? parseInt(document.getElementById('confidence-field').value) : null,
        emotional_state: document.getElementById('emotional-state-field').value || null,
        followed_plan: followedPlanVal === 'true' ? true : (followedPlanVal === 'false' ? false : null),
        // Risk & Targets
        stop_reason: document.getElementById('stop-reason-field').value || null,
        target_reason: document.getElementById('target-reason-field').value || null,
        exit_reason: document.getElementById('exit-reason-field').value || null,
        // Extended Brooks analysis fields
        trend_assessment: document.getElementById('trend-assessment-field').value || null,
        signal_reason: document.getElementById('signal-reason-field').value || null,
        strategy_alignment: document.getElementById('strategy-alignment-field').value || null,
        entry_exit_emotions: document.getElementById('entry-exit-emotions-field').value || null,
        entry_tp_distance: document.getElementById('entry-tp-distance-field').value || null,
    };

    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/notes`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast('Trade details saved!');
            status.textContent = '‚úì Saved just now';
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        } else {
            showToast('Failed to save', 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'üíæ Save All';
}

async function deleteTrade(id) {
    if (!confirm('Delete this trade?')) return;
    
    showStartToast('Deleting trade');
    const response = await fetch(`/api/trades/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
        showFinishToast('Trade deleted');
        setTimeout(() => window.location.href = '/trades', 800);
    } else {
        showToast('Failed to delete trade', 'error');
    }
}

function refreshReview() {
    document.getElementById('review-initial').classList.add('hidden');
    document.getElementById('review-loading').classList.remove('hidden');
    document.getElementById('review-content').classList.add('hidden');
    document.getElementById('review-error').classList.add('hidden');
    document.getElementById('review-grade').classList.add('hidden');
    document.getElementById('cache-badge').classList.add('hidden');
    document.getElementById('review-meta').classList.add('hidden');
    loadReview(true);  // Force regenerate
}

// Strategy editing
function openStrategyModal() {
    document.getElementById('strategy-modal').classList.remove('hidden');
}

function closeStrategyModal() {
    document.getElementById('strategy-modal').classList.add('hidden');
}

async function saveTradeStrategy() {
    const strategyName = document.getElementById('strategy-input').value.trim();
    if (!strategyName) {
        showToast('Enter a strategy name', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/trades/${TRADE_ID}/strategy`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ strategy_name: strategyName })
        });
        const data = await response.json();
        showToast(data.message, 'success');
        closeStrategyModal();
        setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
        showToast('Failed to update strategy', 'error');
    }
}

// Edit Trade Details
const currentTradeDate = '{{ trade.exit_time.strftime("%Y-%m-%d") if trade.exit_time else trade.entry_time.strftime("%Y-%m-%d") if trade.entry_time else "" }}';

function openEditTradeModal() {
    document.getElementById('edit-trade-modal').classList.remove('hidden');
}

function closeEditTradeModal() {
    document.getElementById('edit-trade-modal').classList.add('hidden');
}

async function fetchHistoricalRate() {
    const currency = document.getElementById('edit-currency').value;
    if (currency === 'USD') {
        document.getElementById('edit-rate').value = 1.0;
        return;
    }
    
    const date = currentTradeDate || new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/api/exchange-rate?currency=${currency}&date=${date}`);
        const data = await response.json();
        
        if (data.rate) {
            document.getElementById('edit-rate').value = data.rate;
            showToast(`Rate fetched: 1 USD = ${data.rate} ${currency}`, 'success');
        } else {
            showToast('Could not fetch rate', 'error');
        }
    } catch (err) {
        showToast('Error fetching rate', 'error');
    }
}

// Form submission handler and event listeners - wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Auto-fetch rate when currency changes
    const currencySelect = document.getElementById('edit-currency');
    if (currencySelect) {
        currencySelect.addEventListener('change', fetchHistoricalRate);
    }
    
    // Form submission
    const editForm = document.getElementById('edit-trade-form');
    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const slValue = document.getElementById('edit-stop-loss').value;
            const tpValue = document.getElementById('edit-take-profit').value;
            
            const payload = {
                ticker: document.getElementById('edit-ticker').value.toUpperCase(),
                direction: document.getElementById('edit-direction').value,
                size: parseFloat(document.getElementById('edit-size').value),
                entry_price: parseFloat(document.getElementById('edit-entry-price').value),
                exit_price: parseFloat(document.getElementById('edit-exit-price').value),
                stop_loss: slValue ? parseFloat(slValue) : null,
                take_profit: tpValue ? parseFloat(tpValue) : null,
                currency: document.getElementById('edit-currency').value,
                currency_rate: parseFloat(document.getElementById('edit-rate').value),
                entry_time: document.getElementById('edit-entry-time').value || null,
                exit_time: document.getElementById('edit-exit-time').value || null,
                timeframe: document.getElementById('edit-timeframe').value,
            };

            try {
                const response = await fetch(`/api/trades/${TRADE_ID}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('Trade updated!', 'success');
                    closeEditTradeModal();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const err = await response.json();
                    showToast('Error: ' + (err.detail || 'Failed to update'), 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
    }
});
</script>

<!-- Edit Trade Details Modal -->
<div id="edit-trade-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="card w-full max-w-lg animate-fadeIn my-8">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white">Edit Trade #{{ trade.trade_number or trade.id }}</h3>
                <p class="text-sm text-dark-400">{{ trade.exit_time.strftime('%Y-%m-%d') if trade.exit_time else trade.entry_time.strftime('%Y-%m-%d') if trade.entry_time else '' }}</p>
            </div>
            <button onclick="closeEditTradeModal()" class="btn btn-ghost text-2xl p-2">&times;</button>
        </div>

        <form id="edit-trade-form" class="space-y-4">
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Ticker</label>
                    <input type="text" id="edit-ticker" class="input text-sm uppercase"
                           value="{{ trade.ticker }}" placeholder="SPY">
                </div>
                <div>
                    <label class="label">Direction</label>
                    <select id="edit-direction" class="select">
                        <option value="long" {% if trade.direction and trade.direction.value == 'long' %}selected{% endif %}>LONG</option>
                        <option value="short" {% if trade.direction and trade.direction.value == 'short' %}selected{% endif %}>SHORT</option>
                    </select>
                </div>
                <div>
                    <label class="label">Shares</label>
                    <input type="number" id="edit-size" step="1" min="1" class="input"
                           value="{{ trade.size or 1 }}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Time</label>
                    <input type="datetime-local" id="edit-entry-time" step="1" class="input text-sm"
                           value="{{ trade.entry_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.entry_time else '' }}">
                </div>
                <div>
                    <label class="label">Exit Time</label>
                    <input type="datetime-local" id="edit-exit-time" step="1" class="input text-sm"
                           value="{{ trade.exit_time.strftime('%Y-%m-%dT%H:%M:%S') if trade.exit_time else '' }}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">Entry Price</label>
                    <input type="number" id="edit-entry-price" step="0.0001" min="0" class="input"
                           value="{{ trade.entry_price }}">
                </div>
                <div>
                    <label class="label">Exit Price</label>
                    <input type="number" id="edit-exit-price" step="0.0001" min="0" class="input"
                           value="{{ trade.exit_price or '' }}">
                </div>
                <div>
                    <label class="label">Stop Loss (SL)</label>
                    <input type="number" id="edit-stop-loss" step="0.0001" min="0" class="input" placeholder="Where trade is wrong"
                           value="{{ trade.stop_loss or '' }}">
                </div>
                <div>
                    <label class="label">Take Profit (TP)</label>
                    <input type="number" id="edit-take-profit" step="0.0001" min="0" class="input" placeholder="Target exit"
                           value="{{ trade.take_profit or '' }}">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="label">Timeframe</label>
                    <select id="edit-timeframe" class="select">
                        <option value="5m" {% if trade.timeframe == '5m' or not trade.timeframe %}selected{% endif %}>5 min (Scalp)</option>
                        <option value="2h" {% if trade.timeframe == '2h' %}selected{% endif %}>2 hour (Swing)</option>
                        <option value="1d" {% if trade.timeframe == '1d' %}selected{% endif %}>Daily (Position)</option>
                    </select>
                    <p class="text-xs text-dark-500 mt-1">Used for AI context data</p>
                </div>
                <div>
                    <label class="label">Currency</label>
                    <select id="edit-currency" class="select">
                        <option value="USD" {% if trade.currency == 'USD' or not trade.currency %}selected{% endif %}>USD ($)</option>
                        <option value="HKD" {% if trade.currency == 'HKD' %}selected{% endif %}>HKD (HK$)</option>
                        <option value="EUR" {% if trade.currency == 'EUR' %}selected{% endif %}>EUR (‚Ç¨)</option>
                        <option value="GBP" {% if trade.currency == 'GBP' %}selected{% endif %}>GBP (¬£)</option>
                        <option value="JPY" {% if trade.currency == 'JPY' %}selected{% endif %}>JPY (¬•)</option>
                        <option value="CNY" {% if trade.currency == 'CNY' %}selected{% endif %}>CNY (¬•)</option>
                        <option value="CAD" {% if trade.currency == 'CAD' %}selected{% endif %}>CAD (C$)</option>
                        <option value="AUD" {% if trade.currency == 'AUD' %}selected{% endif %}>AUD (A$)</option>
                    </select>
                </div>
                <div>
                    <label class="label">Rate to USD</label>
                    <div class="flex space-x-2">
                        <input type="number" id="edit-rate" step="0.0001" min="0" class="input flex-1"
                               value="{{ trade.currency_rate or 1.0 }}">
                        <button type="button" onclick="fetchHistoricalRate()" class="btn btn-secondary">üîÑ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-dark-700">
                <button type="button" onclick="closeEditTradeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Data Download Modal (for Futures) -->
<div id="data-download-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-800 rounded-2xl p-6 max-w-lg w-full mx-4 border border-dark-600">
        <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">üìä</span>
            <h3 class="text-xl font-bold text-white">Futures Data Required</h3>
        </div>
        
        <p class="text-dark-300 mb-4">
            This is a futures trade. To generate an AI review, we need OHLCV data from Databento.
        </p>
        
        <div id="data-status" class="bg-dark-900 rounded-lg p-4 mb-4 text-sm">
            <div class="text-dark-400 mb-2">Checking data availability...</div>
        </div>
        
        <div id="data-download-progress" class="hidden mb-4">
            <div class="flex items-center gap-2 text-accent-400">
                <div class="loading-spinner w-5 h-5 border-2 border-accent-500 border-t-transparent"></div>
                <span id="download-status-text">Downloading data...</span>
            </div>
        </div>
        
        <div id="data-download-error" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
        </div>
        
        <div class="flex justify-end gap-3">
            <button onclick="closeDataModal()" class="btn btn-secondary">Cancel</button>
            <button id="download-data-btn" onclick="downloadFuturesData()" class="btn btn-primary">
                üì• Download Data
            </button>
            <button id="continue-anyway-btn" onclick="continueWithoutData()" class="btn btn-secondary hidden">
                Continue Anyway
            </button>
        </div>
        
        <p class="text-dark-500 text-xs mt-4">
            Data is stored locally in <code>data/databento/</code> and reused for future trades.
        </p>
    </div>
</div>

<!-- Strategy Edit Modal -->
<div id="strategy-modal" class="fixed inset-0 bg-dark-950/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-800 rounded-2xl p-6 max-w-md w-full mx-4 border border-dark-600">
        <h3 class="text-xl font-bold text-white mb-4">Edit Strategy</h3>
        <div class="space-y-4">
            <div>
                <label class="label">Strategy Name</label>
                <input type="text" id="strategy-input" class="input" 
                       value="{{ trade.strategy.name if trade.strategy else '' }}"
                       placeholder="e.g., H2_Pullback_Long">
            </div>
            {% if trade.ai_setup_classification %}
            <div class="text-sm text-dark-400">
                <span class="text-dark-500">Original AI classification:</span> 
                <span class="text-accent-400">{{ trade.ai_setup_classification }}</span>
                <button type="button" onclick="document.getElementById('strategy-input').value='{{ trade.ai_setup_classification }}'" 
                        class="text-xs text-dark-400 hover:text-accent-400 ml-2">‚Üê Use this</button>
            </div>
            {% endif %}
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeStrategyModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveTradeStrategy()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}
